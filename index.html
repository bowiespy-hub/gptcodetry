<!DOCTYPE html>
<html lang="zh-Hant" class="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>ATE - Aether Trinity Evolution</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@200..700&display=swap" rel="stylesheet"/>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            ink: "#05060A",
            obsidian: "#0B0D14",
            surface: "#0F1424",
            panel: "#121A2E",
            stroke: "rgba(255,255,255,0.10)",
            stroke2: "rgba(255,255,255,0.14)",
            gold: "#D4AF37",
            gold2: "#F4E09A",
            violet: "#8B5CF6",
            violet2: "#A78BFA",
            cyan: "#22D3EE",
            rose: "#FB7185",
            lime: "#A3E635",
          },
          fontFamily: {
            display: ["Manrope", "Noto Sans TC", "sans-serif"],
            body: ["Noto Sans TC", "Manrope", "sans-serif"],
          },
          boxShadow: {
            glass: "0 18px 60px rgba(0,0,0,0.35)",
            glow: "0 0 24px rgba(139,92,246,0.22)",
            gold: "0 0 24px rgba(212,175,55,0.20)",
          }
        }
      }
    }
  </script>

  <style>
    :root { color-scheme: dark; }
    body {
      min-height: 100dvh;
      background: #05060A;
      -webkit-tap-highlight-color: transparent;
      overflow-x: hidden;
      font-family: Manrope, "Noto Sans TC", sans-serif;
    }
    .ms { font-family: 'Material Symbols Outlined'; font-variation-settings: 'FILL' 0,'wght' 420,'GRAD' 0,'opsz' 24; }
    .ms.fill { font-variation-settings: 'FILL' 1,'wght' 520,'GRAD' 0,'opsz' 24; }

    .glass {
      background: rgba(18, 26, 46, 0.62);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .glass2 {
      background: linear-gradient(145deg, rgba(255,255,255,0.07) 0%, rgba(255,255,255,0.02) 100%);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border: 1px solid rgba(255,255,255,0.10);
    }

    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    .fade-in { animation: fadeIn .22s ease-out; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(6px);} to {opacity:1; transform: translateY(0);} }

    .pulse-ring { animation: pulseRing 1.7s infinite; }
    @keyframes pulseRing {
      0% { box-shadow: 0 0 0 0 rgba(139,92,246,0.35); }
      70% { box-shadow: 0 0 0 14px rgba(139,92,246,0); }
      100% { box-shadow: 0 0 0 0 rgba(139,92,246,0); }
    }

    .toast { animation: toastIn .25s ease-out; }
    @keyframes toastIn {
      from { opacity:0; transform: translateY(10px); }
      to { opacity:1; transform: translateY(0); }
    }

    .shimmer::before{
      content:"";
      position:absolute; inset:-40% -60%;
      background: linear-gradient(110deg, transparent 35%, rgba(255,255,255,0.10) 50%, transparent 65%);
      transform: translateX(-40%);
      animation: shimmer 2.4s infinite;
      pointer-events:none;
    }
    @keyframes shimmer { to { transform: translateX(40%);} }

    .chip {
      display:inline-flex; align-items:center; gap:.35rem;
      padding:.25rem .55rem; border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      font-size: 11px;
      font-weight: 700;
      color: rgba(226,232,240,0.95);
      letter-spacing: .08em;
      text-transform: uppercase;
      user-select:none;
      white-space: nowrap;
    }
    .chip .ms { font-size: 16px; }
  </style>
</head>

<body class="bg-ink text-slate-100 selection:bg-violet selection:text-white">
  <!-- Ambient Background -->
  <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
    <div class="absolute -top-[18%] left-[15%] w-[95%] h-[55%] bg-violet/18 rounded-full blur-[130px]"></div>
    <div class="absolute -bottom-[18%] right-[-12%] w-[70%] h-[45%] bg-cyan/10 rounded-full blur-[120px]"></div>
    <div class="absolute inset-0 opacity-[0.045]" style="background-image:url('data:image/svg+xml,%3Csvg viewBox=%220 0 240 240%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cfilter id=%22n%22%3E%3CfeTurbulence type=%22fractalNoise%22 baseFrequency=%220.75%22 numOctaves=%223%22 stitchTiles=%22stitch%22/%3E%3C/filter%3E%3Crect width=%22100%25%22 height=%22100%25%22 filter=%22url(%23n)%22/%3E%3C/svg%3E');"></div>
  </div>

  <!-- App Frame -->
  <div class="relative z-10 mx-auto w-full max-w-md min-h-[100dvh] flex flex-col pb-24">
    <!-- HUB -->
    <section id="view-hub" class="flex flex-col flex-1 fade-in">
      <header class="pt-12 px-6 pb-4">
        <!-- Profile Card -->
        <div class="glass rounded-3xl overflow-hidden shadow-glass">
          <div class="relative">
            <div class="h-24 w-full"
                 style="background:
                   radial-gradient(120% 160% at 12% 10%, rgba(212,175,55,0.28) 0%, rgba(212,175,55,0) 56%),
                   radial-gradient(120% 160% at 90% 35%, rgba(139,92,246,0.34) 0%, rgba(139,92,246,0) 55%),
                   linear-gradient(135deg, rgba(255,255,255,0.04) 0%, rgba(255,255,255,0.02) 100%);">
            </div>

            <!-- ✅ FIX: profile area no longer absolute-float; use stable grid layout -->
            <div class="px-5 pt-4 pb-5">
              <div class="grid grid-cols-[72px_1fr_auto] gap-3 items-center">
                <button id="btn-profile" class="relative" title="打開個人設定">
                  <div class="h-16 w-16 rounded-full overflow-hidden border border-white/15 bg-surface shadow-glass">
                    <img id="profile-avatar" alt="avatar" class="h-full w-full object-cover" />
                  </div>
                  <div class="absolute -right-1 -bottom-1 glass2 rounded-full px-2 py-1 border border-white/10 shadow-glass">
                    <div class="flex items-center gap-1">
                      <span class="ms fill text-gold text-[16px]">workspace_premium</span>
                      <span id="profile-level-mini" class="text-[10px] text-slate-200 font-bold tracking-wide">LV 1</span>
                    </div>
                  </div>
                </button>

                <div class="min-w-0">
                  <div class="flex items-center gap-2 min-w-0">
                    <h1 id="profile-name" class="text-xl font-extrabold tracking-tight text-white leading-none truncate">覺醒女神</h1>
                    <span id="profile-badge" class="hidden text-[10px] px-2 py-1 rounded-full border border-gold/30 bg-gold/10 text-gold font-bold tracking-widest">ELITE</span>
                  </div>
                  <p id="profile-title" class="text-[11px] text-slate-400 font-medium tracking-wide mt-1 truncate">Aether Trinity Evolution</p>

                  <!-- ✅ NEW: show score on profile -->
                  <div class="mt-3 flex flex-wrap gap-2">
                    <span class="chip"><span class="ms fill text-violet2">percent</span><span id="profile-completion">0%</span></span>
                    <span class="chip"><span class="ms fill text-gold">bolt</span><span id="profile-xp-est">+0 XP</span></span>
                    <span class="chip"><span class="ms fill text-rose">local_fire_department</span><span id="profile-streak">0 Days</span></span>
                  </div>
                </div>

                <div class="flex flex-col items-end gap-2">
                  <button id="btn-reset" class="glass2 rounded-full px-3 py-2 border border-white/10 text-slate-200/90 hover:text-white active:scale-95 transition-transform"
                          title="系統重置">
                    <span class="ms text-[18px]">restart_alt</span>
                  </button>

                  <!-- ✅ NEW: settled status -->
                  <div id="profile-settled" class="text-[10px] text-slate-400 font-semibold">
                    未結算
                  </div>
                </div>
              </div>

              <!-- XP bar -->
              <div class="mt-4">
                <div class="flex items-center justify-between text-[11px] text-slate-300 font-medium">
                  <span class="tracking-widest uppercase text-slate-400">Current XP</span>
                  <span class="text-violet2 font-bold"><span id="hub-xp">0</span> / <span id="hub-xpmax">100</span></span>
                </div>
                <div class="mt-2 h-3 w-full rounded-full bg-white/5 border border-white/10 overflow-hidden">
                  <div id="hub-xpbar" class="h-full w-[0%] bg-gradient-to-r from-violet via-violet2 to-cyan shadow-glow rounded-full transition-all duration-500"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Daily Verse (EN) -->
        <div class="mt-5 glass2 rounded-3xl p-5 border border-white/10 shadow-glass relative overflow-hidden">
          <div class="absolute -top-10 -right-10 w-40 h-40 bg-gold/10 rounded-full blur-3xl"></div>
          <div class="flex items-center justify-between mb-2">
            <div class="text-[11px] tracking-[0.22em] uppercase text-slate-400 font-semibold">DAILY VERSE</div>
            <div class="text-[10px] text-gold font-bold tracking-widest">EN</div>
          </div>
          <div id="daily-verse" class="text-[15px] leading-relaxed text-white font-semibold"></div>
          <div id="daily-verse-ref" class="mt-2 text-[11px] text-slate-400 font-medium"></div>
        </div>
      </header>

      <main class="px-6 pb-6 flex-1 space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="text-base font-extrabold tracking-wide text-white">今日進化概覽</h2>
          <div class="flex items-center gap-2">
            <div class="glass2 px-3 py-1.5 rounded-full border border-white/10 text-[11px] text-slate-200 font-semibold">
              <span id="hub-date">Today</span>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 gap-4">
          <!-- Body -->
          <button onclick="navTo('body')" class="glass2 rounded-3xl p-5 border border-white/10 shadow-glass text-left active:scale-[0.99] transition-transform relative overflow-hidden">
            <div class="absolute -top-12 -right-12 w-48 h-48 bg-rose/10 rounded-full blur-3xl"></div>
            <div class="flex items-start justify-between">
              <div>
                <div class="text-[11px] tracking-widest uppercase text-slate-400 font-semibold">BODY</div>
                <div class="mt-1 text-lg font-extrabold text-white">身體進化</div>
                <div class="mt-2 text-[12px] text-slate-400 font-medium">水分 / 計時任務 / 排便</div>
              </div>
              <div class="text-right">
                <div class="text-2xl font-extrabold text-white"><span id="hub-body-score">0</span>%</div>
                <div class="text-[11px] text-slate-400 font-semibold">今日完成</div>
              </div>
            </div>
            <div class="mt-4 h-2 w-full rounded-full bg-white/5 border border-white/10 overflow-hidden">
              <div id="hub-body-bar" class="h-full w-[0%] bg-gradient-to-r from-rose via-violet2 to-cyan rounded-full transition-all duration-500"></div>
            </div>
          </button>

          <div class="grid grid-cols-2 gap-4">
            <button onclick="navTo('mind')" class="glass2 rounded-3xl p-5 border border-white/10 shadow-glass text-left active:scale-[0.99] transition-transform relative overflow-hidden">
              <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-violet/10 rounded-full blur-3xl"></div>
              <div class="text-[11px] tracking-widest uppercase text-slate-400 font-semibold">MIND & SPIRIT</div>
              <div class="mt-1 text-lg font-extrabold text-white">心智 / 靈修</div>
              <div class="mt-2 text-[12px] text-slate-400 font-medium">閱讀 / 反思 / 經文</div>
            </button>

            <button onclick="navTo('calendar')" class="glass2 rounded-3xl p-5 border border-white/10 shadow-glass text-left active:scale-[0.99] transition-transform relative overflow-hidden">
              <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-gold/10 rounded-full blur-3xl"></div>
              <div class="text-[11px] tracking-widest uppercase text-slate-400 font-semibold">HISTORY</div>
              <div class="mt-1 text-lg font-extrabold text-white">進化日曆</div>
              <div class="mt-2 text-[12px] text-slate-400 font-medium">補填 / 查看全部紀錄</div>
            </button>
          </div>
        </div>

        <!-- Settle -->
        <button id="btn-settle" class="relative w-full rounded-2xl overflow-hidden shadow-glow border border-violet/25 active:scale-[0.99] transition-transform">
          <div class="absolute inset-0 bg-gradient-to-r from-violet/40 via-violet2/25 to-cyan/25"></div>
          <div class="absolute inset-0 opacity-30 shimmer"></div>
          <div class="relative px-5 py-4 flex items-center justify-between">
            <div>
              <div class="text-sm font-extrabold text-white">結算今天</div>
              <div class="text-[12px] text-slate-300 font-medium mt-0.5">可重算（會自動補回/倒扣差額）</div>
            </div>
            <div class="flex items-center gap-2">
              <div class="text-right">
                <div class="text-xs text-slate-300 font-semibold">預估</div>
                <div class="text-lg font-extrabold text-gold">+<span id="hub-xp-est">0</span> XP</div>
              </div>
              <span class="ms fill text-white text-[20px]">auto_awesome</span>
            </div>
          </div>
        </button>

      </main>
    </section>

    <!-- BODY VIEW -->
    <section id="view-body" class="hidden flex-col flex-1 fade-in">
      <header class="pt-10 px-4">
        <div class="flex items-center justify-between">
          <button onclick="navTo('hub')" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
            <span class="ms text-[18px]">chevron_left</span>
          </button>
          <div class="text-center">
            <div class="text-[11px] tracking-[0.22em] uppercase text-slate-400 font-semibold">AETHER TRINITY EVOLUTION</div>
            <div class="mt-1 text-2xl font-extrabold text-white">身體進化</div>
          </div>
          <button onclick="goToday()" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
            <span class="ms text-[18px]">today</span>
          </button>
        </div>

        <div class="mt-4 flex items-center justify-between">
          <div class="glass2 px-3 py-1.5 rounded-full border border-white/10 text-[11px] text-slate-200 font-semibold">
            <span id="body-date">Today</span>
          </div>
          <div class="glass2 px-3 py-1.5 rounded-full border border-white/10 text-[11px] text-slate-200 font-semibold">
            完成度 <span class="ml-2 text-white font-extrabold"><span id="body-completion">0</span>%</span>
          </div>
        </div>
      </header>

      <main class="px-4 pt-5 pb-6 flex-1 overflow-y-auto no-scrollbar space-y-5">
        <!-- Water -->
        <section class="glass rounded-3xl p-5 shadow-glass border border-white/10 relative overflow-hidden">
          <div class="absolute -top-10 -right-10 w-44 h-44 bg-cyan/10 rounded-full blur-3xl"></div>
          <div class="flex items-start justify-between">
            <div>
              <div class="text-[11px] tracking-widest uppercase text-slate-400 font-semibold">HYDRATION</div>
              <div class="mt-1 text-lg font-extrabold text-white">水分攝入</div>
              <div class="mt-2 text-[12px] text-slate-400 font-medium">
                目標：<span id="water-goal">1900</span> ml
                <span class="ml-2 text-slate-500">（+250 / +500 會加分；-250 會扣回）</span>
              </div>
              <div class="mt-2 text-[11px] text-slate-400 font-semibold" id="water-points-hint">此區滿分：+25 分</div>
            </div>
            <div class="text-right">
              <div class="text-3xl font-extrabold text-white"><span id="water-val">0</span></div>
              <div class="text-[12px] text-slate-400 font-semibold">ml</div>
            </div>
          </div>

          <div class="mt-4 h-3 w-full rounded-full bg-white/5 border border-white/10 overflow-hidden">
            <div id="water-bar" class="h-full w-[0%] bg-gradient-to-r from-cyan via-violet2 to-gold rounded-full transition-all duration-500"></div>
          </div>

          <div class="mt-4 grid grid-cols-3 gap-2">
            <button onclick="modifyWater(-250)" class="glass2 border border-white/10 rounded-2xl py-3 font-bold text-slate-200 active:scale-95 transition-transform">
              -250 <span class="text-[11px] text-slate-400 ml-1">(-?)</span>
            </button>
            <button onclick="modifyWater(250)" class="glass2 border border-white/10 rounded-2xl py-3 font-bold text-white active:scale-95 transition-transform">
              +250 <span class="text-[11px] text-slate-400 ml-1">(+?)</span>
            </button>
            <button onclick="modifyWater(500)" class="relative overflow-hidden rounded-2xl py-3 font-extrabold text-ink bg-gradient-to-r from-gold via-gold2 to-gold shadow-gold active:scale-95 transition-transform">
              +500 <span class="text-[11px] text-ink/70 ml-1">(+?)</span>
            </button>
          </div>
          <div class="mt-2 text-[11px] text-slate-500 font-semibold">
            提示：分數是「即時計算」，不是每次點擊固定加。水分會依達標比例自動加分/扣回。
          </div>
        </section>

        <!-- Tasks -->
        <section class="space-y-3">
          <div class="flex items-center justify-between px-1">
            <div class="text-lg font-extrabold text-white">今日任務</div>
            <div class="text-[11px] text-slate-400 font-semibold">每個動作都會顯示本動作 +/- 分數（可完成/取消）</div>
          </div>
          <div id="task-list" class="space-y-3"></div>
        </section>

        <!-- Bowel -->
        <section class="glass rounded-3xl p-5 shadow-glass border border-white/10">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-[11px] tracking-widest uppercase text-slate-400 font-semibold">HEALTH</div>
              <div class="mt-1 text-lg font-extrabold text-white">排便狀況</div>
              <div class="mt-2 text-[11px] text-slate-400 font-semibold">本項分數：<span id="bowel-points">+10 / 0</span></div>
            </div>

            <div class="flex items-center gap-2">
              <button onclick="setBowel('未完成')" id="bowel-a" class="glass2 border border-white/10 rounded-full px-3 py-2 text-[12px] font-bold text-slate-200 active:scale-95 transition-transform">未完成</button>
              <button onclick="setBowel('正常')" id="bowel-b" class="glass2 border border-white/10 rounded-full px-3 py-2 text-[12px] font-bold text-slate-200 active:scale-95 transition-transform">正常</button>
            </div>
          </div>
        </section>
      </main>
    </section>

    <!-- MIND VIEW -->
    <section id="view-mind" class="hidden flex-col flex-1 fade-in">
      <header class="pt-10 px-4">
        <div class="flex items-center justify-between">
          <button onclick="navTo('hub')" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
            <span class="ms text-[18px]">chevron_left</span>
          </button>
          <div class="text-center">
            <div class="text-[11px] tracking-[0.22em] uppercase text-slate-400 font-semibold">MIND & SPIRIT</div>
            <div class="mt-1 text-2xl font-extrabold text-white">心智與靈修</div>
          </div>
          <button onclick="goToday()" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
            <span class="ms text-[18px]">today</span>
          </button>
        </div>

        <div class="mt-4 flex items-center justify-between">
          <div class="glass2 px-3 py-1.5 rounded-full border border-white/10 text-[11px] text-slate-200 font-semibold">
            <span id="mind-date">Today</span>
          </div>
          <div class="glass2 px-3 py-1.5 rounded-full border border-white/10 text-[11px] text-slate-200 font-semibold">
            完成度 <span class="ml-2 text-white font-extrabold"><span id="mind-completion">0</span>%</span>
          </div>
        </div>
      </header>

      <main class="px-4 pt-5 pb-6 flex-1 overflow-y-auto no-scrollbar">
        <div class="glass2 rounded-full p-1 border border-white/10 flex relative">
          <div id="tab-slider" class="absolute left-1 top-1 bottom-1 w-[calc(50%-4px)] bg-gradient-to-r from-violet to-violet2 rounded-full shadow-glow transition-transform duration-300"></div>
          <button id="tab-btn-mind" onclick="switchTab('mind')" class="flex-1 relative z-10 py-2.5 text-sm font-extrabold text-white text-center rounded-full">心智</button>
          <button id="tab-btn-spirit" onclick="switchTab('spirit')" class="flex-1 relative z-10 py-2.5 text-sm font-semibold text-slate-300 text-center rounded-full">靈修</button>
        </div>

        <!-- Mind tab -->
        <div id="tab-mind" class="mt-5 space-y-5">
          <!-- Reading timer -->
          <section class="glass rounded-3xl p-5 shadow-glass border border-white/10 relative overflow-hidden">
            <div class="absolute -top-12 -right-12 w-48 h-48 bg-gold/10 rounded-full blur-3xl"></div>
            <div class="flex items-start justify-between">
              <div>
                <div class="text-[11px] tracking-widest uppercase text-slate-400 font-semibold">FOCUS</div>
                <div class="mt-1 text-lg font-extrabold text-white">深度閱讀</div>
                <div class="mt-2 text-[11px] text-slate-400 font-semibold">本項分數：<span id="reading-points">+10 / 0</span></div>
              </div>
              <button onclick="toggleDone('reading')" id="reading-done-btn" class="glass2 border border-white/10 rounded-full px-3 py-2 text-[12px] font-bold text-slate-200 active:scale-95 transition-transform">
                完成
              </button>
            </div>

            <div class="mt-5 flex items-center justify-center gap-2">
              <button onclick="openDuration('reading')" class="glass2 border border-white/10 rounded-full px-4 py-2 text-[12px] font-bold text-slate-200 active:scale-95 transition-transform">
                設定 <span id="reading-min">20</span> min
              </button>
              <button onclick="resetTimer('reading')" class="glass2 border border-white/10 rounded-full px-4 py-2 text-[12px] font-bold text-slate-200 active:scale-95 transition-transform">
                重置
              </button>
            </div>

            <div class="mt-4 flex items-center justify-center">
              <div id="reading-display" class="text-6xl font-light tracking-tighter tabular-nums text-white">20:00</div>
            </div>

            <div class="mt-5 grid grid-cols-2 gap-2">
              <button id="reading-start" onclick="toggleTimer('reading')" class="glass2 border border-white/10 rounded-2xl py-3 font-extrabold text-white active:scale-95 transition-transform">開始</button>
              <button onclick="cancelTimer('reading')" class="glass2 border border-white/10 rounded-2xl py-3 font-bold text-slate-200 active:scale-95 transition-transform">取消（回到未完成）</button>
            </div>

            <div class="mt-2 text-[11px] text-slate-500 font-semibold">
              計時到 0 會自動完成；你也可以直接「完成」或「取消」反悔。
            </div>
          </section>

          <!-- Growth -->
          <section class="glass2 rounded-3xl p-5 border border-white/10 shadow-glass">
            <div class="text-[11px] tracking-widest uppercase text-slate-400 font-semibold">GROWTH REFLECTION</div>
            <div class="mt-1 text-lg font-extrabold text-white">今日反思</div>
            <div class="mt-2 text-[11px] text-slate-400 font-semibold">本項分數：<span id="growth-points">+10 / 0</span></div>
            <input id="growth-input" class="mt-4 w-full rounded-2xl bg-white/5 border border-white/10 text-white placeholder:text-slate-500 px-4 py-4 focus:outline-none focus:ring-2 focus:ring-violet/40"
                   placeholder="寫下今天的核心洞察..." />
            <div class="mt-2 text-[11px] text-slate-400 font-medium">輸入會自動保存（可補填過去日期）</div>
          </section>

          <!-- Brand -->
          <section class="glass2 rounded-3xl p-5 border border-white/10 shadow-glass">
            <div class="text-[11px] tracking-widest uppercase text-slate-400 font-semibold">BRAND STRATEGY</div>
            <div class="mt-1 text-lg font-extrabold text-white">品牌策略筆記</div>
            <div class="mt-2 text-[11px] text-slate-400 font-semibold">本項分數：<span id="brand-points">+10 / 0</span></div>
            <textarea id="brand-input" class="mt-4 w-full h-32 rounded-2xl bg-white/5 border border-white/10 text-white placeholder:text-slate-500 px-4 py-4 focus:outline-none focus:ring-2 focus:ring-violet/40 resize-none"
                      placeholder="紀錄你的策略思考..."></textarea>
            <div class="mt-2 text-[11px] text-slate-400 font-medium">有輸入就算完成（影響完成度）</div>
          </section>
        </div>

        <!-- Spirit tab -->
        <div id="tab-spirit" class="hidden mt-5 space-y-5">
          <section class="glass rounded-3xl p-5 shadow-glass border border-white/10 relative overflow-hidden">
            <div class="absolute -top-12 -right-12 w-48 h-48 bg-violet/10 rounded-full blur-3xl"></div>
            <div class="flex items-start justify-between">
              <div>
                <div class="text-[11px] tracking-widest uppercase text-slate-400 font-semibold">SILENCE</div>
                <div class="mt-1 text-lg font-extrabold text-white">靜默靈修</div>
                <div class="mt-2 text-[11px] text-slate-400 font-semibold">本項分數：<span id="devotion-points">+10 / 0</span></div>
              </div>
              <button onclick="toggleDone('devotion')" id="devotion-done-btn" class="glass2 border border-white/10 rounded-full px-3 py-2 text-[12px] font-bold text-slate-200 active:scale-95 transition-transform">
                完成
              </button>
            </div>

            <div class="mt-5 flex items-center justify-center gap-2">
              <button onclick="openDuration('devotion')" class="glass2 border border-white/10 rounded-full px-4 py-2 text-[12px] font-bold text-slate-200 active:scale-95 transition-transform">
                設定 <span id="devotion-min">10</span> min
              </button>
              <button onclick="resetTimer('devotion')" class="glass2 border border-white/10 rounded-full px-4 py-2 text-[12px] font-bold text-slate-200 active:scale-95 transition-transform">
                重置
              </button>
            </div>

            <div class="mt-4 flex items-center justify-center">
              <div id="devotion-display" class="text-6xl font-light tracking-tighter tabular-nums text-white">10:00</div>
            </div>

            <div class="mt-5 grid grid-cols-2 gap-2">
              <button id="devotion-start" onclick="toggleTimer('devotion')" class="glass2 border border-white/10 rounded-2xl py-3 font-extrabold text-white active:scale-95 transition-transform">開始</button>
              <button onclick="cancelTimer('devotion')" class="glass2 border border-white/10 rounded-2xl py-3 font-bold text-slate-200 active:scale-95 transition-transform">取消（回到未完成）</button>
            </div>

            <div class="mt-2 text-[11px] text-slate-500 font-semibold">
              計時到 0 自動完成；你也可以「完成/取消」。
            </div>
          </section>

          <section class="glass2 rounded-3xl p-5 border border-white/10 shadow-glass">
            <div class="text-[11px] tracking-widest uppercase text-slate-400 font-semibold">SCRIPTURE</div>
            <div class="mt-1 text-lg font-extrabold text-white">經文與領受</div>
            <div class="mt-2 text-[11px] text-slate-400 font-semibold">本項分數：<span id="scripture-points">+10 / 0</span></div>

            <label class="mt-4 block text-[11px] text-slate-400 font-semibold">經文出處</label>
            <input id="scripture-input" class="mt-2 w-full rounded-2xl bg-white/5 border border-white/10 text-white placeholder:text-slate-500 px-4 py-4 focus:outline-none focus:ring-2 focus:ring-violet/40"
                   placeholder="例如：Psalm 23:1" />

            <label class="mt-4 block text-[11px] text-slate-400 font-semibold">心得筆記</label>
            <textarea id="spirit-input" class="mt-2 w-full h-32 rounded-2xl bg-white/5 border border-white/10 text-white placeholder:text-slate-500 px-4 py-4 focus:outline-none focus:ring-2 focus:ring-violet/40 resize-none"
                      placeholder="記錄你的領受..."></textarea>

            <div class="mt-2 text-[11px] text-slate-400 font-medium">有輸入就算完成（影響完成度）</div>
          </section>
        </div>
      </main>
    </section>

    <!-- CALENDAR VIEW -->
    <section id="view-calendar" class="hidden flex-col flex-1 fade-in">
      <header class="pt-10 px-4">
        <div class="flex items-center justify-between">
          <button onclick="navTo('hub')" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
            <span class="ms text-[18px]">chevron_left</span>
          </button>
          <div class="text-center">
            <div class="text-[11px] tracking-[0.22em] uppercase text-slate-400 font-semibold">EVOLUTION CALENDAR</div>
            <div class="mt-1 text-2xl font-extrabold text-white">進化日曆</div>
          </div>
          <button onclick="goToday()" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
            <span class="ms text-[18px]">today</span>
          </button>
        </div>
      </header>

      <main class="px-4 pt-5 pb-6 flex-1 overflow-y-auto no-scrollbar space-y-4">
        <section class="glass rounded-3xl p-4 border border-white/10 shadow-glass">
          <div class="flex items-center justify-between glass2 rounded-2xl p-2 border border-white/10">
            <button onclick="changeMonth(-1)" class="px-3 py-2 rounded-xl hover:bg-white/5 active:scale-95 transition-transform">
              <span class="ms text-[18px]">chevron_left</span>
            </button>
            <div id="cal-title" class="text-lg font-extrabold text-white"></div>
            <button onclick="changeMonth(1)" class="px-3 py-2 rounded-xl hover:bg-white/5 active:scale-95 transition-transform">
              <span class="ms text-[18px]">chevron_right</span>
            </button>
          </div>

          <div class="mt-4 grid grid-cols-7 text-center text-[11px] font-semibold text-slate-400">
            <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
          </div>

          <div id="cal-grid" class="mt-3 grid grid-cols-7 gap-1.5"></div>

          <div class="mt-4 flex items-center justify-between">
            <div class="text-[11px] text-slate-400 font-semibold">
              完美日：完成度 ≥ 70%
            </div>
            <div class="text-[11px] text-slate-400 font-semibold">
              當前連勝：<span id="cal-streak" class="text-gold font-extrabold">0</span>
            </div>
          </div>
        </section>

        <!-- Reward -->
        <section class="glass2 rounded-3xl p-5 border border-white/10 shadow-glass relative overflow-hidden">
          <div class="absolute -top-10 -right-10 w-40 h-40 bg-gold/12 rounded-full blur-3xl"></div>
          <div class="flex items-center justify-between">
            <div>
              <div class="text-[11px] tracking-widest uppercase text-slate-400 font-semibold">WEEKLY</div>
              <div class="mt-1 text-lg font-extrabold text-white">神祕獎勵</div>
              <div class="mt-1 text-[12px] text-slate-400 font-medium">累積 3 個完美日解鎖（全域）</div>
            </div>
            <div class="text-right">
              <div class="text-2xl font-extrabold text-gold"><span id="reward-count">0</span>/3</div>
              <div class="text-[11px] text-slate-400 font-semibold">Perfect</div>
            </div>
          </div>
          <div class="mt-3 h-2 w-full rounded-full bg-white/5 border border-white/10 overflow-hidden">
            <div id="reward-bar" class="h-full w-[0%] bg-gradient-to-r from-gold via-gold2 to-violet2 rounded-full transition-all duration-500"></div>
          </div>
          <button id="reward-btn" disabled class="mt-4 w-full rounded-2xl py-3 text-sm font-extrabold bg-white/5 border border-white/10 text-slate-400 cursor-not-allowed">
            尚未解鎖
          </button>
        </section>

        <!-- Detail -->
        <section class="glass rounded-3xl p-5 border border-white/10 shadow-glass">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-[11px] tracking-widest uppercase text-slate-400 font-semibold">DETAIL</div>
              <div id="detail-date" class="mt-1 text-lg font-extrabold text-white">點擊日期查看</div>
            </div>
            <div class="flex items-center gap-2">
              <button onclick="setActiveFromDetail()" class="glass2 border border-white/10 rounded-full px-3 py-2 text-[12px] font-bold text-white active:scale-95 transition-transform">
                補填這天
              </button>
              <button onclick="settleSelectedDay()" class="glass2 border border-white/10 rounded-full px-3 py-2 text-[12px] font-bold text-white active:scale-95 transition-transform">
                結算這天
              </button>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-2 gap-3">
            <div class="glass2 rounded-2xl p-3 border border-white/10">
              <div class="text-[11px] text-slate-400 font-semibold">完成度</div>
              <div class="mt-1 text-2xl font-extrabold text-white"><span id="detail-percent">0</span>%</div>
              <div class="mt-1 text-[11px] text-slate-400 font-semibold">完美日：<span id="detail-perfect" class="text-slate-300">否</span></div>
            </div>
            <div class="glass2 rounded-2xl p-3 border border-white/10">
              <div class="text-[11px] text-slate-400 font-semibold">XP</div>
              <div class="mt-1 text-2xl font-extrabold text-gold">+<span id="detail-xp">0</span></div>
              <div class="mt-1 text-[11px] text-slate-400 font-semibold">已結算：<span id="detail-settled" class="text-slate-300">否</span></div>
            </div>
          </div>

          <div class="mt-4 space-y-3">
            <div class="glass2 rounded-2xl p-4 border border-white/10">
              <div class="text-[11px] tracking-widest uppercase text-slate-400 font-semibold">BODY</div>
              <div class="mt-2 text-[12px] text-slate-300 font-semibold">水：<span id="detail-water" class="text-white font-extrabold">-</span> / <span id="detail-water-goal">-</span> ml</div>
              <div class="mt-1 text-[12px] text-slate-300 font-semibold">排便：<span id="detail-bowel" class="text-white font-extrabold">-</span></div>
              <div class="mt-2 text-[12px] text-slate-300 font-semibold">任務：</div>
              <div id="detail-tasks" class="mt-2 space-y-1 text-[12px]"></div>
            </div>

            <div class="glass2 rounded-2xl p-4 border border-white/10">
              <div class="text-[11px] tracking-widest uppercase text-slate-400 font-semibold">MIND</div>
              <div class="mt-2 text-[12px] text-slate-300 font-semibold">閱讀：<span id="detail-reading" class="text-white font-extrabold">-</span></div>
              <div class="mt-1 text-[12px] text-slate-300 font-semibold">反思：<span id="detail-growth" class="text-white/90 italic">-</span></div>
              <div class="mt-1 text-[12px] text-slate-300 font-semibold">策略：<span id="detail-brand" class="text-white/90 italic">-</span></div>
            </div>

            <div class="glass2 rounded-2xl p-4 border border-white/10">
              <div class="text-[11px] tracking-widest uppercase text-slate-400 font-semibold">SPIRIT</div>
              <div class="mt-2 text-[12px] text-slate-300 font-semibold">靜默：<span id="detail-devotion" class="text-white font-extrabold">-</span></div>
              <div class="mt-1 text-[12px] text-slate-300 font-semibold">經文：<span id="detail-scripture" class="text-white/90 italic">-</span></div>
              <div class="mt-1 text-[12px] text-slate-300 font-semibold">心得：<span id="detail-spirit" class="text-white/90 italic">-</span></div>
            </div>
          </div>
        </section>
      </main>
    </section>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 left-0 right-0 z-50 flex justify-center pb-6 pt-2">
      <div class="glass mx-auto w-[92%] max-w-[390px] rounded-full flex justify-between items-center py-3 px-6 shadow-glass border border-white/10 bg-obsidian/80">
        <button onclick="navTo('hub')" class="navbtn flex flex-col items-center gap-1 w-16" data-view="hub">
          <span class="ms fill text-[24px]" id="nav-ico-hub">dashboard</span>
          <span class="text-[11px] font-extrabold" id="nav-txt-hub">Hub</span>
        </button>
        <button onclick="navTo('body')" class="navbtn flex flex-col items-center gap-1 w-16 opacity-70" data-view="body">
          <span class="ms text-[24px]" id="nav-ico-body">fitness_center</span>
          <span class="text-[11px] font-semibold" id="nav-txt-body">Body</span>
        </button>
        <button onclick="navTo('mind')" class="navbtn flex flex-col items-center gap-1 w-16 opacity-70" data-view="mind">
          <span class="ms text-[24px]" id="nav-ico-mind">auto_stories</span>
          <span class="text-[11px] font-semibold" id="nav-txt-mind">Mind</span>
        </button>
        <button onclick="navTo('calendar')" class="navbtn flex flex-col items-center gap-1 w-16 opacity-70" data-view="calendar">
          <span class="ms text-[24px]" id="nav-ico-calendar">calendar_month</span>
          <span class="text-[11px] font-semibold" id="nav-txt-calendar">Evo</span>
        </button>
      </div>
    </nav>
  </div>

  <!-- Toast -->
  <div id="toast-wrap" class="fixed left-0 right-0 bottom-28 z-[60] flex justify-center px-4 pointer-events-none"></div>

  <!-- Modal: Profile -->
  <div id="modal-profile" class="hidden fixed inset-0 z-[80]">
    <div class="absolute inset-0 bg-black/55"></div>
    <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[92%] max-w-md glass rounded-3xl p-5 border border-white/10 shadow-glass">
      <div class="flex items-center justify-between">
        <div class="text-lg font-extrabold text-white">個人設定</div>
        <button onclick="closeModal('modal-profile')" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
          <span class="ms text-[18px]">close</span>
        </button>
      </div>

      <div class="mt-4 space-y-3">
        <div>
          <label class="text-[11px] text-slate-400 font-semibold">名字</label>
          <input id="inp-name" class="mt-2 w-full rounded-2xl bg-white/5 border border-white/10 text-white px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet/40" />
        </div>
        <div>
          <label class="text-[11px] text-slate-400 font-semibold">頭像圖片 URL</label>
          <input id="inp-avatar" class="mt-2 w-full rounded-2xl bg-white/5 border border-white/10 text-white px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet/40"
                 placeholder="https://..." />
          <div class="mt-2 text-[11px] text-slate-400 font-medium">（改頭像/名字 → 這裡）</div>
        </div>
        <div>
          <label class="text-[11px] text-slate-400 font-semibold">標題</label>
          <input id="inp-title" class="mt-2 w-full rounded-2xl bg-white/5 border border-white/10 text-white px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet/40" />
        </div>

        <div class="grid grid-cols-2 gap-2 mt-2">
          <button onclick="saveProfile()" class="rounded-2xl py-3 font-extrabold text-ink bg-gradient-to-r from-gold via-gold2 to-gold shadow-gold active:scale-95 transition-transform">
            保存
          </button>
          <button onclick="confirmReset()" class="glass2 border border-white/10 rounded-2xl py-3 font-extrabold text-white active:scale-95 transition-transform">
            系統重置
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Duration -->
  <div id="modal-duration" class="hidden fixed inset-0 z-[90]">
    <div class="absolute inset-0 bg-black/55"></div>
    <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[92%] max-w-md glass rounded-3xl p-5 border border-white/10 shadow-glass">
      <div class="flex items-center justify-between">
        <div class="text-lg font-extrabold text-white">設定倒數時間</div>
        <button onclick="closeModal('modal-duration')" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
          <span class="ms text-[18px]">close</span>
        </button>
      </div>

      <div class="mt-4">
        <div class="text-[12px] text-slate-300 font-semibold" id="dur-title">—</div>
        <div class="mt-3 glass2 rounded-2xl border border-white/10 p-4">
          <label class="text-[11px] text-slate-400 font-semibold">分鐘（1–180）</label>
          <input id="dur-min" type="number" min="1" max="180"
                 class="mt-2 w-full rounded-2xl bg-white/5 border border-white/10 text-white px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet/40"/>
          <div class="mt-3 grid grid-cols-4 gap-2">
            <button onclick="quickMin(5)" class="glass2 border border-white/10 rounded-xl py-2 text-[12px] font-bold text-white active:scale-95 transition-transform">5</button>
            <button onclick="quickMin(10)" class="glass2 border border-white/10 rounded-xl py-2 text-[12px] font-bold text-white active:scale-95 transition-transform">10</button>
            <button onclick="quickMin(20)" class="glass2 border border-white/10 rounded-xl py-2 text-[12px] font-bold text-white active:scale-95 transition-transform">20</button>
            <button onclick="quickMin(30)" class="glass2 border border-white/10 rounded-xl py-2 text-[12px] font-bold text-white active:scale-95 transition-transform">30</button>
          </div>
          <div class="mt-3 text-[11px] text-slate-500 font-semibold">
            套用會：停止計時、回到未完成、重設倒數（避免邏輯錯亂）。
          </div>
        </div>

        <button onclick="applyDuration()" class="mt-4 w-full rounded-2xl py-3 font-extrabold text-ink bg-gradient-to-r from-violet via-violet2 to-cyan shadow-glow active:scale-95 transition-transform">
          套用
        </button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * 0) STORAGE + MIGRATE
     ***********************/
    const STORAGE_KEY = "ate_ultra_v2"; // bump version due to timer rewrite
    const LEGACY_KEY = "ate_ultra_v1";   // migrate from your last build (if exists)

    const DEFAULT_AVATAR = "https://lh3.googleusercontent.com/aida-public/AB6AXuCAYOzNGEzdDG66QmmNGCUlkdnwk7zJo0-6al0p4StVVrRy7UvwIFfnSbzk1yro93SGmClDJXzHkeK0f3pOKlJ7_0wH9VzNbQ3ATQRP2P4Msi2j3L88v-cPqgWfProkys6HXeVgnOq9poVFtfNyxvn9pqj2xho4IOb0kutPRkMrNn2qgl6IG3CfgZJFN6h_2N_KyQQzgP3uX0T6tGAkUnEDgaVjHUIXMZVxocw3H1i2okCF0BovjWGbicSrh5A42xuvBTiOpnUCuI0";

    // ✅ EN verses (short, safe, not claiming translation/version)
    const VERSES_EN = [
      { t: "Be strong and courageous. Do not be afraid; do not be discouraged, for the Lord your God will be with you wherever you go.", r: "Joshua 1:9" },
      { t: "Commit your way to the Lord; trust in Him, and He will act.", r: "Psalm 37:5" },
      { t: "Be still, and know that I am God.", r: "Psalm 46:10" },
      { t: "The Lord is my shepherd; I shall not want.", r: "Psalm 23:1" },
      { t: "Give thanks in all circumstances.", r: "1 Thessalonians 5:18" },
      { t: "Commit your work to the Lord, and your plans will be established.", r: "Proverbs 16:3" },
      { t: "Do not be anxious about anything; in every situation, by prayer and petition, with thanksgiving, present your requests to God.", r: "Philippians 4:6" },
      { t: "Let us not grow weary in doing good; in due season we will reap, if we do not give up.", r: "Galatians 6:9" },
      { t: "My grace is sufficient for you, for my power is made perfect in weakness.", r: "2 Corinthians 12:9" },
      { t: "Seek first His kingdom and His righteousness, and all these things will be added to you.", r: "Matthew 6:33" },
    ];

    /***********************
     * 0.1) POINTS MODEL (so each action can show +/-)
     ***********************/
    const POINTS = {
      waterMax: 25,
      taskTimerEach: 10,
      taskCheck: 10,
      bowel: 10,
      reading: 10,
      devotion: 10,
      growth: 10,
      brand: 10,
      scripture: 10,
      // XP formula uses completion ratio; points are for UI clarity
    };

    /***********************
     * 0.2) STATE
     ***********************/
    const state = loadState();

    function loadState() {
      const current = localStorage.getItem(STORAGE_KEY);
      if (current) return JSON.parse(current);

      // migrate from previous build (v1)
      const legacy = localStorage.getItem(LEGACY_KEY);
      if (legacy) {
        try {
          const old = JSON.parse(legacy) || {};
          const migrated = freshState();

          migrated.profile = old.profile || migrated.profile;
          migrated.gamification = old.gamification || migrated.gamification;
          migrated.ui = old.ui || migrated.ui;
          migrated.days = old.days || migrated.days;

          // normalize days shape (ensure timers exist)
          Object.keys(migrated.days || {}).forEach(k=>{
            migrated.days[k] = normalizeDay(migrated.days[k], k);
          });

          save(migrated);
          return migrated;
        } catch(e) {}
      }

      const s = freshState();
      save(s);
      return s;
    }

    function freshState(){
      return {
        profile: { name: "覺醒女神", title: "Aether Trinity Evolution", avatar: DEFAULT_AVATAR },
        gamification: { level: 1, xp: 0, xpMax: 100 },
        ui: {
          view: "hub",
          activeDate: todayKey(),
          mindTab: "mind",
          calYM: (() => {
            const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          })(),
          selectedDate: todayKey(),
        },
        days: {}
      };
    }

    function defaultDay(dateKey){
      return {
        date: dateKey,
        waterGoalMl: 1900,
        waterMl: 0,
        bowelStatus: "未完成",
        tasks: [
          { id: 1, type: "timer", title: "深蹲練習", sub: "核心肌群", minutes: 15, remainingSec: 15*60, running: false, done: false },
          { id: 2, type: "timer", title: "每日肌肉訓練", sub: "30 分鐘", minutes: 30, remainingSec: 30*60, running: false, done: false },
          { id: 3, type: "check", title: "健康早餐", sub: "建議 08:30 AM", done: false },
        ],
        reading: { minutes: 20, remainingSec: 20*60, running: false, done: false },
        devotion: { minutes: 10, remainingSec: 10*60, running: false, done: false },
        mind: { growth: "", brand: "" },
        spirit: { scripture: "", note: "" },
        settle: { settled: false, xpAwarded: 0, percentAtSettle: 0 }
      };
    }

    function normalizeDay(day, dateKey){
      const d = Object.assign(defaultDay(dateKey), day || {});
      // ensure nested keys
      d.tasks = Array.isArray(d.tasks) ? d.tasks : defaultDay(dateKey).tasks;
      d.tasks = d.tasks.map(t=>{
        if(t.type==="timer"){
          const m = Number(t.minutes || 10);
          const rem = Number.isFinite(t.remainingSec) ? t.remainingSec : m*60;
          return { ...t, minutes:m, remainingSec: rem, running: !!t.running, done: !!t.done };
        }
        return { ...t, done: !!t.done };
      });
      d.reading = d.reading || defaultDay(dateKey).reading;
      d.devotion = d.devotion || defaultDay(dateKey).devotion;
      d.reading = { minutes:Number(d.reading.minutes||20), remainingSec:Number(d.reading.remainingSec||d.reading.minutes*60), running:!!d.reading.running, done:!!d.reading.done };
      d.devotion = { minutes:Number(d.devotion.minutes||10), remainingSec:Number(d.devotion.remainingSec||d.devotion.minutes*60), running:!!d.devotion.running, done:!!d.devotion.done };
      d.mind = d.mind || { growth:"", brand:"" };
      d.spirit = d.spirit || { scripture:"", note:"" };
      d.settle = d.settle || { settled:false, xpAwarded:0, percentAtSettle:0 };
      return d;
    }

    function ensureDay(key){
      if (!state.days[key]) state.days[key] = defaultDay(key);
      state.days[key] = normalizeDay(state.days[key], key);
      return state.days[key];
    }

    function save(s = state){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
    }

    /***********************
     * 1) DATE
     ***********************/
    function todayKey(){
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }
    function formatKey(key){
      const [y,m,d] = key.split("-");
      return `${y}年${m}月${d}日`;
    }
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function activeKey(){ return state.ui.activeDate || todayKey(); }

    /***********************
     * 2) POINTS BREAKDOWN (for +/- display)
     ***********************/
    function pointsBreakdown(day){
      // water: proportional 0..waterMax
      const waterRatio = clamp(day.waterGoalMl ? day.waterMl / day.waterGoalMl : 0, 0, 1);
      const waterPts = Math.round(POINTS.waterMax * waterRatio);

      // tasks: fixed per task
      let taskPts = 0;
      day.tasks.forEach(t=>{
        if(t.type==="timer") taskPts += t.done ? POINTS.taskTimerEach : 0;
        if(t.type==="check") taskPts += t.done ? POINTS.taskCheck : 0;
      });

      const bowelPts = (day.bowelStatus !== "未完成") ? POINTS.bowel : 0;
      const readingPts = day.reading.done ? POINTS.reading : 0;
      const devotionPts = day.devotion.done ? POINTS.devotion : 0;

      const growthPts = day.mind.growth.trim() ? POINTS.growth : 0;
      const brandPts  = day.mind.brand.trim()  ? POINTS.brand  : 0;

      const scripturePts = (day.spirit.scripture.trim() || day.spirit.note.trim()) ? POINTS.scripture : 0;

      const totalPts =
        POINTS.waterMax +
        day.tasks.reduce((acc,t)=> acc + (t.type==="timer"?POINTS.taskTimerEach:POINTS.taskCheck), 0) +
        POINTS.bowel + POINTS.reading + POINTS.devotion + POINTS.growth + POINTS.brand + POINTS.scripture;

      const gotPts = waterPts + taskPts + bowelPts + readingPts + devotionPts + growthPts + brandPts + scripturePts;

      return { waterPts, taskPts, bowelPts, readingPts, devotionPts, growthPts, brandPts, scripturePts, totalPts, gotPts, waterRatio };
    }

    /***********************
     * 3) COMPLETION + XP
     ***********************/
    function computeCompletion(day){
      // completion ratio uses water ratio + binary items count (same spirit as your v1)
      const p = pointsBreakdown(day);

      // Convert points ratio to completion percent (simpler + consistent with +/- display)
      const ratio = p.totalPts ? (p.gotPts / p.totalPts) : 0;
      const percent = Math.round(ratio * 100);
      const perfect = ratio >= 0.70;

      // XP based on ratio (keeps your previous vibe)
      let xp = 30 + Math.round(170 * ratio);
      if (perfect) xp += 20;
      xp = clamp(xp, 0, 220);

      return { ratio, percent, perfect, xp, points: p };
    }

    function computeStreak(){
      let streak = 0;
      let k = todayKey();
      while(true){
        const day = ensureDay(k);
        const c = computeCompletion(day);
        if (!c.perfect) break;
        streak++;
        const d = new Date(k + "T00:00:00");
        d.setDate(d.getDate() - 1);
        k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      }
      return streak;
    }

    function allPerfectCount(){
      let c = 0;
      Object.keys(state.days).forEach(k=>{
        const cc = computeCompletion(ensureDay(k));
        if (cc.perfect) c++;
      });
      return c;
    }

    /***********************
     * 4) TOAST
     ***********************/
    function toast(title, msg){
      const wrap = document.getElementById("toast-wrap");
      const el = document.createElement("div");
      el.className = "toast pointer-events-none w-full max-w-md";
      el.innerHTML = `
        <div class="glass2 border border-white/10 shadow-glass rounded-2xl px-4 py-3">
          <div class="text-sm font-extrabold text-white">${escapeHtml(title)}</div>
          <div class="mt-1 text-[12px] text-slate-300 font-medium leading-relaxed">${escapeHtml(msg)}</div>
        </div>
      `;
      wrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(8px)"; el.style.transition="all .25s ease"; }, 2200);
      setTimeout(()=>{ el.remove(); }, 2600);
      try { navigator.vibrate && navigator.vibrate(18); } catch(e){}
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));
    }

    /***********************
     * 5) NAV + MODALS
     ***********************/
    function navTo(view){
      // ✅ IMPORTANT: DO NOT pause timers on view switch; just keep a single global tick running
      state.ui.view = view;
      save();
      renderAll();
    }

    function switchTab(tab){
      state.ui.mindTab = tab;
      save();
      renderMindTabs();
    }

    function goToday(){
      state.ui.activeDate = todayKey();
      state.ui.selectedDate = todayKey();
      save();
      renderAll();
      toast("已回到今天", "你可以直接記錄今日或補填過去日期。");
    }

    function openModal(id){
      document.getElementById(id).classList.remove("hidden");
      document.body.style.overflow = "hidden";
    }
    function closeModal(id){
      document.getElementById(id).classList.add("hidden");
      document.body.style.overflow = "";
    }

    function saveProfile(){
      const name = document.getElementById("inp-name").value.trim() || "覺醒女神";
      const avatar = document.getElementById("inp-avatar").value.trim() || DEFAULT_AVATAR;
      const title = document.getElementById("inp-title").value.trim() || "Aether Trinity Evolution";
      state.profile.name = name;
      state.profile.avatar = avatar;
      state.profile.title = title;
      save();
      closeModal("modal-profile");
      renderProfile();
      toast("已保存", "個人設定已更新。");
    }

    function confirmReset(){
      const ok = confirm("【系統重置】確定要清除所有紀錄並從 0 開始嗎？");
      if(!ok) return;
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(LEGACY_KEY);
      location.reload();
    }

    /***********************
     * 6) BODY ACTIONS
     ***********************/
    function modifyWater(delta){
      const d = ensureDay(activeKey());
      d.waterMl = Math.max(0, d.waterMl + delta);
      save();
      renderAll();
      toast(delta>0 ? "水分增加" : "水分扣回", `${delta>0?'+':''}${delta} ml（分數會依達標比例即時變動）`);
    }

    function setBowel(val){
      const d = ensureDay(activeKey());
      d.bowelStatus = val;
      save();
      renderAll();
      toast("排便狀況已更新", val === "正常" ? `+${POINTS.bowel} 分` : "0 分");
    }

    function toggleCheckTask(id){
      const d = ensureDay(activeKey());
      const t = d.tasks.find(x=>x.id===id);
      if(!t) return;
      t.done = !t.done;
      save();
      renderAll();
      toast(t.done ? "任務完成" : "取消完成", `${t.title}（${t.done?'+':'-'}${POINTS.taskCheck} 分）`);
    }

    /***********************
     * 7) ✅ TIMER REWRITE (single reliable global tick)
     *   - Every timer stores remainingSec + running + done
     *   - One global interval ticks once per second
     *   - If remaining reaches 0: done=true, running=false
     ***********************/
    let globalTick = null;

    function startGlobalTick(){
      if(globalTick) return;
      globalTick = setInterval(()=>{
        // tick only active date timers (so you don't accidentally run past day)
        const key = activeKey();
        const day = ensureDay(key);

        let changed = false;

        // task timers
        day.tasks.forEach(t=>{
          if(t.type==="timer" && t.running && !t.done){
            if(t.remainingSec > 0){
              t.remainingSec -= 1;
              changed = true;
              if(t.remainingSec <= 0){
                t.remainingSec = 0;
                t.running = false;
                t.done = true;
                changed = true;
                toast("計時完成", `${t.title}（+${POINTS.taskTimerEach} 分）`);
              }
            }
          }
        });

        // reading
        if(day.reading.running && !day.reading.done){
          if(day.reading.remainingSec > 0){
            day.reading.remainingSec -= 1;
            changed = true;
            if(day.reading.remainingSec <= 0){
              day.reading.remainingSec = 0;
              day.reading.running = false;
              day.reading.done = true;
              changed = true;
              toast("計時完成", `深度閱讀（+${POINTS.reading} 分）`);
            }
          }
        }

        // devotion
        if(day.devotion.running && !day.devotion.done){
          if(day.devotion.remainingSec > 0){
            day.devotion.remainingSec -= 1;
            changed = true;
            if(day.devotion.remainingSec <= 0){
              day.devotion.remainingSec = 0;
              day.devotion.running = false;
              day.devotion.done = true;
              changed = true;
              toast("計時完成", `靜默靈修（+${POINTS.devotion} 分）`);
            }
          }
        }

        if(changed){
          save();
          // light update only (no re-bind inputs)
          renderTimersOnly();
          renderCompletionOnly();
        }
      }, 1000);
    }

    function stopAllRunningTimersOnActiveDay(){
      const day = ensureDay(activeKey());
      day.tasks.forEach(t=>{ if(t.type==="timer") t.running = false; });
      day.reading.running = false;
      day.devotion.running = false;
    }

    function toggleTimer(kind, id){
      const day = ensureDay(activeKey());
      let ref = null;
      let title = "";

      if(kind==="reading"){ ref = day.reading; title = "深度閱讀"; }
      else if(kind==="devotion"){ ref = day.devotion; title = "靜默靈修"; }
      else if(kind==="task"){ ref = day.tasks.find(t=>t.id===id); title = ref?.title || "任務"; }

      if(!ref) return;

      // If already done, do not start; user must cancel to restart (avoids logic confusion)
      if(ref.done){
        toast("已完成", "若要重新計算，請先按「取消」。");
        return;
      }

      // only allow one running timer at a time (prevents weirdness)
      stopAllRunningTimersOnActiveDay();

      if(ref.running){
        ref.running = false;
        save(); renderAll();
        toast("已暫停", title);
        return;
      }

      // if remaining is 0 but not done, reset to full
      if(ref.remainingSec <= 0){
        const mins = Number(ref.minutes || 10);
        ref.remainingSec = mins * 60;
      }

      ref.running = true;
      save();
      renderAll();
      toast("開始計時", title);
      startGlobalTick();
    }

    function resetTimer(kind, id){
      const day = ensureDay(activeKey());
      let ref = null;
      let title = "";

      if(kind==="reading"){ ref = day.reading; title="深度閱讀"; }
      else if(kind==="devotion"){ ref = day.devotion; title="靜默靈修"; }
      else if(kind==="task"){ ref = day.tasks.find(t=>t.id===id); title=ref?.title||"任務"; }

      if(!ref) return;

      ref.running = false;
      ref.remainingSec = Number(ref.minutes || 10) * 60;
      // keep done state? reset should NOT silently cancel completion (you asked to avoid mis-touch)
      save();
      renderAll();
      toast("已重置", `${title}（時間回到 ${ref.minutes} 分鐘）`);
    }

    function cancelTimer(kind, id){
      const day = ensureDay(activeKey());
      let ref = null;
      let title = "";
      let pts = 0;

      if(kind==="reading"){ ref = day.reading; title="深度閱讀"; pts = POINTS.reading; }
      else if(kind==="devotion"){ ref = day.devotion; title="靜默靈修"; pts = POINTS.devotion; }
      else if(kind==="task"){ ref = day.tasks.find(t=>t.id===id); title=ref?.title||"任務"; pts = POINTS.taskTimerEach; }

      if(!ref) return;

      ref.running = false;
      ref.done = false; // ✅ cancel means "back to not completed"
      ref.remainingSec = Number(ref.minutes || 10) * 60;

      save();
      renderAll();
      toast("已取消", `${title}（-${pts} 分 / 回到未完成）`);
    }

    function toggleDone(kind, id){
      // ✅ One button that clearly toggles 完成 / 取消完成
      const day = ensureDay(activeKey());
      let ref=null, title="", pts=0;

      if(kind==="reading"){ ref=day.reading; title="深度閱讀"; pts=POINTS.reading; }
      else if(kind==="devotion"){ ref=day.devotion; title="靜默靈修"; pts=POINTS.devotion; }
      else if(kind==="task"){ ref=day.tasks.find(t=>t.id===id); title=ref?.title||"任務"; pts=POINTS.taskTimerEach; }

      if(!ref) return;

      // toggle
      const next = !ref.done;
      ref.done = next;
      ref.running = false;

      // if marking done, set remaining to 0 for clarity
      if(next) ref.remainingSec = 0;
      else ref.remainingSec = Number(ref.minutes || 10) * 60;

      save();
      renderAll();
      toast(next ? "已完成" : "取消完成", `${title}（${next?'+':'-'}${pts} 分）`);
    }

    /***********************
     * 8) INPUTS (autosave)
     ***********************/
    let inputsBound = false;
    function bindInputs(){
      if(inputsBound) return; // prevent multiple listener stacking
      inputsBound = true;

      const growth = document.getElementById("growth-input");
      const brand = document.getElementById("brand-input");
      const scripture = document.getElementById("scripture-input");
      const spirit = document.getElementById("spirit-input");

      const on = (el, fn)=>{
        if(!el) return;
        el.addEventListener("input", ()=>{
          fn(el.value);
          save();
          renderCompletionOnly();
          renderPointsHintsOnly();
        });
        el.addEventListener("change", ()=>{
          fn(el.value);
          save();
          renderAll();
        });
      };

      on(growth, v=> ensureDay(activeKey()).mind.growth = v);
      on(brand, v=> ensureDay(activeKey()).mind.brand = v);
      on(scripture, v=> ensureDay(activeKey()).spirit.scripture = v);
      on(spirit, v=> ensureDay(activeKey()).spirit.note = v);
    }

    /***********************
     * 9) DURATION MODAL
     ***********************/
    let durationTarget = null;
    function openDuration(target){
      durationTarget = target;
      const title = document.getElementById("dur-title");
      const inp = document.getElementById("dur-min");
      const day = ensureDay(activeKey());

      if(target === "reading"){
        title.textContent = "深度閱讀";
        inp.value = day.reading.minutes;
      } else if(target === "devotion"){
        title.textContent = "靜默靈修";
        inp.value = day.devotion.minutes;
      } else {
        const t = day.tasks.find(x=>x.id===target);
        title.textContent = t ? t.title : "任務";
        inp.value = t ? t.minutes : 10;
      }
      openModal("modal-duration");
    }

    function quickMin(m){
      document.getElementById("dur-min").value = m;
    }

    function applyDuration(){
      const m = clamp(parseInt(document.getElementById("dur-min").value || "10", 10), 1, 180);
      const day = ensureDay(activeKey());

      // applying duration always resets completion for that item (safe logic)
      if(durationTarget === "reading"){
        day.reading.minutes = m;
        day.reading.running = false;
        day.reading.done = false;
        day.reading.remainingSec = m*60;
      } else if(durationTarget === "devotion"){
        day.devotion.minutes = m;
        day.devotion.running = false;
        day.devotion.done = false;
        day.devotion.remainingSec = m*60;
      } else {
        const t = day.tasks.find(x=>x.id===durationTarget);
        if(t && t.type==="timer"){
          t.minutes = m;
          t.running = false;
          t.done = false;
          t.remainingSec = m*60;
        }
      }

      save();
      closeModal("modal-duration");
      renderAll();
      toast("已套用", `倒數時間設定為 ${m} 分鐘（此項已回到未完成）。`);
    }

    /***********************
     * 10) CALENDAR
     ***********************/
    function changeMonth(offset){
      const [y,m] = state.ui.calYM.split("-");
      const d = new Date(parseInt(y,10), parseInt(m,10)-1, 1);
      d.setMonth(d.getMonth()+offset);
      state.ui.calYM = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      save();
      renderCalendar();
    }

    function selectDate(key){
      state.ui.selectedDate = key;
      ensureDay(key);
      save();
      renderCalendar();
      renderDetail();
    }

    function setActiveFromDetail(){
      state.ui.activeDate = state.ui.selectedDate;
      save();
      navTo("body");
      toast("已切換日期", "你現在是在補填這一天。");
    }

    function settleSelectedDay(){
      settleDay(state.ui.selectedDate);
      renderAll();
      toast("已結算", "日曆摘要已更新。");
    }

    /***********************
     * 11) SETTLEMENT (XP)
     ***********************/
    function settleDay(key){
      const day = ensureDay(key);
      const c = computeCompletion(day);

      const prev = day.settle || { settled:false, xpAwarded:0, percentAtSettle:0 };
      const newAward = c.xp;
      const delta = newAward - (prev.xpAwarded || 0);

      applyXpDelta(delta);

      day.settle = { settled: true, xpAwarded: newAward, percentAtSettle: c.percent };
      save();
    }

    function applyXpDelta(delta){
      if(delta === 0) return;
      const g = state.gamification;

      let xp = g.xp + delta;
      let lv = g.level;
      let max = g.xpMax;

      while(xp >= max){
        xp -= max;
        lv += 1;
        max = Math.round(max * 1.18);
      }

      while(xp < 0 && lv > 1){
        lv -= 1;
        max = Math.round(max / 1.18);
        xp += max;
      }

      xp = Math.max(0, xp);
      g.level = lv;
      g.xp = xp;
      g.xpMax = max;

      try { navigator.vibrate && navigator.vibrate(delta>0 ? 22 : 14); } catch(e){}
    }

    /***********************
     * 12) RENDER HELPERS
     ***********************/
    function tickLabel(sec){
      const s = Math.max(0, Math.floor(sec));
      const m = Math.floor(s/60);
      const r = s%60;
      return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;
    }

    function renderAll(){
      // views
      ["hub","body","mind","calendar"].forEach(v=>{
        const el = document.getElementById("view-"+v);
        if(!el) return;
        el.classList.toggle("hidden", state.ui.view !== v);
      });

      // nav highlight
      ["hub","body","mind","calendar"].forEach(v=>{
        const ico = document.getElementById("nav-ico-"+v);
        const txt = document.getElementById("nav-txt-"+v);
        const btn = ico?.parentElement;
        const active = state.ui.view === v;
        if(btn) btn.classList.toggle("opacity-70", !active);
        if(ico){
          ico.className = "ms " + (active ? "fill text-[24px] text-violet2" : "text-[24px] text-slate-300");
        }
        if(txt){
          txt.className = (active ? "text-[11px] font-extrabold text-white" : "text-[11px] font-semibold text-slate-400");
        }
      });

      renderProfile();
      renderHub();
      renderBody();
      renderMind();
      renderCalendar();
      renderDetail();

      bindInputs();
      startGlobalTick(); // ensure timers can run
    }

    function renderProfile(){
      document.getElementById("profile-name").textContent = state.profile.name;
      document.getElementById("profile-title").textContent = state.profile.title;
      document.getElementById("profile-avatar").src = state.profile.avatar || DEFAULT_AVATAR;
      document.getElementById("profile-level-mini").textContent = `LV ${state.gamification.level}`;

      document.getElementById("hub-xp").textContent = state.gamification.xp;
      document.getElementById("hub-xpmax").textContent = state.gamification.xpMax;

      const pct = clamp(state.gamification.xpMax ? (state.gamification.xp/state.gamification.xpMax)*100 : 0, 0, 100);
      document.getElementById("hub-xpbar").style.width = pct.toFixed(0) + "%";

      // ✅ show completion & xp estimate on profile
      const day = ensureDay(activeKey());
      const c = computeCompletion(day);
      document.getElementById("profile-completion").textContent = `${c.percent}%`;
      document.getElementById("profile-xp-est").textContent = `+${c.xp} XP`;
      document.getElementById("profile-streak").textContent = `${computeStreak()} Days`;

      const settled = day.settle?.settled;
      const settleEl = document.getElementById("profile-settled");
      settleEl.textContent = settled ? `已結算：+${day.settle.xpAwarded} XP` : "未結算";
      settleEl.className = settled ? "text-[10px] text-lime font-extrabold" : "text-[10px] text-slate-400 font-semibold";
    }

    function renderHub(){
      const key = activeKey();
      const day = ensureDay(key);
      const c = computeCompletion(day);

      document.getElementById("hub-date").textContent = (key===todayKey()) ? "Today" : key;
      document.getElementById("hub-completion").textContent = c.percent;
      document.getElementById("hub-body-score").textContent = c.percent;
      document.getElementById("hub-body-bar").style.width = `${c.percent}%`;
      document.getElementById("hub-xp-est").textContent = c.xp;

      // Daily verse EN
      const now = new Date();
      const idx = Math.floor((now - new Date(now.getFullYear(),0,0))/86400000) % VERSES_EN.length;
      document.getElementById("daily-verse").textContent = "“" + VERSES_EN[idx].t + "”";
      document.getElementById("daily-verse-ref").textContent = VERSES_EN[idx].r;
    }

    function renderBody(){
      if(state.ui.view !== "body") return;
      const key = activeKey();
      const day = ensureDay(key);
      const c = computeCompletion(day);

      document.getElementById("body-date").textContent = (key===todayKey()) ? "Today" : formatKey(key);
      document.getElementById("body-completion").textContent = c.percent;

      document.getElementById("water-goal").textContent = day.waterGoalMl;
      document.getElementById("water-val").textContent = day.waterMl;
      document.getElementById("water-bar").style.width = `${Math.round(c.points.waterRatio*100)}%`;

      document.getElementById("water-points-hint").textContent = `此區分數：${c.points.waterPts}/${POINTS.waterMax}（滿分 +${POINTS.waterMax}）`;

      // bowel points
      document.getElementById("bowel-points").textContent = `+${POINTS.bowel} / 0`;

      // bowel buttons state
      const a = document.getElementById("bowel-a");
      const b = document.getElementById("bowel-b");
      const on = (btn, active)=>{
        btn.classList.toggle("bg-white/10", active);
        btn.classList.toggle("border-violet/30", active);
        btn.classList.toggle("text-white", active);
        btn.classList.toggle("text-slate-200", !active);
      };
      on(a, day.bowelStatus==="未完成");
      on(b, day.bowelStatus==="正常");

      // tasks list with +/- points display + safe toggle
      const list = document.getElementById("task-list");
      list.innerHTML = day.tasks.map(t=>{
        if(t.type==="check"){
          const pts = POINTS.taskCheck;
          return `
          <div class="glass2 rounded-3xl p-4 border border-white/10 shadow-glass">
            <div class="flex items-center justify-between">
              <div class="min-w-0">
                <div class="text-lg font-extrabold ${t.done?'text-white line-through decoration-violet/40':'text-white'} truncate">${escapeHtml(t.title)}</div>
                <div class="mt-1 text-[12px] text-slate-400 font-medium">${escapeHtml(t.sub)}</div>
                <div class="mt-2 text-[11px] text-slate-400 font-semibold">本動作：${t.done?`-${pts}`:`+${pts}`} 分</div>
              </div>
              <button onclick="toggleCheckTask(${t.id})"
                      class="glass2 border border-white/10 rounded-full w-12 h-12 flex items-center justify-center active:scale-95 transition-transform ${t.done?'bg-violet/20 border-violet/30':''}"
                      title="${t.done?'取消完成':'標記完成'}">
                <span class="ms ${t.done?'fill text-violet2':'text-slate-300'} text-[22px]">done</span>
              </button>
            </div>
          </div>`;
        }

        // timer task
        const pts = POINTS.taskTimerEach;
        const running = t.running && !t.done;
        const done = t.done;
        const mainText = done ? "取消完成" : "完成";
        const startText = running ? "暫停" : "開始";
        const time = tickLabel(t.remainingSec);

        return `
        <div class="glass2 rounded-3xl p-4 border border-white/10 shadow-glass relative overflow-hidden">
          <div class="absolute -top-10 -right-10 w-44 h-44 bg-violet/10 rounded-full blur-3xl"></div>

          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="text-lg font-extrabold ${done?'text-white line-through decoration-violet/40':'text-white'} truncate">${escapeHtml(t.title)}</div>
              <div class="mt-1 text-[12px] text-slate-400 font-medium">${escapeHtml(t.sub)}</div>
              <div class="mt-2 text-[11px] text-slate-400 font-semibold">本動作：${done?`-${pts}`:`+${pts}`} 分</div>
            </div>
            <button onclick="openDuration(${t.id})" class="glass2 border border-white/10 rounded-full px-3 py-2 text-[12px] font-bold text-slate-200 active:scale-95 transition-transform">
              ${t.minutes} min
            </button>
          </div>

          <div class="mt-4 flex items-center justify-between">
            <div class="text-4xl font-light tracking-tighter tabular-nums text-white ${running?'pulse-ring':''} px-2 py-1 rounded-2xl">
              ${time}
            </div>

            <div class="flex items-center gap-2">
              <button onclick="resetTimer('task', ${t.id})" class="glass2 border border-white/10 rounded-2xl px-3 py-2 text-[12px] font-bold text-slate-200 active:scale-95 transition-transform">
                重置
              </button>

              <button onclick="toggleDone('task', ${t.id})" class="glass2 border border-white/10 rounded-2xl px-3 py-2 text-[12px] font-extrabold ${done?'text-rose':'text-white'} active:scale-95 transition-transform">
                ${mainText}
              </button>

              <button onclick="toggleTimer('task', ${t.id})"
                      class="rounded-2xl px-4 py-2 text-[12px] font-extrabold border active:scale-95 transition-transform
                      ${done ? "bg-white/5 text-slate-400 border-white/10 cursor-not-allowed" :
                        (running ? "bg-white text-ink border-white" : "bg-gradient-to-r from-violet via-violet2 to-cyan text-white border-white/10")}"
                      ${done ? "disabled" : ""}>
                ${startText}
              </button>
            </div>
          </div>

          <button onclick="cancelTimer('task', ${t.id})"
                  class="mt-3 w-full glass2 border border-white/10 rounded-2xl py-2 text-[12px] font-bold text-slate-200 active:scale-95 transition-transform">
            取消（回到未完成）
          </button>

          <div class="mt-2 text-[11px] text-slate-500 font-semibold">
            你可以：計時 → 自動完成；也可直接「完成/取消完成」。避免誤觸：完成是切換鈕。
          </div>
        </div>`;
      }).join("");
    }

    function renderMind(){
      if(state.ui.view !== "mind") return;

      const key = activeKey();
      const day = ensureDay(key);
      const c = computeCompletion(day);

      document.getElementById("mind-date").textContent = (key===todayKey()) ? "Today" : formatKey(key);
      document.getElementById("mind-completion").textContent = c.percent;

      // inputs
      const growth = document.getElementById("growth-input");
      const brand = document.getElementById("brand-input");
      const scripture = document.getElementById("scripture-input");
      const spirit = document.getElementById("spirit-input");
      if(growth) growth.value = day.mind.growth || "";
      if(brand) brand.value = day.mind.brand || "";
      if(scripture) scripture.value = day.spirit.scripture || "";
      if(spirit) spirit.value = day.spirit.note || "";

      // timer displays
      document.getElementById("reading-min").textContent = day.reading.minutes;
      document.getElementById("reading-display").textContent = tickLabel(day.reading.remainingSec);
      document.getElementById("reading-start").textContent = day.reading.running ? "暫停" : "開始";
      document.getElementById("reading-done-btn").textContent = day.reading.done ? "取消完成" : "完成";

      document.getElementById("devotion-min").textContent = day.devotion.minutes;
      document.getElementById("devotion-display").textContent = tickLabel(day.devotion.remainingSec);
      document.getElementById("devotion-start").textContent = day.devotion.running ? "暫停" : "開始";
      document.getElementById("devotion-done-btn").textContent = day.devotion.done ? "取消完成" : "完成";

      renderMindTabs();
      renderPointsHintsOnly();
    }

    function renderMindTabs(){
      const tab = state.ui.mindTab || "mind";
      const mind = document.getElementById("tab-mind");
      const spirit = document.getElementById("tab-spirit");
      const slider = document.getElementById("tab-slider");
      const btnMind = document.getElementById("tab-btn-mind");
      const btnSpirit = document.getElementById("tab-btn-spirit");

      const isMind = tab === "mind";
      mind.classList.toggle("hidden", !isMind);
      spirit.classList.toggle("hidden", isMind);
      slider.style.transform = isMind ? "translateX(0%)" : "translateX(100%)";
      btnMind.className = "flex-1 relative z-10 py-2.5 text-sm text-center rounded-full " + (isMind ? "font-extrabold text-white" : "font-semibold text-slate-300");
      btnSpirit.className = "flex-1 relative z-10 py-2.5 text-sm text-center rounded-full " + (!isMind ? "font-extrabold text-white" : "font-semibold text-slate-300");
    }

    function renderCalendar(){
      if(state.ui.view !== "calendar") return;

      const [yy, mm] = state.ui.calYM.split("-");
      const year = parseInt(yy,10);
      const month = parseInt(mm,10)-1;

      document.getElementById("cal-title").textContent = `${year}年 ${month+1}月`;

      const first = new Date(year, month, 1).getDay();
      const daysIn = new Date(year, month+1, 0).getDate();

      const grid = document.getElementById("cal-grid");
      let html = "";

      for(let i=0;i<first;i++) html += `<div class="aspect-square"></div>`;

      const today = todayKey();
      const selected = state.ui.selectedDate;

      for(let d=1; d<=daysIn; d++){
        const key = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const day = ensureDay(key);
        const c = computeCompletion(day);

        const isToday = key===today;
        const isSelected = key===selected;

        let cls = "aspect-square rounded-2xl flex flex-col items-center justify-center cursor-pointer border transition-all";
        if(isSelected){
          cls += " border-white bg-white/10 text-white";
        } else if(isToday){
          cls += " border-violet/40 bg-violet/15 text-white";
        } else if(c.perfect){
          cls += " border-transparent bg-gradient-to-br from-violet/45 to-cyan/25 text-white shadow-glow";
        } else {
          cls += " border-white/5 bg-white/0 text-slate-400 hover:bg-white/5";
        }

        const dot = (day.spirit.scripture.trim() || day.spirit.note.trim()) ? `<span class="w-1.5 h-1.5 rounded-full bg-gold shadow-gold mt-1"></span>` : "";

        html += `
          <div onclick="selectDate('${key}')" class="${cls}">
            <div class="text-sm font-extrabold">${d}</div>
            ${dot}
          </div>
        `;
      }

      grid.innerHTML = html;

      document.getElementById("cal-streak").textContent = computeStreak();

      const perfectCount = allPerfectCount();
      const prog = Math.min(perfectCount, 3);
      document.getElementById("reward-count").textContent = prog;
      document.getElementById("reward-bar").style.width = `${(prog/3)*100}%`;
      const btn = document.getElementById("reward-btn");
      if(prog>=3){
        btn.disabled = false;
        btn.className = "mt-4 w-full rounded-2xl py-3 text-sm font-extrabold bg-gradient-to-r from-gold via-gold2 to-gold text-ink shadow-gold active:scale-95 transition-transform";
        btn.textContent = "點擊領取獎勵";
        btn.onclick = ()=> toast("解鎖成功", "你已解鎖神祕獎勵（你可以自行定義：課程、休息日、禮物都可以）。");
      } else {
        btn.disabled = true;
        btn.className = "mt-4 w-full rounded-2xl py-3 text-sm font-extrabold bg-white/5 border border-white/10 text-slate-400 cursor-not-allowed";
        btn.textContent = "尚未解鎖";
        btn.onclick = null;
      }
    }

    function renderDetail(){
      if(state.ui.view !== "calendar") return;

      const key = state.ui.selectedDate || todayKey();
      const day = ensureDay(key);
      const c = computeCompletion(day);

      document.getElementById("detail-date").textContent = (key===todayKey()) ? "Today" : formatKey(key);
      document.getElementById("detail-percent").textContent = c.percent;
      document.getElementById("detail-perfect").textContent = c.perfect ? "是" : "否";
      document.getElementById("detail-perfect").className = c.perfect ? "text-lime font-extrabold" : "text-slate-300 font-extrabold";

      document.getElementById("detail-xp").textContent = c.xp;
      document.getElementById("detail-settled").textContent = day.settle?.settled ? "是" : "否";
      document.getElementById("detail-settled").className = day.settle?.settled ? "text-lime font-extrabold" : "text-slate-300 font-extrabold";

      document.getElementById("detail-water").textContent = day.waterMl;
      document.getElementById("detail-water-goal").textContent = day.waterGoalMl;
      document.getElementById("detail-bowel").textContent = day.bowelStatus;

      const lines = day.tasks.map(t=>{
        const done = t.done;
        const label = done ? `<span class="text-lime font-extrabold">完成</span>` : `<span class="text-slate-500 font-extrabold">未完成</span>`;
        return `<div class="flex items-center justify-between text-slate-200">
          <span class="font-semibold">${escapeHtml(t.title)}</span>${label}
        </div>`;
      }).join("");
      document.getElementById("detail-tasks").innerHTML = lines;

      document.getElementById("detail-reading").textContent = day.reading.done ? "完成" : "未完成";
      document.getElementById("detail-reading").className = day.reading.done ? "text-lime font-extrabold" : "text-slate-500 font-extrabold";

      document.getElementById("detail-growth").textContent = day.mind.growth.trim() || "(無)";
      document.getElementById("detail-brand").textContent = day.mind.brand.trim() || "(無)";

      document.getElementById("detail-devotion").textContent = day.devotion.done ? "完成" : "未完成";
      document.getElementById("detail-devotion").className = day.devotion.done ? "text-lime font-extrabold" : "text-slate-500 font-extrabold";

      document.getElementById("detail-scripture").textContent = day.spirit.scripture.trim() || "(無)";
      document.getElementById("detail-spirit").textContent = day.spirit.note.trim() || "(無)";
    }

    function renderCompletionOnly(){
      const day = ensureDay(activeKey());
      const c = computeCompletion(day);

      const ids = ["hub-completion","hub-body-score","body-completion","mind-completion"];
      ids.forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.textContent = c.percent;
      });

      const bar = document.getElementById("hub-body-bar");
      if(bar) bar.style.width = `${c.percent}%`;

      const est = document.getElementById("hub-xp-est");
      if(est) est.textContent = c.xp;

      const pc = document.getElementById("profile-completion");
      if(pc) pc.textContent = `${c.percent}%`;
      const px = document.getElementById("profile-xp-est");
      if(px) px.textContent = `+${c.xp} XP`;
      const ps = document.getElementById("profile-streak");
      if(ps) ps.textContent = `${computeStreak()} Days`;
    }

    function renderTimersOnly(){
      // update only visible timer displays
      const day = ensureDay(activeKey());

      // Body tasks timers
      if(state.ui.view==="body"){
        // re-rendering the whole list is simplest but might be heavy; keep it light: just call renderBody()
        renderBody();
      }

      // Mind timers displays
      if(state.ui.view==="mind"){
        const rd = document.getElementById("reading-display");
        if(rd) rd.textContent = tickLabel(day.reading.remainingSec);
        const dd = document.getElementById("devotion-display");
        if(dd) dd.textContent = tickLabel(day.devotion.remainingSec);
      }
    }

    function renderPointsHintsOnly(){
      const day = ensureDay(activeKey());
      // reading
      const rp = document.getElementById("reading-points");
      if(rp) rp.textContent = `+${POINTS.reading} / 0`;
      // devotion
      const dp = document.getElementById("devotion-points");
      if(dp) dp.textContent = `+${POINTS.devotion} / 0`;
      // growth/brand/scripture (these are completion by input)
      const gp = document.getElementById("growth-points");
      if(gp) gp.textContent = `+${POINTS.growth} / 0`;
      const bp = document.getElementById("brand-points");
      if(bp) bp.textContent = `+${POINTS.brand} / 0`;
      const sp = document.getElementById("scripture-points");
      if(sp) sp.textContent = `+${POINTS.scripture} / 0`;
    }

    /***********************
     * 13) HUB SETTLE / PROFILE OPEN
     ***********************/
    document.addEventListener("click", (e)=>{
      if(e.target && (e.target.id==="btn-profile" || e.target.closest("#btn-profile"))){
        document.getElementById("inp-name").value = state.profile.name || "";
        document.getElementById("inp-avatar").value = state.profile.avatar || "";
        document.getElementById("inp-title").value = state.profile.title || "";
        openModal("modal-profile");
      }
      if(e.target && (e.target.id==="btn-reset" || e.target.closest("#btn-reset"))){
        confirmReset();
      }
      if(e.target && (e.target.id==="btn-settle" || e.target.closest("#btn-settle"))){
        const k = activeKey();
        settleDay(k);
        renderAll();
        const day = ensureDay(k);
        toast("結算完成", `已寫入：${(k===todayKey())?'Today':k}（XP：+${day.settle.xpAwarded}）。`);
      }
    });

    /***********************
     * 14) INIT
     ***********************/
    ensureDay(todayKey());
    ensureDay(state.ui.selectedDate || todayKey());
    ensureDay(state.ui.activeDate || todayKey());

    if(!state.ui.view) state.ui.view = "hub";

    save();
    renderAll();
    startGlobalTick();
  </script>
</body>
</html>
