<!DOCTYPE html>
<html lang="zh-Hant" class="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>ATE - Aether Trinity Evolution</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300..700&display=swap" rel="stylesheet"/>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries,typography"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            obsidian: "#07070B",
            panel: "rgba(255,255,255,0.06)",
            panel2: "rgba(255,255,255,0.035)",
            stroke: "rgba(255,255,255,0.10)",
            stroke2: "rgba(255,255,255,0.08)",
            gold: "#D4AF37",
            gold2:"#F5E6A6",
            violet:"#8B5CF6",
            blue:"#60A5FA",
            rose:"#FB7185",
            mint:"#34D399",
            ink:"#0B0B10",
          },
          fontFamily: {
            display: ["Manrope","Noto Sans TC","system-ui","sans-serif"],
            body: ["Noto Sans TC","Manrope","system-ui","sans-serif"],
            serif: ["Noto Serif TC","serif"]
          },
          boxShadow: {
            glass: "0 18px 60px rgba(0,0,0,0.55)",
            glowGold: "0 0 22px rgba(212,175,55,0.25)",
            glowViolet: "0 0 26px rgba(139,92,246,0.22)",
          }
        }
      }
    }
  </script>

  <style>
    :root{ color-scheme: dark; }
    body{
      min-height: 100dvh;
      background: radial-gradient(1200px 520px at 20% -10%, rgba(139,92,246,0.22), transparent 60%),
                  radial-gradient(900px 520px at 100% 10%, rgba(96,165,250,0.18), transparent 55%),
                  radial-gradient(900px 520px at 70% 110%, rgba(212,175,55,0.14), transparent 55%),
                  #07070B;
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
    }
    .glass{
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .glass2{
      background: rgba(255,255,255,0.035);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .no-scrollbar::-webkit-scrollbar{ display:none; }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }

    .material-symbols-outlined{
      font-variation-settings: "FILL" 0, "wght" 420, "GRAD" 0, "opsz" 24;
    }
    .ms-fill{
      font-variation-settings: "FILL" 1, "wght" 520, "GRAD" 0, "opsz" 24;
    }

    /* Small XP toast */
    .xp-toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(92px + env(safe-area-inset-bottom));
      z-index: 60;
      pointer-events: none;
      opacity: 0;
      transition: opacity .18s ease, transform .18s ease;
    }
    .xp-toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-6px);
    }

    /* View handling */
    .view { display:none; }
    .view.active{ display:block; }

    /* Safer height for scrollable content */
    .app-shell{
      max-width: 430px;
      margin: 0 auto;
      min-height: 100dvh;
      padding-bottom: calc(96px + env(safe-area-inset-bottom));
    }
    .top-safe{
      padding-top: calc(14px + env(safe-area-inset-top));
    }

    /* Subtle shimmer line */
    .shimmer::after{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(115deg, transparent 0%, rgba(255,255,255,0.08) 45%, transparent 70%);
      transform: translateX(-120%);
      animation: shimmer 3.2s ease-in-out infinite;
      pointer-events:none;
      opacity:.55;
    }
    @keyframes shimmer{
      0%{ transform: translateX(-120%); }
      45%{ transform: translateX(120%); }
      100%{ transform: translateX(120%); }
    }
  </style>
</head>

<body class="text-slate-100 font-display">
  <div class="app-shell relative">

    <!-- ======= HEADER (shared) ======= -->
    <div class="top-safe px-5 pt-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="material-symbols-outlined text-[18px] text-gold ms-fill">workspace_premium</span>
          <span class="text-[11px] tracking-[0.22em] uppercase text-slate-400">ATE SYSTEM</span>
        </div>

        <button id="btn-reset" class="glass2 rounded-full px-3 py-1.5 text-[11px] font-semibold text-slate-200 active:scale-95 transition"
          title="系統重置">
          重置
        </button>
      </div>
    </div>

    <!-- ======= VIEWS ======= -->

    <!-- HUB -->
    <section id="view-hub" class="view active px-5 pt-4">
      <!-- Profile Hero -->
      <div class="relative glass rounded-3xl p-4 shadow-glass overflow-hidden">
        <div class="absolute inset-0 opacity-[0.35]"
             style="background:
               radial-gradient(500px 240px at 18% 10%, rgba(212,175,55,0.18), transparent 60%),
               radial-gradient(480px 240px at 90% 20%, rgba(139,92,246,0.18), transparent 55%),
               radial-gradient(460px 240px at 60% 120%, rgba(96,165,250,0.14), transparent 55%);">
        </div>

        <div class="relative flex items-start gap-4">
          <!-- Photo -->
          <div class="shrink-0">
            <div class="relative w-[74px] h-[74px] rounded-2xl overflow-hidden border border-white/10 bg-black/30">
              <img id="profile-photo" alt="Profile" class="w-full h-full object-cover" src="" />
              <div class="absolute inset-0 bg-gradient-to-t from-black/35 to-transparent"></div>
            </div>

            <!-- Upload -->
            <label class="mt-2 inline-flex items-center gap-1.5 text-[11px] text-slate-300/90 cursor-pointer select-none">
              <span class="material-symbols-outlined text-[16px] text-slate-300">upload</span>
              換照片
              <input id="photo-input" type="file" accept="image/*" class="hidden"/>
            </label>
          </div>

          <!-- Meta -->
          <div class="flex-1 min-w-0">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <input id="profile-name"
                       class="w-full bg-transparent border-none p-0 text-[20px] font-bold tracking-tight text-white placeholder:text-slate-500 focus:ring-0"
                       placeholder="輸入你的名字" />
                <div class="mt-1 flex items-center gap-2 text-[11px] text-slate-400">
                  <span id="profile-level-badge" class="inline-flex items-center gap-1 rounded-full px-2 py-1 glass2 border border-white/10">
                    <span class="material-symbols-outlined text-[14px] text-gold ms-fill">star</span>
                    <span class="font-semibold text-slate-200">Lv.</span>
                    <span id="profile-level" class="font-semibold text-slate-200">1</span>
                  </span>
                  <span class="opacity-70">•</span>
                  <span class="font-semibold">今日 XP</span>
                  <span id="profile-xp-today" class="text-gold font-bold">0</span>
                  <span class="opacity-70">/</span>
                  <span class="font-semibold">總 XP</span>
                  <span id="profile-xp-total" class="text-gold font-bold">0</span>
                </div>
              </div>

              <div class="text-right">
                <div class="text-[11px] text-slate-400">今日完成率</div>
                <div id="hub-completion" class="text-[20px] font-bold text-white leading-tight">0%</div>
              </div>
            </div>

            <!-- XP progress -->
            <div class="mt-3">
              <div class="flex justify-between text-[11px] text-slate-400">
                <span>距離下一級</span>
                <span class="text-slate-300">
                  <span id="xp-in-level">0</span> / <span id="xp-next">500</span>
                </span>
              </div>
              <div class="mt-2 h-2.5 rounded-full bg-white/5 border border-white/10 overflow-hidden">
                <div id="xp-bar" class="h-full w-[0%] bg-gradient-to-r from-gold via-gold2 to-violet shadow-glowGold"></div>
              </div>
            </div>

            <!-- Daily verse (English) -->
            <div class="mt-4 glass2 rounded-2xl p-3 border border-white/10">
              <div class="flex items-center justify-between">
                <div class="text-[11px] tracking-[0.18em] uppercase text-slate-400">Daily Verse</div>
                <div id="hub-date" class="text-[11px] text-slate-400"></div>
              </div>
              <div id="daily-verse" class="mt-2 text-[14px] leading-relaxed text-slate-100 font-serif"></div>
              <div id="daily-verse-ref" class="mt-2 text-[11px] text-gold font-semibold"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Overview Cards -->
      <div class="mt-4">
        <div class="flex items-center justify-between px-1">
          <h2 class="text-[15px] font-bold text-white tracking-wide">今日進化總覽</h2>
          <button id="btn-today" class="text-[11px] text-slate-300 glass2 px-3 py-1.5 rounded-full border border-white/10 active:scale-95 transition">
            回到今天
          </button>
        </div>

        <div class="mt-3 grid grid-cols-1 gap-3">
          <!-- Body -->
          <button id="hub-go-body" class="text-left glass2 rounded-2xl p-4 border border-white/10 active:scale-[0.99] transition">
            <div class="flex items-start justify-between">
              <div>
                <div class="text-[12px] text-slate-400">Body（身）</div>
                <div id="hub-body-pct" class="mt-1 text-[22px] font-bold text-white">0%</div>
              </div>
              <div class="w-10 h-10 rounded-xl bg-rose/10 border border-rose/25 flex items-center justify-center">
                <span class="material-symbols-outlined text-rose text-[20px]">fitness_center</span>
              </div>
            </div>
            <div class="mt-3 h-2 rounded-full bg-white/5 border border-white/10 overflow-hidden">
              <div id="hub-body-bar" class="h-full w-[0%] bg-rose/80"></div>
            </div>
          </button>

          <div class="grid grid-cols-2 gap-3">
            <!-- Mind -->
            <button id="hub-go-mind" class="text-left glass2 rounded-2xl p-4 border border-white/10 active:scale-[0.99] transition">
              <div class="flex items-start justify-between">
                <div>
                  <div class="text-[12px] text-slate-400">Mind（心）</div>
                  <div id="hub-mind-pct" class="mt-1 text-[18px] font-bold text-white">0%</div>
                </div>
                <div class="w-10 h-10 rounded-xl bg-violet/10 border border-violet/25 flex items-center justify-center">
                  <span class="material-symbols-outlined text-violet text-[20px]">psychology</span>
                </div>
              </div>
              <div class="mt-3 h-2 rounded-full bg-white/5 border border-white/10 overflow-hidden">
                <div id="hub-mind-bar" class="h-full w-[0%] bg-violet/80"></div>
              </div>
            </button>

            <!-- Calendar -->
            <button id="hub-go-calendar" class="text-left glass2 rounded-2xl p-4 border border-white/10 active:scale-[0.99] transition">
              <div class="flex items-start justify-between">
                <div>
                  <div class="text-[12px] text-slate-400">日曆</div>
                  <div class="mt-1 text-[18px] font-bold text-white">紀錄補填</div>
                </div>
                <div class="w-10 h-10 rounded-xl bg-gold/10 border border-gold/25 flex items-center justify-center">
                  <span class="material-symbols-outlined text-gold text-[20px]">calendar_month</span>
                </div>
              </div>
              <div class="mt-3 text-[11px] text-slate-400">點進去可切換日期、補漏填</div>
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- BODY -->
    <section id="view-body" class="view px-5 pt-4">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-[11px] tracking-[0.18em] uppercase text-slate-400">Body</div>
          <div class="text-[22px] font-bold text-white">身體進化</div>
        </div>
        <div id="body-date" class="glass2 rounded-full px-3 py-1.5 text-[11px] border border-white/10 text-slate-200"></div>
      </div>

      <!-- Water -->
      <div class="mt-4 glass rounded-3xl p-4 border border-white/10">
        <div class="flex items-start justify-between">
          <div>
            <div class="text-[12px] text-slate-400">水分攝入</div>
            <div class="mt-1 text-[18px] font-bold text-white">
              <span id="water-val">0</span><span class="text-slate-400 text-[13px] font-semibold ml-1">ml</span>
            </div>
            <div class="mt-1 text-[11px] text-slate-400">目標：<span id="water-target">1900</span> ml</div>
          </div>
          <div class="text-right">
            <div class="text-[11px] text-slate-400">此項 XP</div>
            <div id="water-xp" class="text-gold font-bold text-[16px]">0</div>
          </div>
        </div>

        <div class="mt-3 h-3 rounded-full bg-white/5 border border-white/10 overflow-hidden">
          <div id="water-bar" class="h-full w-[0%] bg-gradient-to-r from-blue via-violet to-gold"></div>
        </div>

        <div class="mt-3 grid grid-cols-3 gap-2">
          <button data-water="-250" class="btn-water glass2 rounded-2xl py-2.5 border border-white/10 active:scale-95 transition text-[12px] font-semibold text-slate-200">
            -250
          </button>
          <button data-water="250" class="btn-water glass2 rounded-2xl py-2.5 border border-white/10 active:scale-95 transition text-[12px] font-semibold text-slate-200">
            +250
          </button>
          <button data-water="500" class="btn-water glass2 rounded-2xl py-2.5 border border-white/10 active:scale-95 transition text-[12px] font-semibold text-slate-200">
            +500
          </button>
        </div>
        <div class="mt-2 text-[11px] text-slate-400">（分數依比例增減，不會無限累加）</div>
      </div>

      <!-- Tasks -->
      <div class="mt-4">
        <div class="flex items-center justify-between px-1">
          <div class="text-[15px] font-bold text-white">今日任務</div>
          <div class="text-[11px] text-slate-400">點一下完成／取消</div>
        </div>
        <div id="task-list" class="mt-3 space-y-2"></div>
      </div>

      <!-- Bowel -->
      <div class="mt-3 glass2 rounded-2xl p-4 border border-white/10">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-[12px] text-slate-300 font-semibold">排便確認</div>
            <div class="text-[11px] text-slate-400">此項可反覆開關，但分數會正確倒扣</div>
          </div>
          <label class="relative inline-flex items-center cursor-pointer select-none">
            <input id="bowel-toggle" type="checkbox" class="sr-only peer"/>
            <div class="w-14 h-8 bg-white/10 border border-white/10 rounded-full peer peer-checked:bg-mint/30 peer-checked:border-mint/40 transition"></div>
            <div class="absolute left-1 top-1 w-6 h-6 rounded-full bg-white/40 peer-checked:translate-x-6 peer-checked:bg-white transition-transform"></div>
          </label>
        </div>
        <div class="mt-2 text-[11px] text-slate-400">此項 XP：<span id="bowel-xp" class="text-gold font-bold">0</span></div>
      </div>
    </section>

    <!-- MIND -->
    <section id="view-mind" class="view px-5 pt-4">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-[11px] tracking-[0.18em] uppercase text-slate-400">Mind & Spirit</div>
          <div class="text-[22px] font-bold text-white">心智與靈魂</div>
        </div>
        <div id="mind-date" class="glass2 rounded-full px-3 py-1.5 text-[11px] border border-white/10 text-slate-200"></div>
      </div>

      <!-- Tabs -->
      <div class="mt-4 glass2 rounded-full p-1 border border-white/10">
        <div class="grid grid-cols-2 gap-1">
          <button id="tab-btn-mind" class="tab-btn rounded-full py-2.5 text-[12px] font-bold text-white bg-white/10">心智</button>
          <button id="tab-btn-spirit" class="tab-btn rounded-full py-2.5 text-[12px] font-semibold text-slate-400">靈魂</button>
        </div>
      </div>

      <!-- Tab: Mind -->
      <div id="tab-mind" class="mt-4 space-y-3">
        <!-- Reading Timer -->
        <div class="glass rounded-3xl p-4 border border-white/10">
          <div class="flex items-start justify-between">
            <div>
              <div class="text-[12px] text-slate-400">深度閱讀</div>
              <div id="read-display" class="mt-1 text-[32px] font-light tracking-tight tabular-nums">20:00</div>
              <div class="text-[11px] text-slate-400">可計時 / 也可直接完成（可取消）</div>
            </div>
            <div class="text-right">
              <div class="text-[11px] text-slate-400">此項 XP</div>
              <div id="read-xp" class="text-gold font-bold text-[16px]">0</div>
            </div>
          </div>

          <div class="mt-3 grid grid-cols-3 gap-2">
            <button id="read-start" class="glass2 rounded-2xl py-2.5 border border-white/10 active:scale-95 transition text-[12px] font-semibold text-slate-200">
              開始
            </button>
            <button id="read-reset" class="glass2 rounded-2xl py-2.5 border border-white/10 active:scale-95 transition text-[12px] font-semibold text-slate-200">
              重置
            </button>
            <button id="read-done" class="glass2 rounded-2xl py-2.5 border border-white/10 active:scale-95 transition text-[12px] font-semibold text-slate-200">
              完成/取消
            </button>
          </div>
        </div>

        <!-- Growth Reflection -->
        <div class="glass2 rounded-3xl p-4 border border-white/10">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-[12px] text-slate-300 font-semibold">今日復盤</div>
              <div class="text-[11px] text-slate-400">輸入後自動保存（支援語音）</div>
            </div>
            <div class="text-right text-[11px] text-slate-400">此項 XP：<span id="growth-xp" class="text-gold font-bold">0</span></div>
          </div>
          <div class="mt-3 relative">
            <textarea id="growth-note" class="w-full h-28 rounded-2xl bg-black/25 border border-white/10 text-slate-100 placeholder:text-slate-500 p-3 focus:ring-0 focus:outline-none text-[14px] leading-relaxed"
              placeholder="寫下今天的洞察…（中/英/粵混講也可以錄）"></textarea>
            <button id="growth-mic" class="hidden absolute right-3 bottom-3 glass2 border border-white/10 rounded-full px-3 py-1.5 text-[11px] text-slate-200 active:scale-95 transition">
              <span class="material-symbols-outlined text-[16px] align-[-3px]">mic</span> 語音
            </button>
          </div>
        </div>

        <!-- Brand Strategy -->
        <div class="glass2 rounded-3xl p-4 border border-white/10">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-[12px] text-slate-300 font-semibold">品牌筆記</div>
              <div class="text-[11px] text-slate-400">輸入後自動保存（支援語音）</div>
            </div>
            <div class="text-right text-[11px] text-slate-400">此項 XP：<span id="brand-xp" class="text-gold font-bold">0</span></div>
          </div>
          <div class="mt-3 relative">
            <textarea id="brand-note" class="w-full h-28 rounded-2xl bg-black/25 border border-white/10 text-slate-100 placeholder:text-slate-500 p-3 focus:ring-0 focus:outline-none text-[14px] leading-relaxed"
              placeholder="紀錄策略想法…"></textarea>
            <button id="brand-mic" class="hidden absolute right-3 bottom-3 glass2 border border-white/10 rounded-full px-3 py-1.5 text-[11px] text-slate-200 active:scale-95 transition">
              <span class="material-symbols-outlined text-[16px] align-[-3px]">mic</span> 語音
            </button>
          </div>
        </div>
      </div>

      <!-- Tab: Spirit -->
      <div id="tab-spirit" class="mt-4 space-y-3 hidden">
        <!-- Silent Devotion Timer -->
        <div class="glass rounded-3xl p-4 border border-white/10">
          <div class="flex items-start justify-between">
            <div>
              <div class="text-[12px] text-slate-400">靜默靈修（無音樂）</div>
              <div id="dev-display" class="mt-1 text-[32px] font-light tracking-tight tabular-nums">10:00</div>
              <div class="text-[11px] text-slate-400">可自由倒數 / 也可直接完成（可取消）</div>
            </div>
            <div class="text-right">
              <div class="text-[11px] text-slate-400">此項 XP</div>
              <div id="dev-xp" class="text-gold font-bold text-[16px]">0</div>
            </div>
          </div>
          <div class="mt-3 grid grid-cols-3 gap-2">
            <button id="dev-start" class="glass2 rounded-2xl py-2.5 border border-white/10 active:scale-95 transition text-[12px] font-semibold text-slate-200">開始</button>
            <button id="dev-reset" class="glass2 rounded-2xl py-2.5 border border-white/10 active:scale-95 transition text-[12px] font-semibold text-slate-200">重置</button>
            <button id="dev-done" class="glass2 rounded-2xl py-2.5 border border-white/10 active:scale-95 transition text-[12px] font-semibold text-slate-200">完成/取消</button>
          </div>
        </div>

        <!-- Scripture -->
        <div class="glass2 rounded-3xl p-4 border border-white/10">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-[12px] text-slate-300 font-semibold">經文出處</div>
              <div class="text-[11px] text-slate-400">輸入後自動保存</div>
            </div>
            <div class="text-right text-[11px] text-slate-400">此項 XP：<span id="scripture-xp" class="text-gold font-bold">0</span></div>
          </div>
          <input id="scripture" class="mt-3 w-full rounded-2xl bg-black/25 border border-white/10 text-slate-100 placeholder:text-slate-500 px-3 py-3 focus:ring-0 focus:outline-none text-[14px]"
                 placeholder="例如：Psalm 23:1 / 詩篇 23:1"/>
        </div>

        <!-- Spirit Note -->
        <div class="glass2 rounded-3xl p-4 border border-white/10">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-[12px] text-slate-300 font-semibold">領受筆記</div>
              <div class="text-[11px] text-slate-400">輸入後自動保存（支援語音）</div>
            </div>
            <div class="text-right text-[11px] text-slate-400">此項 XP：<span id="spirit-xp" class="text-gold font-bold">0</span></div>
          </div>
          <div class="mt-3 relative">
            <textarea id="spirit-note" class="w-full h-28 rounded-2xl bg-black/25 border border-white/10 text-slate-100 placeholder:text-slate-500 p-3 focus:ring-0 focus:outline-none text-[14px] leading-relaxed"
              placeholder="記錄領受、祈禱…（中/英/粵混講也可以錄）"></textarea>
            <button id="spirit-mic" class="hidden absolute right-3 bottom-3 glass2 border border-white/10 rounded-full px-3 py-1.5 text-[11px] text-slate-200 active:scale-95 transition">
              <span class="material-symbols-outlined text-[16px] align-[-3px]">mic</span> 語音
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- CALENDAR -->
    <section id="view-calendar" class="view px-5 pt-4">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-[11px] tracking-[0.18em] uppercase text-slate-400">Calendar</div>
          <div class="text-[22px] font-bold text-white">進化日曆</div>
        </div>
        <div id="cal-selected" class="glass2 rounded-full px-3 py-1.5 text-[11px] border border-white/10 text-slate-200"></div>
      </div>

      <!-- Month Header -->
      <div class="mt-4 glass rounded-3xl p-4 border border-white/10">
        <div class="flex items-center justify-between">
          <button id="cal-prev" class="glass2 rounded-2xl w-10 h-10 border border-white/10 active:scale-95 transition flex items-center justify-center">
            <span class="material-symbols-outlined">chevron_left</span>
          </button>
          <div class="text-center">
            <div id="cal-month" class="text-[16px] font-bold text-white tracking-wide"></div>
            <div class="text-[11px] text-slate-400 mt-0.5">點日期可切換，方便補填</div>
          </div>
          <button id="cal-next" class="glass2 rounded-2xl w-10 h-10 border border-white/10 active:scale-95 transition flex items-center justify-center">
            <span class="material-symbols-outlined">chevron_right</span>
          </button>
        </div>

        <div class="mt-4 grid grid-cols-7 text-center text-[11px] text-slate-400">
          <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
        </div>

        <div id="cal-grid" class="mt-2 grid grid-cols-7 gap-1"></div>

        <div class="mt-3 flex items-center justify-between text-[11px] text-slate-400">
          <div class="flex items-center gap-2">
            <span class="inline-block w-2.5 h-2.5 rounded bg-white/10 border border-white/10"></span>一般
            <span class="inline-block w-2.5 h-2.5 rounded bg-gold/25 border border-gold/40 ml-3"></span>70%+
            <span class="inline-block w-2.5 h-2.5 rounded bg-violet/25 border border-violet/40 ml-3"></span>完美(100%)
          </div>
          <button id="cal-jump-today" class="glass2 px-3 py-1.5 rounded-full border border-white/10 active:scale-95 transition text-slate-200">今天</button>
        </div>
      </div>

      <!-- Day Summary -->
      <div class="mt-4 glass2 rounded-3xl p-4 border border-white/10">
        <div class="flex items-start justify-between">
          <div>
            <div class="text-[12px] text-slate-400">當天摘要（分類列點）</div>
            <div id="day-sum-title" class="mt-1 text-[16px] font-bold text-white"></div>
          </div>
          <div class="text-right">
            <div class="text-[11px] text-slate-400">完成率</div>
            <div id="day-sum-pct" class="text-[18px] font-bold text-white">0%</div>
          </div>
        </div>

        <div class="mt-3 grid grid-cols-3 gap-2">
          <button id="day-edit-body" class="glass2 rounded-2xl py-2 border border-white/10 active:scale-95 transition text-[12px] font-semibold text-slate-200">補填 身</button>
          <button id="day-edit-mind" class="glass2 rounded-2xl py-2 border border-white/10 active:scale-95 transition text-[12px] font-semibold text-slate-200">補填 心</button>
          <button id="day-edit-spirit" class="glass2 rounded-2xl py-2 border border-white/10 active:scale-95 transition text-[12px] font-semibold text-slate-200">補填 靈</button>
        </div>

        <div class="mt-4 space-y-3 text-[13px]">
          <div class="glass2 rounded-2xl p-3 border border-white/10">
            <div class="text-[12px] text-slate-300 font-semibold">Body</div>
            <ul id="sum-body" class="mt-2 space-y-1 text-slate-200"></ul>
          </div>
          <div class="glass2 rounded-2xl p-3 border border-white/10">
            <div class="text-[12px] text-slate-300 font-semibold">Mind</div>
            <ul id="sum-mind" class="mt-2 space-y-1 text-slate-200"></ul>
          </div>
          <div class="glass2 rounded-2xl p-3 border border-white/10">
            <div class="text-[12px] text-slate-300 font-semibold">Spirit</div>
            <ul id="sum-spirit" class="mt-2 space-y-1 text-slate-200"></ul>
          </div>
        </div>
      </div>
    </section>

    <!-- ======= BOTTOM NAV ======= -->
    <nav class="fixed left-0 right-0 bottom-0 z-50">
      <div class="mx-auto max-w-[430px] px-4 pb-[calc(14px+env(safe-area-inset-bottom))] pt-3">
        <div class="glass rounded-full border border-white/10 shadow-glass px-5 py-3 flex justify-between items-center">
          <button class="nav-btn flex flex-col items-center justify-center w-16" data-view="hub">
            <span class="material-symbols-outlined text-[22px] ms-fill text-gold" id="nav-ico-hub">grid_view</span>
            <span class="text-[11px] font-bold text-white" id="nav-txt-hub">Hub</span>
          </button>
          <button class="nav-btn flex flex-col items-center justify-center w-16 opacity-70" data-view="body">
            <span class="material-symbols-outlined text-[22px] text-slate-300" id="nav-ico-body">fitness_center</span>
            <span class="text-[11px] font-semibold text-slate-300" id="nav-txt-body">身</span>
          </button>
          <button class="nav-btn flex flex-col items-center justify-center w-16 opacity-70" data-view="mind">
            <span class="material-symbols-outlined text-[22px] text-slate-300" id="nav-ico-mind">psychology</span>
            <span class="text-[11px] font-semibold text-slate-300" id="nav-txt-mind">心/靈</span>
          </button>
          <button class="nav-btn flex flex-col items-center justify-center w-16 opacity-70" data-view="calendar">
            <span class="material-symbols-outlined text-[22px] text-slate-300" id="nav-ico-calendar">calendar_month</span>
            <span class="text-[11px] font-semibold text-slate-300" id="nav-txt-calendar">日曆</span>
          </button>
        </div>
      </div>
    </nav>

  </div>

  <!-- XP toast -->
  <div id="xp-toast" class="xp-toast">
    <div class="glass2 border border-white/10 rounded-full px-4 py-2 text-[12px] font-bold text-white shadow-glass">
      <span id="xp-toast-text">+0 XP</span>
    </div>
  </div>

  <script>
    /**********************
     * CONFIG
     **********************/
    const STORAGE_KEY = "ate_mobile_v11_cn_fixed";
    const WATER_TARGET = 1900;

    // Task definition (Body)
    const TASKS = [
      { id: "squat15", type: "timer", title: "深蹲練習", subtitle: "15 分鐘", seconds: 15*60, xp: 15 },
      { id: "muscle30", type: "timer", title: "每日肌肉訓練", subtitle: "30 分鐘", seconds: 30*60, xp: 30 },
      { id: "yogurt", type: "check", title: "DIAAS 酸奶早餐", subtitle: "完成即可", xp: 10 },
    ];

    // Mind & Spirit items scoring
    const XP_RULES = {
      waterMax: 40,     // proportional 0..40
      bowel: 5,         // on/off
      reading: 10,      // done/undone
      growth: 5,        // has text
      brand: 5,         // has text
      devotion: 10,     // done/undone
      scripture: 5,     // has text
      spirit: 5,        // has text
      bonus70: 20       // once per day when crossing >=70%
    };

    // English daily verses (short, safe length)
    const VERSES = [
      { t:"Be strong and courageous. Do not be afraid; do not be discouraged, for the Lord your God will be with you wherever you go.", r:"Joshua 1:9" },
      { t:"The Lord is my shepherd; I shall not want.", r:"Psalm 23:1" },
      { t:"I can do all things through Christ who strengthens me.", r:"Philippians 4:13" },
      { t:"Trust in the Lord with all your heart and lean not on your own understanding.", r:"Proverbs 3:5" },
      { t:"My grace is sufficient for you, for my power is made perfect in weakness.", r:"2 Corinthians 12:9" },
      { t:"Let all that you do be done in love.", r:"1 Corinthians 16:14" },
      { t:"Do not be anxious about anything… and the peace of God… will guard your hearts and your minds.", r:"Philippians 4:6–7" },
      { t:"For we walk by faith, not by sight.", r:"2 Corinthians 5:7" },
    ];

    /**********************
     * STATE
     **********************/
    let state = loadState();
    let selectedDateKey = state.ui?.selectedDateKey || todayKey();
    let calView = new Date(); // month view
    calView.setDate(1);

    // runtime timers (intervals only)
    const runtime = {
      taskIntervals: {},
      readInterval: null,
      devInterval: null,
      speech: { active: false, target: null, recognizer: null }
    };

    /**********************
     * UTIL
     **********************/
    function todayKey(){
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    }
    function ensureDay(key){
      state.days ||= {};
      if(!state.days[key]){
        state.days[key] = {
          water: 0,
          bowel: false,
          tasks: {}, // taskId -> { done:boolean, remaining:number, status:"idle|running|paused|done" }
          mind: {
            reading: { done:false, remaining: 20*60, status:"idle" },
            growthNote: "",
            brandNote: "",
          },
          spirit: {
            devotion: { done:false, remaining: 10*60, status:"idle" },
            scripture: "",
            spiritNote: "",
          },
          bonus70Claimed: false
        };
        // init tasks
        TASKS.forEach(t=>{
          if(!state.days[key].tasks[t.id]){
            state.days[key].tasks[t.id] = {
              done:false,
              remaining: t.type==="timer" ? t.seconds : 0,
              status:"idle"
            }
          }
        });
      } else {
        // backfill for new tasks
        TASKS.forEach(t=>{
          state.days[key].tasks ||= {};
          if(!state.days[key].tasks[t.id]){
            state.days[key].tasks[t.id] = { done:false, remaining: t.type==="timer"?t.seconds:0, status:"idle" };
          }
        });
        // ensure nested
        state.days[key].mind ||= { reading:{done:false, remaining:20*60, status:"idle"}, growthNote:"", brandNote:"" };
        state.days[key].mind.reading ||= { done:false, remaining:20*60, status:"idle" };
        state.days[key].spirit ||= { devotion:{done:false, remaining:10*60, status:"idle"}, scripture:"", spiritNote:"" };
        state.days[key].spirit.devotion ||= { done:false, remaining:10*60, status:"idle" };
      }
      return state.days[key];
    }
    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){
          const parsed = JSON.parse(raw);
          // ensure structure
          parsed.profile ||= { name:"", photoDataUrl:"", totalXp:0, level:1 };
          parsed.days ||= {};
          parsed.ui ||= {};
          return parsed;
        }
      }catch(e){}
      return { profile:{ name:"", photoDataUrl:"", totalXp:0, level:1 }, days:{}, ui:{} };
    }
    function saveState(){
      state.ui ||= {};
      state.ui.selectedDateKey = selectedDateKey;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }
    function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
    function fmtMMSS(sec){
      sec = Math.max(0, Math.floor(sec));
      const m = Math.floor(sec/60), s = sec%60;
      return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    }
    function hashStrToInt(s){
      let h = 2166136261;
      for(let i=0;i<s.length;i++){
        h ^= s.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h>>>0);
    }
    function pickVerseForDate(key){
      const idx = hashStrToInt(key) % VERSES.length;
      return VERSES[idx];
    }
    function showXpToast(delta){
      const el = document.getElementById("xp-toast");
      const txt = document.getElementById("xp-toast-text");
      const sign = delta>=0 ? "+" : "";
      txt.textContent = `${sign}${delta} XP`;
      el.classList.add("show");
      clearTimeout(el._t);
      el._t = setTimeout(()=>el.classList.remove("show"), 750);
    }

    /**********************
     * SCORING (NO INFINITE ACCUMULATION)
     * - All XP derived from current state (reversible).
     **********************/
    function calcDayXp(key){
      const d = ensureDay(key);
      let xp = 0;

      // Water proportional (0..waterMax)
      const waterRatio = clamp(d.water / WATER_TARGET, 0, 1);
      xp += Math.round(waterRatio * XP_RULES.waterMax);

      // Tasks
      TASKS.forEach(t=>{
        const st = d.tasks[t.id];
        if(st?.done) xp += t.xp;
      });

      // Bowel
      if(d.bowel) xp += XP_RULES.bowel;

      // Mind
      if(d.mind.reading?.done) xp += XP_RULES.reading;
      if((d.mind.growthNote||"").trim().length>0) xp += XP_RULES.growth;
      if((d.mind.brandNote||"").trim().length>0) xp += XP_RULES.brand;

      // Spirit
      if(d.spirit.devotion?.done) xp += XP_RULES.devotion;
      if((d.spirit.scripture||"").trim().length>0) xp += XP_RULES.scripture;
      if((d.spirit.spiritNote||"").trim().length>0) xp += XP_RULES.spirit;

      // Bonus 70 (once/day)
      if(d.bonus70Claimed) xp += XP_RULES.bonus70;

      return xp;
    }

    function calcCompletion(key){
      const d = ensureDay(key);

      // Weighted completion by items (same as XP components but normalized)
      // Define 9 core items:
      // Water, Task1, Task2, Task3, Bowel, Reading, Growth, Devotion, Scripture/SpiritNote(1 slot)
      let done = 0, total = 9;

      // Water counts if >= target
      if(d.water >= WATER_TARGET) done += 1;

      // Tasks
      done += (d.tasks[TASKS[0].id]?.done ? 1:0);
      done += (d.tasks[TASKS[1].id]?.done ? 1:0);
      done += (d.tasks[TASKS[2].id]?.done ? 1:0);

      // Bowel
      done += (d.bowel ? 1:0);

      // Reading
      done += (d.mind.reading?.done ? 1:0);

      // Growth note
      done += ((d.mind.growthNote||"").trim().length>0 ? 1:0);

      // Devotion
      done += (d.spirit.devotion?.done ? 1:0);

      // Scripture/spirit note slot: if either exists counts
      done += (((d.spirit.scripture||"").trim().length>0 || (d.spirit.spiritNote||"").trim().length>0) ? 1:0);

      const pct = Math.round((done/total)*100);
      return { done, total, pct };
    }

    function recalcTotalsAndLevel(){
      // total XP = sum all days' XP
      let total = 0;
      for(const k of Object.keys(state.days||{})){
        total += calcDayXp(k);
      }
      state.profile.totalXp = total;

      // Level: 500 XP per level
      const lvl = Math.floor(total / 500) + 1;
      state.profile.level = lvl;
      saveState();
    }

    function maybeClaimBonus70(key){
      const d = ensureDay(key);
      const { pct } = calcCompletion(key);
      if(pct >= 70 && !d.bonus70Claimed){
        d.bonus70Claimed = true;
        // small excitement
        showXpToast(XP_RULES.bonus70);
      }
      // if user later drops below 70, we keep bonus claimed as "reward once/day"
    }

    /**********************
     * NAV / VIEW
     **********************/
    function setActiveView(view){
      document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
      document.getElementById(`view-${view}`).classList.add("active");

      // nav highlight
      ["hub","body","mind","calendar"].forEach(id=>{
        const ico = document.getElementById(`nav-ico-${id}`);
        const txt = document.getElementById(`nav-txt-${id}`);
        const btn = document.querySelector(`.nav-btn[data-view="${id}"]`);
        if(id===view){
          btn.classList.remove("opacity-70");
          ico.classList.add("ms-fill");
          ico.classList.remove("text-slate-300");
          ico.classList.add("text-gold");
          txt.classList.add("text-white","font-bold");
          txt.classList.remove("text-slate-300","font-semibold");
        }else{
          btn.classList.add("opacity-70");
          ico.classList.remove("ms-fill");
          ico.classList.add("text-slate-300");
          ico.classList.remove("text-gold");
          txt.classList.remove("text-white","font-bold");
          txt.classList.add("text-slate-300","font-semibold");
        }
      });

      // refresh view-specific
      updateUI();
    }

    /**********************
     * PROFILE (BUGFIX: name save & photo upload freeze)
     **********************/
    function initProfile(){
      const nameInput = document.getElementById("profile-name");
      const photo = document.getElementById("profile-photo");
      const photoInput = document.getElementById("photo-input");

      nameInput.value = state.profile.name || "";
      nameInput.addEventListener("input", ()=>{
        state.profile.name = nameInput.value;
        saveState(); // immediate save
      });

      // load photo
      if(state.profile.photoDataUrl){
        photo.src = state.profile.photoDataUrl;
      }else{
        // elegant fallback
        photo.src = "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`
          <svg xmlns="http://www.w3.org/2000/svg" width="300" height="300">
            <defs>
              <linearGradient id="g" x1="0" x2="1">
                <stop offset="0" stop-color="#D4AF37" stop-opacity="0.55"/>
                <stop offset="0.5" stop-color="#8B5CF6" stop-opacity="0.45"/>
                <stop offset="1" stop-color="#60A5FA" stop-opacity="0.45"/>
              </linearGradient>
            </defs>
            <rect width="300" height="300" fill="#0B0B10"/>
            <circle cx="95" cy="90" r="120" fill="url(#g)" opacity="0.55"/>
            <circle cx="230" cy="220" r="140" fill="url(#g)" opacity="0.35"/>
          </svg>
        `);
      }

      photoInput.addEventListener("change", async (e)=>{
        const file = e.target.files && e.target.files[0];
        if(!file) return;

        try{
          // prevent "whole page stuck": async read + downscale
          const dataUrl = await fileToDownscaledDataUrl(file, 360);
          state.profile.photoDataUrl = dataUrl;
          saveState();

          // set src last (avoid large decode blocking)
          requestAnimationFrame(()=>{
            photo.src = dataUrl;
          });

          // reset input
          photoInput.value = "";
        }catch(err){
          alert("照片處理失敗，請換一張較小的照片再試一次。");
          photoInput.value = "";
        }
      });
    }

    function fileToDownscaledDataUrl(file, maxSize=360){
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onerror = ()=>reject(new Error("read error"));
        reader.onload = ()=>{
          const img = new Image();
          img.onload = ()=>{
            try{
              const w = img.width, h = img.height;
              const scale = Math.min(1, maxSize / Math.max(w,h));
              const nw = Math.max(1, Math.round(w*scale));
              const nh = Math.max(1, Math.round(h*scale));
              const canvas = document.createElement("canvas");
              canvas.width = nw;
              canvas.height = nh;
              const ctx = canvas.getContext("2d", { alpha:false });
              ctx.imageSmoothingEnabled = true;
              ctx.imageSmoothingQuality = "high";
              ctx.drawImage(img, 0, 0, nw, nh);

              // jpeg compression to reduce localStorage size & lag
              const out = canvas.toDataURL("image/jpeg", 0.82);
              resolve(out);
            }catch(e){ reject(e); }
          };
          img.onerror = ()=>reject(new Error("img decode error"));
          img.src = reader.result;
        };
        reader.readAsDataURL(file);
      });
    }

    /**********************
     * BODY ACTIONS
     **********************/
    function modifyWater(delta){
      const d = ensureDay(selectedDateKey);
      const beforeXp = calcDayXp(selectedDateKey);
      d.water = clamp(d.water + delta, 0, 10000);
      maybeClaimBonus70(selectedDateKey);
      const afterXp = calcDayXp(selectedDateKey);
      const diff = afterXp - beforeXp;
      recalcTotalsAndLevel();
      if(diff!==0) showXpToast(diff);
      saveState();
      updateUI();
    }

    function toggleBowel(){
      const d = ensureDay(selectedDateKey);
      const beforeXp = calcDayXp(selectedDateKey);
      d.bowel = !d.bowel;
      maybeClaimBonus70(selectedDateKey);
      const afterXp = calcDayXp(selectedDateKey);
      const diff = afterXp - beforeXp;
      recalcTotalsAndLevel();
      if(diff!==0) showXpToast(diff);
      saveState();
      updateUI();
    }

    function setTaskDone(taskId, done){
      const d = ensureDay(selectedDateKey);
      const beforeXp = calcDayXp(selectedDateKey);

      const def = TASKS.find(t=>t.id===taskId);
      const st = d.tasks[taskId];

      if(done){
        st.done = true;
        st.status = "done";
        if(def.type==="timer") st.remaining = 0;
        stopTaskInterval(taskId);
      }else{
        st.done = false;
        st.status = "idle";
        if(def.type==="timer") st.remaining = def.seconds;
        stopTaskInterval(taskId);
      }

      maybeClaimBonus70(selectedDateKey);
      const afterXp = calcDayXp(selectedDateKey);
      const diff = afterXp - beforeXp;
      recalcTotalsAndLevel();
      if(diff!==0) showXpToast(diff);
      saveState();
      updateUI();
    }

    function stopTaskInterval(taskId){
      if(runtime.taskIntervals[taskId]){
        clearInterval(runtime.taskIntervals[taskId]);
        runtime.taskIntervals[taskId] = null;
      }
    }

    function toggleTaskTimer(taskId){
      const d = ensureDay(selectedDateKey);
      const def = TASKS.find(t=>t.id===taskId);
      const st = d.tasks[taskId];
      if(!def || def.type!=="timer") return;
      if(st.done) return;

      // start / pause
      if(st.status==="running"){
        st.status = "paused";
        stopTaskInterval(taskId);
        saveState();
        updateUI();
        return;
      }

      // resume/start
      st.status = "running";
      stopTaskInterval(taskId);
      runtime.taskIntervals[taskId] = setInterval(()=>{
        // guard for date switch
        const dd = ensureDay(selectedDateKey);
        const sst = dd.tasks[taskId];
        if(!sst || sst.done){ stopTaskInterval(taskId); return; }
        if(sst.status!=="running"){ stopTaskInterval(taskId); return; }

        sst.remaining = Math.max(0, (sst.remaining||0) - 1);
        // direct DOM update for smooth
        const el = document.getElementById(`task-time-${taskId}`);
        if(el) el.textContent = fmtMMSS(sst.remaining);

        if(sst.remaining<=0){
          stopTaskInterval(taskId);
          setTaskDone(taskId, true);
        }else{
          saveState();
        }
      }, 1000);

      saveState();
      updateUI();
    }

    function resetTaskTimer(taskId){
      const d = ensureDay(selectedDateKey);
      const def = TASKS.find(t=>t.id===taskId);
      const st = d.tasks[taskId];
      if(!def || def.type!=="timer") return;

      // reset doesn't change XP unless it cancels done (handled elsewhere)
      st.status = "idle";
      st.remaining = def.seconds;
      stopTaskInterval(taskId);
      saveState();
      updateUI();
    }

    /**********************
     * MIND: Reading
     **********************/
    function stopReadInterval(){
      if(runtime.readInterval){ clearInterval(runtime.readInterval); runtime.readInterval=null; }
    }
    function toggleReadingTimer(){
      const d = ensureDay(selectedDateKey);
      const r = d.mind.reading;
      if(r.done) return;

      if(r.status==="running"){
        r.status="paused";
        stopReadInterval();
        saveState(); updateUI(); return;
      }

      r.status="running";
      stopReadInterval();
      runtime.readInterval = setInterval(()=>{
        const dd = ensureDay(selectedDateKey);
        const rr = dd.mind.reading;
        if(!rr || rr.done){ stopReadInterval(); return; }
        if(rr.status!=="running"){ stopReadInterval(); return; }

        rr.remaining = Math.max(0, (rr.remaining||0) - 1);
        const el = document.getElementById("read-display");
        if(el) el.textContent = fmtMMSS(rr.remaining);

        if(rr.remaining<=0){
          stopReadInterval();
          rr.status="done";
          rr.done=true;
          // XP update
          const before = calcDayXp(selectedDateKey);
          maybeClaimBonus70(selectedDateKey);
          const after = calcDayXp(selectedDateKey);
          const diff = after - before;
          recalcTotalsAndLevel();
          if(diff!==0) showXpToast(diff);
          saveState();
          updateUI();
        }else{
          saveState();
        }
      }, 1000);

      saveState(); updateUI();
    }
    function resetReading(){
      const d = ensureDay(selectedDateKey);
      d.mind.reading.status="idle";
      d.mind.reading.remaining = 20*60;
      stopReadInterval();
      saveState(); updateUI();
    }
    function toggleReadingDone(){
      const d = ensureDay(selectedDateKey);
      const before = calcDayXp(selectedDateKey);

      const r = d.mind.reading;
      if(r.done){
        // cancel
        r.done=false;
        r.status="idle";
        r.remaining = 20*60;
      }else{
        // complete
        r.done=true;
        r.status="done";
        r.remaining = 0;
        stopReadInterval();
      }

      maybeClaimBonus70(selectedDateKey);
      const after = calcDayXp(selectedDateKey);
      const diff = after - before;
      recalcTotalsAndLevel();
      if(diff!==0) showXpToast(diff);
      saveState(); updateUI();
    }

    /**********************
     * SPIRIT: Devotion (silent)
     **********************/
    function stopDevInterval(){
      if(runtime.devInterval){ clearInterval(runtime.devInterval); runtime.devInterval=null; }
    }
    function toggleDevTimer(){
      const d = ensureDay(selectedDateKey);
      const dv = d.spirit.devotion;
      if(dv.done) return;

      if(dv.status==="running"){
        dv.status="paused";
        stopDevInterval();
        saveState(); updateUI(); return;
      }

      dv.status="running";
      stopDevInterval();
      runtime.devInterval = setInterval(()=>{
        const dd = ensureDay(selectedDateKey);
        const vv = dd.spirit.devotion;
        if(!vv || vv.done){ stopDevInterval(); return; }
        if(vv.status!=="running"){ stopDevInterval(); return; }

        vv.remaining = Math.max(0, (vv.remaining||0) - 1);
        const el = document.getElementById("dev-display");
        if(el) el.textContent = fmtMMSS(vv.remaining);

        if(vv.remaining<=0){
          stopDevInterval();
          vv.status="done";
          vv.done=true;

          const before = calcDayXp(selectedDateKey);
          maybeClaimBonus70(selectedDateKey);
          const after = calcDayXp(selectedDateKey);
          const diff = after - before;
          recalcTotalsAndLevel();
          if(diff!==0) showXpToast(diff);
          saveState();
          updateUI();
        }else{
          saveState();
        }
      }, 1000);

      saveState(); updateUI();
    }
    function resetDevotion(){
      const d = ensureDay(selectedDateKey);
      d.spirit.devotion.status="idle";
      d.spirit.devotion.remaining = 10*60;
      stopDevInterval();
      saveState(); updateUI();
    }
    function toggleDevDone(){
      const d = ensureDay(selectedDateKey);
      const before = calcDayXp(selectedDateKey);

      const dv = d.spirit.devotion;
      if(dv.done){
        dv.done=false;
        dv.status="idle";
        dv.remaining = 10*60;
      }else{
        dv.done=true;
        dv.status="done";
        dv.remaining = 0;
        stopDevInterval();
      }

      maybeClaimBonus70(selectedDateKey);
      const after = calcDayXp(selectedDateKey);
      const diff = after - before;
      recalcTotalsAndLevel();
      if(diff!==0) showXpToast(diff);
      saveState(); updateUI();
    }

    /**********************
     * NOTES SAVE
     **********************/
    function bindAutosave(){
      const growth = document.getElementById("growth-note");
      const brand = document.getElementById("brand-note");
      const scripture = document.getElementById("scripture");
      const spirit = document.getElementById("spirit-note");

      function attach(el, path){
        el.addEventListener("input", ()=>{
          const before = calcDayXp(selectedDateKey);
          const d = ensureDay(selectedDateKey);

          // set value
          const [a,b] = path;
          d[a][b] = el.value;

          maybeClaimBonus70(selectedDateKey);
          const after = calcDayXp(selectedDateKey);
          const diff = after - before;
          recalcTotalsAndLevel();
          if(diff!==0) showXpToast(diff);

          saveState();
          updateUI(); // keep XP labels current
        });
      }

      attach(growth, ["mind","growthNote"]);
      attach(brand, ["mind","brandNote"]);
      scripture.addEventListener("input", ()=>{
        const before = calcDayXp(selectedDateKey);
        const d = ensureDay(selectedDateKey);
        d.spirit.scripture = scripture.value;

        maybeClaimBonus70(selectedDateKey);
        const after = calcDayXp(selectedDateKey);
        const diff = after - before;
        recalcTotalsAndLevel();
        if(diff!==0) showXpToast(diff);

        saveState();
        updateUI();
      });
      attach(spirit, ["spirit","spiritNote"]);
    }

    /**********************
     * VOICE TO TEXT (optional)
     **********************/
    function initSpeech(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR) return;

      function mkRecognizer(){
        const rec = new SR();
        rec.continuous = true;
        rec.interimResults = true;

        // Mixed-language best-effort: prefer zh-HK (covers Cantonese + Chinese), but users can speak English inside.
        rec.lang = "zh-HK";

        rec.onresult = (event)=>{
          if(!runtime.speech.target) return;
          let finalText = "";
          for(let i=event.resultIndex;i<event.results.length;i++){
            const r = event.results[i];
            if(r.isFinal) finalText += r[0].transcript;
          }
          if(finalText){
            const el = runtime.speech.target;
            el.value = (el.value ? (el.value + (el.value.endsWith("\n")?"":"\n")) : "") + finalText.trim();
            el.dispatchEvent(new Event("input", { bubbles:true }));
          }
        };
        rec.onerror = ()=>{ stopSpeech(); };
        rec.onend = ()=>{ runtime.speech.active=false; };
        return rec;
      }

      function startSpeech(targetEl){
        stopSpeech();
        runtime.speech.target = targetEl;
        runtime.speech.recognizer = mkRecognizer();
        runtime.speech.active = true;
        try{ runtime.speech.recognizer.start(); }catch(e){}
      }
      function stopSpeech(){
        if(runtime.speech.recognizer){
          try{ runtime.speech.recognizer.stop(); }catch(e){}
        }
        runtime.speech.active=false;
        runtime.speech.target=null;
        runtime.speech.recognizer=null;
      }
      window._startSpeech = startSpeech;
      window._stopSpeech = stopSpeech;

      // show mic buttons
      const growthMic = document.getElementById("growth-mic");
      const brandMic = document.getElementById("brand-mic");
      const spiritMic = document.getElementById("spirit-mic");
      [growthMic,brandMic,spiritMic].forEach(b=>b.classList.remove("hidden"));

      growthMic.addEventListener("click", ()=>{
        const t = document.getElementById("growth-note");
        if(runtime.speech.active){ stopSpeech(); } else { startSpeech(t); }
        growthMic.innerHTML = runtime.speech.active ? '<span class="material-symbols-outlined text-[16px] align-[-3px]">stop_circle</span> 停止' : '<span class="material-symbols-outlined text-[16px] align-[-3px]">mic</span> 語音';
      });
      brandMic.addEventListener("click", ()=>{
        const t = document.getElementById("brand-note");
        if(runtime.speech.active){ stopSpeech(); } else { startSpeech(t); }
        brandMic.innerHTML = runtime.speech.active ? '<span class="material-symbols-outlined text-[16px] align-[-3px]">stop_circle</span> 停止' : '<span class="material-symbols-outlined text-[16px] align-[-3px]">mic</span> 語音';
      });
      spiritMic.addEventListener("click", ()=>{
        const t = document.getElementById("spirit-note");
        if(runtime.speech.active){ stopSpeech(); } else { startSpeech(t); }
        spiritMic.innerHTML = runtime.speech.active ? '<span class="material-symbols-outlined text-[16px] align-[-3px]">stop_circle</span> 停止' : '<span class="material-symbols-outlined text-[16px] align-[-3px]">mic</span> 語音';
      });
    }

    /**********************
     * CALENDAR
     **********************/
    function monthTitle(d){
      const y = d.getFullYear();
      const m = d.getMonth()+1;
      return `${y} 年 ${m} 月`;
    }
    function renderCalendar(){
      const grid = document.getElementById("cal-grid");
      const monthEl = document.getElementById("cal-month");
      monthEl.textContent = monthTitle(calView);

      const year = calView.getFullYear();
      const month = calView.getMonth();

      const first = new Date(year, month, 1);
      const startDay = first.getDay();
      const daysInMonth = new Date(year, month+1, 0).getDate();

      let html = "";

      // leading blanks
      for(let i=0;i<startDay;i++){
        html += `<div class="aspect-square"></div>`;
      }

      for(let day=1; day<=daysInMonth; day++){
        const key = `${year}-${String(month+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
        ensureDay(key);

        const { pct } = calcCompletion(key);
        const isSelected = key === selectedDateKey;
        const isToday = key === todayKey();

        let cls = "aspect-square rounded-xl border text-[12px] flex items-center justify-center cursor-pointer select-none transition active:scale-95 ";
        let dot = "";

        if(pct>=100){
          cls += "bg-violet/20 border-violet/40 text-white shadow-[0_0_14px_rgba(139,92,246,0.20)] ";
        }else if(pct>=70){
          cls += "bg-gold/15 border-gold/40 text-white shadow-[0_0_14px_rgba(212,175,55,0.14)] ";
        }else{
          cls += "bg-white/5 border-white/10 text-slate-300 hover:bg-white/10 ";
        }

        if(isToday) cls += " ring-1 ring-white/30 ";
        if(isSelected) cls += " outline outline-2 outline-white/40 ";

        if(pct>=70) dot = `<span class="absolute bottom-1.5 w-1.5 h-1.5 rounded-full ${pct>=100?'bg-violet':'bg-gold'}"></span>`;

        html += `
          <div class="relative ${cls}" data-date="${key}">
            <span class="font-semibold">${day}</span>
            ${dot}
          </div>
        `;
      }

      grid.innerHTML = html;

      // click
      grid.querySelectorAll("[data-date]").forEach(cell=>{
        cell.addEventListener("click", ()=>{
          selectDate(cell.getAttribute("data-date"));
        });
      });

      // selected label
      document.getElementById("cal-selected").textContent = selectedDateKey;
    }

    function selectDate(key){
      selectedDateKey = key;
      ensureDay(key);

      // stop intervals to avoid cross-date confusion
      Object.keys(runtime.taskIntervals).forEach(stopTaskInterval);
      stopReadInterval();
      stopDevInterval();

      saveState();
      updateUI();
      renderCalendar();
    }

    /**********************
     * RENDER TASKS (show +/- XP in each item)
     **********************/
    function renderTasks(){
      const list = document.getElementById("task-list");
      const d = ensureDay(selectedDateKey);
      let html = "";

      TASKS.forEach(def=>{
        const st = d.tasks[def.id];
        const xpText = `+${def.xp} XP`;
        const done = !!st.done;

        if(def.type==="check"){
          html += `
            <div class="glass2 rounded-2xl p-4 border border-white/10 flex items-center justify-between gap-3 ${done?'ring-1 ring-gold/30':''}" data-task="${def.id}">
              <div class="min-w-0">
                <div class="flex items-center gap-2">
                  <div class="text-[14px] font-bold text-white truncate ${done?'line-through decoration-gold/50':''}">${def.title}</div>
                  <span class="text-[11px] font-bold text-gold">${xpText}</span>
                </div>
                <div class="text-[11px] text-slate-400 mt-1">${def.subtitle}</div>
              </div>
              <button class="task-toggle glass2 border border-white/10 rounded-full px-3 py-2 text-[12px] font-bold text-slate-200 active:scale-95 transition">
                ${done ? "取消" : "完成"}
              </button>
            </div>
          `;
        }else{
          const time = fmtMMSS(st.remaining ?? def.seconds);
          const running = st.status==="running";
          const btnMain = done ? "已完成" : (running ? "暫停" : (st.status==="paused" ? "繼續" : "開始"));

          html += `
            <div class="glass2 rounded-2xl p-4 border border-white/10 ${done?'ring-1 ring-violet/30':''}" data-task="${def.id}">
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <div class="flex items-center gap-2">
                    <div class="text-[14px] font-bold text-white truncate ${done?'line-through decoration-violet/50':''}">${def.title}</div>
                    <span class="text-[11px] font-bold text-gold">${xpText}</span>
                  </div>
                  <div class="text-[11px] text-slate-400 mt-1">${def.subtitle}</div>
                </div>
                <div class="text-right">
                  <div id="task-time-${def.id}" class="text-[18px] font-mono tabular-nums text-white/90">${time}</div>
                  <div class="text-[11px] text-slate-400">${done ? "點卡片可取消" : ""}</div>
                </div>
              </div>

              <div class="mt-3 grid grid-cols-3 gap-2">
                <button class="task-main glass2 border border-white/10 rounded-2xl py-2 text-[12px] font-bold text-slate-200 active:scale-95 transition">
                  ${btnMain}
                </button>
                <button class="task-reset glass2 border border-white/10 rounded-2xl py-2 text-[12px] font-semibold text-slate-200 active:scale-95 transition">
                  重置
                </button>
                <button class="task-done glass2 border border-white/10 rounded-2xl py-2 text-[12px] font-semibold text-slate-200 active:scale-95 transition">
                  完成/取消
                </button>
              </div>
            </div>
          `;
        }
      });

      list.innerHTML = html;

      // bind events
      list.querySelectorAll("[data-task]").forEach(card=>{
        const id = card.getAttribute("data-task");
        const def = TASKS.find(t=>t.id===id);
        const d = ensureDay(selectedDateKey);
        const st = d.tasks[id];

        if(def.type==="check"){
          const btn = card.querySelector(".task-toggle");
          card.addEventListener("click", (e)=>{
            if(e.target.closest("button")) return;
            setTaskDone(id, !st.done);
          });
          btn.addEventListener("click", (e)=>{
            e.stopPropagation();
            setTaskDone(id, !st.done);
          });
        }else{
          const main = card.querySelector(".task-main");
          const reset = card.querySelector(".task-reset");
          const done = card.querySelector(".task-done");

          // tapping card when done -> cancel
          card.addEventListener("click", (e)=>{
            if(e.target.closest("button")) return;
            if(st.done) setTaskDone(id, false);
          });

          main.addEventListener("click", (e)=>{
            e.stopPropagation();
            if(st.done){
              setTaskDone(id, false);
              return;
            }
            toggleTaskTimer(id);
          });

          reset.addEventListener("click", (e)=>{
            e.stopPropagation();
            if(st.done){
              // reset + cancel
              setTaskDone(id, false);
              return;
            }
            resetTaskTimer(id);
          });

          done.addEventListener("click", (e)=>{
            e.stopPropagation();
            if(st.done){
              setTaskDone(id, false);
            }else{
              setTaskDone(id, true);
            }
          });
        }
      });
    }

    /**********************
     * SUMMARY (bullet + categories)
     **********************/
    function renderDaySummary(){
      const d = ensureDay(selectedDateKey);
      const { pct } = calcCompletion(selectedDateKey);

      document.getElementById("day-sum-title").textContent = `${selectedDateKey} 摘要`;
      document.getElementById("day-sum-pct").textContent = `${pct}%`;

      // lists
      const ulBody = document.getElementById("sum-body");
      const ulMind = document.getElementById("sum-mind");
      const ulSpirit = document.getElementById("sum-spirit");

      function li(label, ok, extra=""){
        const c = ok ? "text-gold" : "text-slate-500";
        const mark = ok ? "●" : "○";
        const ex = extra ? ` <span class="text-slate-400 text-[12px]">(${extra})</span>` : "";
        return `<li class="flex items-start justify-between gap-3">
                  <div class="min-w-0">
                    <span class="${c} font-bold mr-2">${mark}</span>
                    <span class="text-slate-200">${label}</span>${ex}
                  </div>
                  <span class="text-[12px] ${c} font-bold">${ok ? "完成" : "未完成"}</span>
                </li>`;
      }

      // Body
      const waterOk = d.water >= WATER_TARGET;
      const t1 = d.tasks[TASKS[0].id]?.done;
      const t2 = d.tasks[TASKS[1].id]?.done;
      const t3 = d.tasks[TASKS[2].id]?.done;

      ulBody.innerHTML =
        li("水分達標", waterOk, `${d.water} / ${WATER_TARGET} ml`) +
        li(TASKS[0].title, !!t1, TASKS[0].subtitle) +
        li(TASKS[1].title, !!t2, TASKS[1].subtitle) +
        li(TASKS[2].title, !!t3, TASKS[2].subtitle) +
        li("排便確認", !!d.bowel, `+${XP_RULES.bowel} XP`);

      // Mind
      ulMind.innerHTML =
        li("深度閱讀", !!d.mind.reading?.done, `+${XP_RULES.reading} XP`) +
        li("今日復盤", (d.mind.growthNote||"").trim().length>0, `+${XP_RULES.growth} XP`) +
        li("品牌筆記", (d.mind.brandNote||"").trim().length>0, `+${XP_RULES.brand} XP`);

      // Spirit
      ulSpirit.innerHTML =
        li("靜默靈修", !!d.spirit.devotion?.done, `+${XP_RULES.devotion} XP`) +
        li("經文出處", (d.spirit.scripture||"").trim().length>0, `+${XP_RULES.scripture} XP`) +
        li("領受筆記", (d.spirit.spiritNote||"").trim().length>0, `+${XP_RULES.spirit} XP`);
    }

    /**********************
     * UI UPDATE
     **********************/
    function updateUI(){
      ensureDay(selectedDateKey);

      // Hub date + verse
      document.getElementById("hub-date").textContent = selectedDateKey;
      const v = pickVerseForDate(selectedDateKey);
      document.getElementById("daily-verse").textContent = `“${v.t}”`;
      document.getElementById("daily-verse-ref").textContent = v.r;

      // Profile XP + level
      recalcTotalsAndLevel();
      const dayXp = calcDayXp(selectedDateKey);
      document.getElementById("profile-xp-today").textContent = dayXp;
      document.getElementById("profile-xp-total").textContent = state.profile.totalXp;
      document.getElementById("profile-level").textContent = state.profile.level;

      // Level progress bar
      const inLevel = state.profile.totalXp % 500;
      document.getElementById("xp-in-level").textContent = inLevel;
      document.getElementById("xp-next").textContent = 500;
      document.getElementById("xp-bar").style.width = `${Math.round((inLevel/500)*100)}%`;

      // Hub completion
      const comp = calcCompletion(selectedDateKey);
      document.getElementById("hub-completion").textContent = `${comp.pct}%`;

      // per section completion (quick)
      const d = ensureDay(selectedDateKey);

      // Body pct: water + 3 tasks + bowel = 5 items
      let bodyDone = 0;
      if(d.water>=WATER_TARGET) bodyDone++;
      TASKS.forEach(t=>{ if(d.tasks[t.id]?.done) bodyDone++; });
      if(d.bowel) bodyDone++;
      const bodyPct = Math.round((bodyDone/5)*100);

      document.getElementById("hub-body-pct").textContent = `${bodyPct}%`;
      document.getElementById("hub-body-bar").style.width = `${bodyPct}%`;

      // Mind pct: reading + growth + brand = 3
      let mindDone = 0;
      if(d.mind.reading?.done) mindDone++;
      if((d.mind.growthNote||"").trim().length>0) mindDone++;
      if((d.mind.brandNote||"").trim().length>0) mindDone++;
      const mindPct = Math.round((mindDone/3)*100);
      document.getElementById("hub-mind-pct").textContent = `${mindPct}%`;
      document.getElementById("hub-mind-bar").style.width = `${mindPct}%`;

      // Body view
      document.getElementById("body-date").textContent = selectedDateKey;
      document.getElementById("mind-date").textContent = selectedDateKey;

      document.getElementById("water-val").textContent = d.water;
      document.getElementById("water-target").textContent = WATER_TARGET;
      const wPct = Math.min(100, Math.round((d.water/WATER_TARGET)*100));
      document.getElementById("water-bar").style.width = `${wPct}%`;
      document.getElementById("water-xp").textContent = Math.round(clamp(d.water/WATER_TARGET,0,1) * XP_RULES.waterMax);

      const bowelToggle = document.getElementById("bowel-toggle");
      bowelToggle.checked = !!d.bowel;
      document.getElementById("bowel-xp").textContent = d.bowel ? XP_RULES.bowel : 0;

      // Render tasks
      renderTasks();

      // Mind inputs
      const r = d.mind.reading;
      document.getElementById("read-display").textContent = fmtMMSS(r.remaining ?? 20*60);
      document.getElementById("read-xp").textContent = r.done ? XP_RULES.reading : 0;
      document.getElementById("growth-note").value = d.mind.growthNote || "";
      document.getElementById("brand-note").value = d.mind.brandNote || "";
      document.getElementById("growth-xp").textContent = (d.mind.growthNote||"").trim().length>0 ? XP_RULES.growth : 0;
      document.getElementById("brand-xp").textContent = (d.mind.brandNote||"").trim().length>0 ? XP_RULES.brand : 0;

      // Spirit
      const dv = d.spirit.devotion;
      document.getElementById("dev-display").textContent = fmtMMSS(dv.remaining ?? 10*60);
      document.getElementById("dev-xp").textContent = dv.done ? XP_RULES.devotion : 0;
      document.getElementById("scripture").value = d.spirit.scripture || "";
      document.getElementById("spirit-note").value = d.spirit.spiritNote || "";
      document.getElementById("scripture-xp").textContent = (d.spirit.scripture||"").trim().length>0 ? XP_RULES.scripture : 0;
      document.getElementById("spirit-xp").textContent = (d.spirit.spiritNote||"").trim().length>0 ? XP_RULES.spirit : 0;

      // Calendar summary
      document.getElementById("cal-selected").textContent = selectedDateKey;
      renderDaySummary();

      // If calendar view open, keep grid updated
      if(document.getElementById("view-calendar").classList.contains("active")){
        renderCalendar();
      }
    }

    /**********************
     * TABS (Mind/Spirit)
     **********************/
    function setMindTab(tab){
      const btnMind = document.getElementById("tab-btn-mind");
      const btnSpirit = document.getElementById("tab-btn-spirit");
      const mind = document.getElementById("tab-mind");
      const spirit = document.getElementById("tab-spirit");

      if(tab==="mind"){
        mind.classList.remove("hidden");
        spirit.classList.add("hidden");
        btnMind.classList.add("bg-white/10","text-white","font-bold");
        btnMind.classList.remove("text-slate-400","font-semibold");
        btnSpirit.classList.remove("bg-white/10","text-white","font-bold");
        btnSpirit.classList.add("text-slate-400","font-semibold");
      }else{
        mind.classList.add("hidden");
        spirit.classList.remove("hidden");
        btnSpirit.classList.add("bg-white/10","text-white","font-bold");
        btnSpirit.classList.remove("text-slate-400","font-semibold");
        btnMind.classList.remove("bg-white/10","text-white","font-bold");
        btnMind.classList.add("text-slate-400","font-semibold");
      }
    }

    /**********************
     * RESET
     **********************/
    function confirmReset(){
      if(confirm("【系統重置】確定要清除所有紀錄並從 0 開始嗎？")){
        // stop timers
        Object.keys(runtime.taskIntervals).forEach(stopTaskInterval);
        stopReadInterval();
        stopDevInterval();
        try{
          localStorage.removeItem(STORAGE_KEY);
        }catch(e){}
        location.reload();
      }
    }

    /**********************
     * INIT BINDINGS
     **********************/
    function bindUI(){
      // nav
      document.querySelectorAll(".nav-btn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const v = btn.getAttribute("data-view");
          setActiveView(v);
        });
      });

      // hub quick links
      document.getElementById("hub-go-body").addEventListener("click", ()=>setActiveView("body"));
      document.getElementById("hub-go-mind").addEventListener("click", ()=>setActiveView("mind"));
      document.getElementById("hub-go-calendar").addEventListener("click", ()=>setActiveView("calendar"));

      // reset
      document.getElementById("btn-reset").addEventListener("click", confirmReset);

      // go today
      document.getElementById("btn-today").addEventListener("click", ()=>{
        selectDate(todayKey());
        setActiveView("hub");
      });

      // water buttons
      document.querySelectorAll(".btn-water").forEach(b=>{
        b.addEventListener("click", ()=>{
          const delta = parseInt(b.getAttribute("data-water"),10);
          modifyWater(delta);
        });
      });

      // bowel toggle
      document.getElementById("bowel-toggle").addEventListener("change", ()=>{
        toggleBowel();
      });

      // reading controls
      document.getElementById("read-start").addEventListener("click", ()=>{
        const d = ensureDay(selectedDateKey);
        const r = d.mind.reading;
        if(r.done) toggleReadingDone(); else toggleReadingTimer();
      });
      document.getElementById("read-reset").addEventListener("click", resetReading);
      document.getElementById("read-done").addEventListener("click", toggleReadingDone);

      // devotion controls
      document.getElementById("dev-start").addEventListener("click", ()=>{
        const d = ensureDay(selectedDateKey);
        const v = d.spirit.devotion;
        if(v.done) toggleDevDone(); else toggleDevTimer();
      });
      document.getElementById("dev-reset").addEventListener("click", resetDevotion);
      document.getElementById("dev-done").addEventListener("click", toggleDevDone);

      // tabs
      document.getElementById("tab-btn-mind").addEventListener("click", ()=>setMindTab("mind"));
      document.getElementById("tab-btn-spirit").addEventListener("click", ()=>setMindTab("spirit"));

      // calendar nav
      document.getElementById("cal-prev").addEventListener("click", ()=>{
        calView.setMonth(calView.getMonth()-1);
        renderCalendar();
      });
      document.getElementById("cal-next").addEventListener("click", ()=>{
        calView.setMonth(calView.getMonth()+1);
        renderCalendar();
      });
      document.getElementById("cal-jump-today").addEventListener("click", ()=>{
        // jump to current month and today
        const t = new Date();
        calView = new Date(t.getFullYear(), t.getMonth(), 1);
        selectDate(todayKey());
        renderCalendar();
      });

      // calendar "補填" shortcuts
      document.getElementById("day-edit-body").addEventListener("click", ()=>setActiveView("body"));
      document.getElementById("day-edit-mind").addEventListener("click", ()=>{ setActiveView("mind"); setMindTab("mind"); });
      document.getElementById("day-edit-spirit").addEventListener("click", ()=>{ setActiveView("mind"); setMindTab("spirit"); });

      bindAutosave();
      initSpeech();
    }

    /**********************
     * START
     **********************/
    (function boot(){
      ensureDay(selectedDateKey);

      // set initial calendar view to selected date month
      const [y,m] = selectedDateKey.split("-").map(n=>parseInt(n,10));
      if(y && m){
        calView = new Date(y, m-1, 1);
      }

      initProfile();
      bindUI();
      maybeClaimBonus70(selectedDateKey);
      recalcTotalsAndLevel();

      // initial render
      renderCalendar();
      updateUI();

      // default tab
      setMindTab("mind");
      // show selected date on hub
      document.getElementById("hub-date").textContent = selectedDateKey;
    })();
  </script>
</body>
</html>
