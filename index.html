<!DOCTYPE html>
<html lang="zh-Hant" class="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>ATE - Aether Trinity Evolution</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@200..700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            ink: "#05060A",
            obsidian: "#0B0D14",
            surface: "#0F1424",
            panel: "#121A2E",
            stroke: "rgba(255,255,255,0.10)",
            stroke2: "rgba(255,255,255,0.14)",
            gold: "#D4AF37",
            gold2: "#F4E09A",
            violet: "#8B5CF6",
            violet2: "#A78BFA",
            cyan: "#22D3EE",
            rose: "#FB7185",
            lime: "#A3E635",
          },
          fontFamily: {
            display: ["Manrope", "Noto Sans TC", "sans-serif"],
            body: ["Noto Sans TC", "Manrope", "sans-serif"],
          },
          boxShadow: {
            glass: "0 18px 60px rgba(0,0,0,0.35)",
            glow: "0 0 24px rgba(139,92,246,0.22)",
            gold: "0 0 24px rgba(212,175,55,0.20)",
          }
        }
      }
    }
  </script>

  <style>
    :root { color-scheme: dark; }
    body{
      min-height:100dvh;background:#05060A;-webkit-tap-highlight-color:transparent;overflow-x:hidden;
      font-family: Manrope, "Noto Sans TC", sans-serif;
    }
    .ms{font-family:'Material Symbols Outlined';font-variation-settings:'FILL' 0,'wght' 420,'GRAD' 0,'opsz' 24;}
    .ms.fill{font-variation-settings:'FILL' 1,'wght' 520,'GRAD' 0,'opsz' 24;}
    .glass{
      background:rgba(18,26,46,0.62);backdrop-filter:blur(18px);-webkit-backdrop-filter:blur(18px);
      border:1px solid rgba(255,255,255,0.10);
    }
    .glass2{
      background:linear-gradient(145deg, rgba(255,255,255,0.07) 0%, rgba(255,255,255,0.02) 100%);
      backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);
      border:1px solid rgba(255,255,255,0.10);
    }
    .no-scrollbar::-webkit-scrollbar{display:none;}
    .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none;}
    .fade-in{animation:fadeIn .22s ease-out;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}
    .pulse-ring{animation:pulseRing 1.7s infinite;}
    @keyframes pulseRing{
      0%{box-shadow:0 0 0 0 rgba(139,92,246,0.35);}
      70%{box-shadow:0 0 0 14px rgba(139,92,246,0);}
      100%{box-shadow:0 0 0 0 rgba(139,92,246,0);}
    }
    .toast{animation:toastIn .25s ease-out;}
    @keyframes toastIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
    .shimmer::before{
      content:"";position:absolute;inset:-40% -60%;
      background:linear-gradient(110deg, transparent 35%, rgba(255,255,255,0.10) 50%, transparent 65%);
      transform:translateX(-40%);animation:shimmer 2.4s infinite;pointer-events:none;
    }
    @keyframes shimmer{to{transform:translateX(40%);}}
    .chip{
      display:inline-flex;align-items:center;gap:.35rem;
      padding:.25rem .55rem;border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.04);
      font-size:11px;font-weight:700;color:rgba(226,232,240,0.95);
      letter-spacing:.08em;text-transform:uppercase;user-select:none;white-space:nowrap;
    }
    .chip .ms{font-size:16px;}
  </style>
</head>

<body class="bg-ink text-slate-100 selection:bg-violet selection:text-white">
  <!-- Ambient Background -->
  <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
    <div class="absolute -top-[18%] left-[15%] w-[95%] h-[55%] bg-violet/18 rounded-full blur-[130px]"></div>
    <div class="absolute -bottom-[18%] right-[-12%] w-[70%] h-[45%] bg-cyan/10 rounded-full blur-[120px]"></div>
    <div class="absolute inset-0 opacity-[0.045]" style="background-image:url('data:image/svg+xml,%3Csvg viewBox=%220 0 240 240%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cfilter id=%22n%22%3E%3CfeTurbulence type=%22fractalNoise%22 baseFrequency=%220.75%22 numOctaves=%223%22 stitchTiles=%22stitch%22/%3E%3C/filter%3E%3Crect width=%22100%25%22 height=%22100%25%22 filter=%22url(%23n)%22/%3E%3C/svg%3E');"></div>
  </div>

  <!-- App Frame -->
  <div class="relative z-10 mx-auto w-full max-w-md min-h-[100dvh] flex flex-col pb-24">
    <!-- HUB -->
    <section id="view-hub" class="flex flex-col flex-1 fade-in">
      <header class="pt-12 px-6 pb-4">
        <div class="glass rounded-3xl overflow-hidden shadow-glass">
          <div class="relative">
            <div class="h-24 w-full"
                 style="background:
                   radial-gradient(120% 160% at 12% 10%, rgba(212,175,55,0.28) 0%, rgba(212,175,55,0) 56%),
                   radial-gradient(120% 160% at 90% 35%, rgba(139,92,246,0.34) 0%, rgba(139,92,246,0) 55%),
                   linear-gradient(135deg, rgba(255,255,255,0.04) 0%, rgba(255,255,255,0.02) 100%);">
            </div>

            <div class="px-5 pt-4 pb-5">
              <div class="grid grid-cols-[72px_1fr_auto] gap-3 items-center">
                <button id="btn-profile" class="relative" title="打開個人設定">
                  <div class="h-16 w-16 rounded-full overflow-hidden border border-white/15 bg-surface shadow-glass">
                    <img id="profile-avatar" alt="avatar" class="h-full w-full object-cover" />
                  </div>
                  <div class="absolute -right-1 -bottom-1 glass2 rounded-full px-2 py-1 border border-white/10 shadow-glass">
                    <div class="flex items-center gap-1">
                      <span class="ms fill text-gold text-[16px]">workspace_premium</span>
                      <span id="profile-level-mini" class="text-[10px] text-slate-200 font-bold tracking-wide">LV 1</span>
                    </div>
                  </div>
                </button>

                <div class="min-w-0">
                  <div class="flex items-center gap-2 min-w-0">
                    <h1 id="profile-name" class="text-xl font-extrabold tracking-tight text-white leading-none truncate">覺醒女神</h1>
                    <span id="profile-badge" class="hidden text-[10px] px-2 py-1 rounded-full border border-gold/30 bg-gold/10 text-gold font-bold tracking-widest">ELITE</span>
                  </div>
                  <p id="profile-title" class="text-[11px] text-slate-400 font-medium tracking-wide mt-1 truncate">Aether Trinity Evolution</p>

                  <div class="mt-3 flex flex-wrap gap-2">
                    <span class="chip"><span class="ms fill text-violet2">percent</span><span id="profile-completion">0%</span></span>
                    <span class="chip"><span class="ms fill text-gold">bolt</span><span id="profile-xp-est">+0 XP</span></span>
                    <span class="chip"><span class="ms fill text-rose">local_fire_department</span><span id="profile-streak">0 Days</span></span>
                  </div>
                </div>

                <div class="flex flex-col items-end gap-2">
                  <button id="btn-reset" class="glass2 rounded-full px-3 py-2 border border-white/10 text-slate-200/90 hover:text-white active:scale-95 transition-transform"
                          title="系統重置">
                    <span class="ms text-[18px]">restart_alt</span>
                  </button>

                  <div id="profile-settled" class="text-[10px] text-slate-400 font-semibold">未結算</div>
                </div>
              </div>

              <div class="mt-4">
                <div class="flex items-center justify-between text-[11px] text-slate-300 font-medium">
                  <span class="tracking-widest uppercase text-slate-400">Current XP</span>
                  <span class="text-violet2 font-bold"><span id="hub-xp">0</span> / <span id="hub-xpmax">100</span></span>
                </div>
                <div class="mt-2 h-3 w-full rounded-full bg-white/5 border border-white/10 overflow-hidden">
                  <div id="hub-xpbar" class="h-full w-[0%] bg-gradient-to-r from-violet via-violet2 to-cyan shadow-glow rounded-full transition-all duration-500"></div>
                </div>
              </div>

              <!-- ✅ FIX: add hub completion element to prevent crash + show it -->
              <div class="mt-3 flex items-center justify-between text-[11px] text-slate-300 font-medium">
                <span class="tracking-widest uppercase text-slate-400">Today Completion</span>
                <span class="text-white font-extrabold"><span id="hub-completion">0</span>%</span>
              </div>

            </div>
          </div>
        </div>

        <div class="mt-5 glass2 rounded-3xl p-5 border border-white/10 shadow-glass relative overflow-hidden">
          <div class="absolute -top-10 -right-10 w-40 h-40 bg-gold/10 rounded-full blur-3xl"></div>
          <div class="flex items-center justify-between mb-2">
            <div class="text-[11px] tracking-[0.22em] uppercase text-slate-400 font-semibold">DAILY VERSE</div>
            <div class="text-[10px] text-gold font-bold tracking-widest">EN</div>
          </div>
          <div id="daily-verse" class="text-[15px] leading-relaxed text-white font-semibold"></div>
          <div id="daily-verse-ref" class="mt-2 text-[11px] text-slate-400 font-medium"></div>
        </div>
      </header>

      <main class="px-6 pb-6 flex-1 space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="text-base font-extrabold tracking-wide text-white">今日進化概覽</h2>
          <div class="flex items-center gap-2">
            <div class="glass2 px-3 py-1.5 rounded-full border border-white/10 text-[11px] text-slate-200 font-semibold">
              <span id="hub-date">Today</span>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 gap-4">
          <button onclick="navTo('body')" class="glass2 rounded-3xl p-5 border border-white/10 shadow-glass text-left active:scale-[0.99] transition-transform relative overflow-hidden">
            <div class="absolute -top-12 -right-12 w-48 h-48 bg-rose/10 rounded-full blur-3xl"></div>
            <div class="flex items-start justify-between">
              <div>
                <div class="text-[11px] tracking-widest uppercase text-slate-400 font-semibold">BODY</div>
                <div class="mt-1 text-lg font-extrabold text-white">身體進化</div>
                <div class="mt-2 text-[12px] text-slate-400 font-medium">水分 / 計時任務 / 排便</div>
              </div>
              <div class="text-right">
                <div class="text-2xl font-extrabold text-white"><span id="hub-body-score">0</span>%</div>
                <div class="text-[11px] text-slate-400 font-semibold">今日完成</div>
              </div>
            </div>
            <div class="mt-4 h-2 w-full rounded-full bg-white/5 border border-white/10 overflow-hidden">
              <div id="hub-body-bar" class="h-full w-[0%] bg-gradient-to-r from-rose via-violet2 to-cyan rounded-full transition-all duration-500"></div>
            </div>
          </button>

          <div class="grid grid-cols-2 gap-4">
            <button onclick="navTo('mind')" class="glass2 rounded-3xl p-5 border border-white/10 shadow-glass text-left active:scale-[0.99] transition-transform relative overflow-hidden">
              <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-violet/10 rounded-full blur-3xl"></div>
              <div class="text-[11px] tracking-widest uppercase text-slate-400 font-semibold">MIND & SPIRIT</div>
              <div class="mt-1 text-lg font-extrabold text-white">心智 / 靈修</div>
              <div class="mt-2 text-[12px] text-slate-400 font-medium">閱讀 / 反思 / 經文</div>
            </button>

            <button onclick="navTo('calendar')" class="glass2 rounded-3xl p-5 border border-white/10 shadow-glass text-left active:scale-[0.99] transition-transform relative overflow-hidden">
              <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-gold/10 rounded-full blur-3xl"></div>
              <div class="text-[11px] tracking-widest uppercase text-slate-400 font-semibold">HISTORY</div>
              <div class="mt-1 text-lg font-extrabold text-white">進化日曆</div>
              <div class="mt-2 text-[12px] text-slate-400 font-medium">補填 / 查看全部紀錄</div>
            </button>
          </div>
        </div>

        <button id="btn-settle" class="relative w-full rounded-2xl overflow-hidden shadow-glow border border-violet/25 active:scale-[0.99] transition-transform">
          <div class="absolute inset-0 bg-gradient-to-r from-violet/40 via-violet2/25 to-cyan/25"></div>
          <div class="absolute inset-0 opacity-30 shimmer"></div>
          <div class="relative px-5 py-4 flex items-center justify-between">
            <div>
              <div class="text-sm font-extrabold text-white">結算今天</div>
              <div class="text-[12px] text-slate-300 font-medium mt-0.5">可重算（會自動補回/倒扣差額）</div>
            </div>
            <div class="flex items-center gap-2">
              <div class="text-right">
                <div class="text-xs text-slate-300 font-semibold">預估</div>
                <div class="text-lg font-extrabold text-gold">+<span id="hub-xp-est">0</span> XP</div>
              </div>
              <span class="ms fill text-white text-[20px]">auto_awesome</span>
            </div>
          </div>
        </button>
      </main>
    </section>

    <!-- BODY VIEW -->
    <section id="view-body" class="hidden flex-col flex-1 fade-in">
      <header class="pt-10 px-4">
        <div class="flex items-center justify-between">
          <button onclick="navTo('hub')" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
            <span class="ms text-[18px]">chevron_left</span>
          </button>
          <div class="text-center">
            <div class="text-[11px] tracking-[0.22em] uppercase text-slate-400 font-semibold">AETHER TRINITY EVOLUTION</div>
            <div class="mt-1 text-2xl font-extrabold text-white">身體進化</div>
          </div>
          <button onclick="goToday()" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
            <span class="ms text-[18px]">today</span>
          </button>
        </div>

        <div class="mt-4 flex items-center justify-between">
          <div class="glass2 px-3 py-1.5 rounded-full border border-white/10 text-[11px] text-slate-200 font-semibold">
            <span id="body-date">Today</span>
          </div>
          <div class="glass2 px-3 py-1.5 rounded-full border border-white/10 text-[11px] text-slate-200 font-semibold">
            完成度 <span class="ml-2 text-white font-extrabold"><span id="body-completion">0</span>%</span>
          </div>
        </div>
      </header>

      <main class="px-4 pt-5 pb-6 flex-1 overflow-y-auto no-scrollbar space-y-5">
        <section class="glass rounded-3xl p-5 shadow-glass border border-white/10 relative overflow-hidden">
          <div class="absolute -top-10 -right-10 w-44 h-44 bg-cyan/10 rounded-full blur-3xl"></div>
          <div class="flex items-start justify-between">
            <div>
              <div class="text-[11px] tracking-widest uppercase text-slate-400 font-semibold">HYDRATION</div>
              <div class="mt-1 text-lg font-extrabold text-white">水分攝入</div>
              <div class="mt-2 text-[12px] text-slate-400 font-medium">
                目標：<span id="water-goal">1900</span> ml
              </div>
              <div class="mt-2 text-[11px] text-slate-400 font-semibold" id="water-points-hint">此區分數：0/25</div>
            </div>
            <div class="text-right">
              <div class="text-3xl font-extrabold text-white"><span id="water-val">0</span></div>
              <div class="text-[12px] text-slate-400 font-semibold">ml</div>
            </div>
          </div>

          <div class="mt-4 h-3 w-full rounded-full bg-white/5 border border-white/10 overflow-hidden">
            <div id="water-bar" class="h-full w-[0%] bg-gradient-to-r from-cyan via-violet2 to-gold rounded-full transition-all duration-500"></div>
          </div>

          <div class="mt-4 grid grid-cols-3 gap-2">
            <button onclick="modifyWater(-250)" class="glass2 border border-white/10 rounded-2xl py-3 font-bold text-slate-200 active:scale-95 transition-transform">-250</button>
            <button onclick="modifyWater(250)" class="glass2 border border-white/10 rounded-2xl py-3 font-bold text-white active:scale-95 transition-transform">+250</button>
            <button onclick="modifyWater(500)" class="relative overflow-hidden rounded-2xl py-3 font-extrabold text-ink bg-gradient-to-r from-gold via-gold2 to-gold shadow-gold active:scale-95 transition-transform">+500</button>
          </div>
        </section>

        <section class="space-y-3">
          <div class="flex items-center justify-between px-1">
            <div class="text-lg font-extrabold text-white">今日任務</div>
            <div class="text-[11px] text-slate-400 font-semibold">完成/取消都會計分</div>
          </div>
          <div id="task-list" class="space-y-3"></div>
        </section>

        <section class="glass rounded-3xl p-5 shadow-glass border border-white/10">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-[11px] tracking-widest uppercase text-slate-400 font-semibold">HEALTH</div>
              <div class="mt-1 text-lg font-extrabold text-white">排便狀況</div>
              <div class="mt-2 text-[11px] text-slate-400 font-semibold">本項分數：<span id="bowel-points">+10 / 0</span></div>
            </div>

            <div class="flex items-center gap-2">
              <button onclick="setBowel('未完成')" id="bowel-a" class="glass2 border border-white/10 rounded-full px-3 py-2 text-[12px] font-bold text-slate-200 active:scale-95 transition-transform">未完成</button>
              <button onclick="setBowel('正常')" id="bowel-b" class="glass2 border border-white/10 rounded-full px-3 py-2 text-[12px] font-bold text-slate-200 active:scale-95 transition-transform">正常</button>
            </div>
          </div>
        </section>
      </main>
    </section>

    <!-- MIND VIEW -->
    <section id="view-mind" class="hidden flex-col flex-1 fade-in">
      <header class="pt-10 px-4">
        <div class="flex items-center justify-between">
          <button onclick="navTo('hub')" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
            <span class="ms text-[18px]">chevron_left</span>
          </button>
          <div class="text-center">
            <div class="text-[11px] tracking-[0.22em] uppercase text-slate-400 font-semibold">MIND & SPIRIT</div>
            <div class="mt-1 text-2xl font-extrabold text-white">心智與靈修</div>
          </div>
          <button onclick="goToday()" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
            <span class="ms text-[18px]">today</span>
          </button>
        </div>

        <div class="mt-4 flex items-center justify-between">
          <div class="glass2 px-3 py-1.5 rounded-full border border-white/10 text-[11px] text-slate-200 font-semibold">
            <span id="mind-date">Today</span>
          </div>
          <div class="glass2 px-3 py-1.5 rounded-full border border-white/10 text-[11px] text-slate-200 font-semibold">
            完成度 <span class="ml-2 text-white font-extrabold"><span id="mind-completion">0</span>%</span>
          </div>
        </div>
      </header>

      <main class="px-4 pt-5 pb-6 flex-1 overflow-y-auto no-scrollbar">
        <div class="glass2 rounded-full p-1 border border-white/10 flex relative">
          <div id="tab-slider" class="absolute left-1 top-1 bottom-1 w-[calc(50%-4px)] bg-gradient-to-r from-violet to-violet2 rounded-full shadow-glow transition-transform duration-300"></div>
          <button id="tab-btn-mind" onclick="switchTab('mind')" class="flex-1 relative z-10 py-2.5 text-sm font-extrabold text-white text-center rounded-full">心智</button>
          <button id="tab-btn-spirit" onclick="switchTab('spirit')" class="flex-1 relative z-10 py-2.5 text-sm font-semibold text-slate-300 text-center rounded-full">靈修</button>
        </div>

        <div id="tab-mind" class="mt-5 space-y-5">
          <section class="glass rounded-3xl p-5 shadow-glass border border-white/10 relative overflow-hidden">
            <div class="absolute -top-12 -right-12 w-48 h-48 bg-gold/10 rounded-full blur-3xl"></div>
            <div class="flex items-start justify-between">
              <div>
                <div class="text-[11px] tracking-widest uppercase text-slate-400 font-semibold">FOCUS</div>
                <div class="mt-1 text-lg font-extrabold text-white">深度閱讀</div>
                <div class="mt-2 text-[11px] text-slate-400 font-semibold">本項分數：<span id="reading-points">+10 / 0</span></div>
              </div>
              <button onclick="toggleDone('reading')" id="reading-done-btn" class="glass2 border border-white/10 rounded-full px-3 py-2 text-[12px] font-bold text-slate-200 active:scale-95 transition-transform">完成</button>
            </div>

            <div class="mt-5 flex items-center justify-center gap-2">
              <button onclick="openDuration('reading')" class="glass2 border border-white/10 rounded-full px-4 py-2 text-[12px] font-bold text-slate-200 active:scale-95 transition-transform">
                設定 <span id="reading-min">20</span> min
              </button>
              <button onclick="resetTimer('reading')" class="glass2 border border-white/10 rounded-full px-4 py-2 text-[12px] font-bold text-slate-200 active:scale-95 transition-transform">重置</button>
            </div>

            <div class="mt-4 flex items-center justify-center">
              <div id="reading-display" class="text-6xl font-light tracking-tighter tabular-nums text-white">20:00</div>
            </div>

            <div class="mt-5 grid grid-cols-2 gap-2">
              <button id="reading-start" onclick="toggleTimer('reading')" class="glass2 border border-white/10 rounded-2xl py-3 font-extrabold text-white active:scale-95 transition-transform">開始</button>
              <button onclick="cancelTimer('reading')" class="glass2 border border-white/10 rounded-2xl py-3 font-bold text-slate-200 active:scale-95 transition-transform">取消（回到未完成）</button>
            </div>
          </section>

          <section class="glass2 rounded-3xl p-5 border border-white/10 shadow-glass">
            <div class="text-[11px] tracking-widest uppercase text-slate-400 font-semibold">GROWTH REFLECTION</div>
            <div class="mt-1 text-lg font-extrabold text-white">今日反思</div>
            <div class="mt-2 text-[11px] text-slate-400 font-semibold">本項分數：<span id="growth-points">+10 / 0</span></div>
            <input id="growth-input" class="mt-4 w-full rounded-2xl bg-white/5 border border-white/10 text-white placeholder:text-slate-500 px-4 py-4 focus:outline-none focus:ring-2 focus:ring-violet/40"
                   placeholder="寫下今天的核心洞察..." />
          </section>

          <section class="glass2 rounded-3xl p-5 border border-white/10 shadow-glass">
            <div class="text-[11px] tracking-widest uppercase text-slate-400 font-semibold">BRAND STRATEGY</div>
            <div class="mt-1 text-lg font-extrabold text-white">品牌策略筆記</div>
            <div class="mt-2 text-[11px] text-slate-400 font-semibold">本項分數：<span id="brand-points">+10 / 0</span></div>
            <textarea id="brand-input" class="mt-4 w-full h-32 rounded-2xl bg-white/5 border border-white/10 text-white placeholder:text-slate-500 px-4 py-4 focus:outline-none focus:ring-2 focus:ring-violet/40 resize-none"
                      placeholder="紀錄你的策略思考..."></textarea>
          </section>
        </div>

        <div id="tab-spirit" class="hidden mt-5 space-y-5">
          <section class="glass rounded-3xl p-5 shadow-glass border border-white/10 relative overflow-hidden">
            <div class="absolute -top-12 -right-12 w-48 h-48 bg-violet/10 rounded-full blur-3xl"></div>
            <div class="flex items-start justify-between">
              <div>
                <div class="text-[11px] tracking-widest uppercase text-slate-400 font-semibold">SILENCE</div>
                <div class="mt-1 text-lg font-extrabold text-white">靜默靈修</div>
                <div class="mt-2 text-[11px] text-slate-400 font-semibold">本項分數：<span id="devotion-points">+10 / 0</span></div>
              </div>
              <button onclick="toggleDone('devotion')" id="devotion-done-btn" class="glass2 border border-white/10 rounded-full px-3 py-2 text-[12px] font-bold text-slate-200 active:scale-95 transition-transform">完成</button>
            </div>

            <div class="mt-5 flex items-center justify-center gap-2">
              <button onclick="openDuration('devotion')" class="glass2 border border-white/10 rounded-full px-4 py-2 text-[12px] font-bold text-slate-200 active:scale-95 transition-transform">
                設定 <span id="devotion-min">10</span> min
              </button>
              <button onclick="resetTimer('devotion')" class="glass2 border border-white/10 rounded-full px-4 py-2 text-[12px] font-bold text-slate-200 active:scale-95 transition-transform">重置</button>
            </div>

            <div class="mt-4 flex items-center justify-center">
              <div id="devotion-display" class="text-6xl font-light tracking-tighter tabular-nums text-white">10:00</div>
            </div>

            <div class="mt-5 grid grid-cols-2 gap-2">
              <button id="devotion-start" onclick="toggleTimer('devotion')" class="glass2 border border-white/10 rounded-2xl py-3 font-extrabold text-white active:scale-95 transition-transform">開始</button>
              <button onclick="cancelTimer('devotion')" class="glass2 border border-white/10 rounded-2xl py-3 font-bold text-slate-200 active:scale-95 transition-transform">取消（回到未完成）</button>
            </div>
          </section>

          <section class="glass2 rounded-3xl p-5 border border-white/10 shadow-glass">
            <div class="text-[11px] tracking-widest uppercase text-slate-400 font-semibold">SCRIPTURE</div>
            <div class="mt-1 text-lg font-extrabold text-white">經文與領受</div>
            <div class="mt-2 text-[11px] text-slate-400 font-semibold">本項分數：<span id="scripture-points">+10 / 0</span></div>

            <label class="mt-4 block text-[11px] text-slate-400 font-semibold">經文出處</label>
            <input id="scripture-input" class="mt-2 w-full rounded-2xl bg-white/5 border border-white/10 text-white placeholder:text-slate-500 px-4 py-4 focus:outline-none focus:ring-2 focus:ring-violet/40"
                   placeholder="例如：Psalm 23:1" />

            <label class="mt-4 block text-[11px] text-slate-400 font-semibold">心得筆記</label>
            <textarea id="spirit-input" class="mt-2 w-full h-32 rounded-2xl bg-white/5 border border-white/10 text-white placeholder:text-slate-500 px-4 py-4 focus:outline-none focus:ring-2 focus:ring-violet/40 resize-none"
                      placeholder="記錄你的領受..."></textarea>
          </section>
        </div>
      </main>
    </section>

    <!-- CALENDAR VIEW (保留你原本需求，但此版先確保按鈕/Body正常) -->
    <section id="view-calendar" class="hidden flex-col flex-1 fade-in">
      <header class="pt-10 px-4">
        <div class="flex items-center justify-between">
          <button onclick="navTo('hub')" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
            <span class="ms text-[18px]">chevron_left</span>
          </button>
          <div class="text-center">
            <div class="text-[11px] tracking-[0.22em] uppercase text-slate-400 font-semibold">EVOLUTION CALENDAR</div>
            <div class="mt-1 text-2xl font-extrabold text-white">進化日曆</div>
          </div>
          <button onclick="goToday()" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
            <span class="ms text-[18px]">today</span>
          </button>
        </div>
      </header>

      <main class="px-4 pt-5 pb-6 flex-1 overflow-y-auto no-scrollbar space-y-4">
        <section class="glass rounded-3xl p-5 border border-white/10 shadow-glass">
          <div class="text-slate-300 text-sm font-semibold">
           （Calendar 區塊你原本那套還在；如果你要我把 Calendar 也一起完整補回上一版細節，我下一則可以直接貼完整 Calendar 版面。）
          </div>
        </section>
      </main>
    </section>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 left-0 right-0 z-50 flex justify-center pb-6 pt-2">
      <div class="glass mx-auto w-[92%] max-w-[390px] rounded-full flex justify-between items-center py-3 px-6 shadow-glass border border-white/10 bg-obsidian/80">
        <button onclick="navTo('hub')" class="navbtn flex flex-col items-center gap-1 w-16" data-view="hub">
          <span class="ms fill text-[24px]" id="nav-ico-hub">dashboard</span>
          <span class="text-[11px] font-extrabold" id="nav-txt-hub">Hub</span>
        </button>
        <button onclick="navTo('body')" class="navbtn flex flex-col items-center gap-1 w-16 opacity-70" data-view="body">
          <span class="ms text-[24px]" id="nav-ico-body">fitness_center</span>
          <span class="text-[11px] font-semibold" id="nav-txt-body">Body</span>
        </button>
        <button onclick="navTo('mind')" class="navbtn flex flex-col items-center gap-1 w-16 opacity-70" data-view="mind">
          <span class="ms text-[24px]" id="nav-ico-mind">auto_stories</span>
          <span class="text-[11px] font-semibold" id="nav-txt-mind">Mind</span>
        </button>
        <button onclick="navTo('calendar')" class="navbtn flex flex-col items-center gap-1 w-16 opacity-70" data-view="calendar">
          <span class="ms text-[24px]" id="nav-ico-calendar">calendar_month</span>
          <span class="text-[11px] font-semibold" id="nav-txt-calendar">Evo</span>
        </button>
      </div>
    </nav>
  </div>

  <div id="toast-wrap" class="fixed left-0 right-0 bottom-28 z-[60] flex justify-center px-4 pointer-events-none"></div>

  <!-- Modal: Profile -->
  <div id="modal-profile" class="hidden fixed inset-0 z-[80]">
    <div class="absolute inset-0 bg-black/55"></div>
    <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[92%] max-w-md glass rounded-3xl p-5 border border-white/10 shadow-glass">
      <div class="flex items-center justify-between">
        <div class="text-lg font-extrabold text-white">個人設定</div>
        <button onclick="closeModal('modal-profile')" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
          <span class="ms text-[18px]">close</span>
        </button>
      </div>

      <div class="mt-4 space-y-3">
        <div>
          <label class="text-[11px] text-slate-400 font-semibold">名字</label>
          <input id="inp-name" class="mt-2 w-full rounded-2xl bg-white/5 border border-white/10 text-white px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet/40" />
        </div>
        <div>
          <label class="text-[11px] text-slate-400 font-semibold">頭像圖片 URL</label>
          <input id="inp-avatar" class="mt-2 w-full rounded-2xl bg-white/5 border border-white/10 text-white px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet/40"
                 placeholder="https://..." />
        </div>
        <div>
          <label class="text-[11px] text-slate-400 font-semibold">標題</label>
          <input id="inp-title" class="mt-2 w-full rounded-2xl bg-white/5 border border-white/10 text-white px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet/40" />
        </div>

        <div class="grid grid-cols-2 gap-2 mt-2">
          <button onclick="saveProfile()" class="rounded-2xl py-3 font-extrabold text-ink bg-gradient-to-r from-gold via-gold2 to-gold shadow-gold active:scale-95 transition-transform">
            保存
          </button>
          <button onclick="confirmReset()" class="glass2 border border-white/10 rounded-2xl py-3 font-extrabold text-white active:scale-95 transition-transform">
            系統重置
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Duration -->
  <div id="modal-duration" class="hidden fixed inset-0 z-[90]">
    <div class="absolute inset-0 bg-black/55"></div>
    <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[92%] max-w-md glass rounded-3xl p-5 border border-white/10 shadow-glass">
      <div class="flex items-center justify-between">
        <div class="text-lg font-extrabold text-white">設定倒數時間</div>
        <button onclick="closeModal('modal-duration')" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
          <span class="ms text-[18px]">close</span>
        </button>
      </div>

      <div class="mt-4">
        <div class="text-[12px] text-slate-300 font-semibold" id="dur-title">—</div>
        <div class="mt-3 glass2 rounded-2xl border border-white/10 p-4">
          <label class="text-[11px] text-slate-400 font-semibold">分鐘（1–180）</label>
          <input id="dur-min" type="number" min="1" max="180"
                 class="mt-2 w-full rounded-2xl bg-white/5 border border-white/10 text-white px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet/40"/>
          <div class="mt-3 grid grid-cols-4 gap-2">
            <button onclick="quickMin(5)" class="glass2 border border-white/10 rounded-xl py-2 text-[12px] font-bold text-white active:scale-95 transition-transform">5</button>
            <button onclick="quickMin(10)" class="glass2 border border-white/10 rounded-xl py-2 text-[12px] font-bold text-white active:scale-95 transition-transform">10</button>
            <button onclick="quickMin(20)" class="glass2 border border-white/10 rounded-xl py-2 text-[12px] font-bold text-white active:scale-95 transition-transform">20</button>
            <button onclick="quickMin(30)" class="glass2 border border-white/10 rounded-xl py-2 text-[12px] font-bold text-white active:scale-95 transition-transform">30</button>
          </div>
        </div>

        <button onclick="applyDuration()" class="mt-4 w-full rounded-2xl py-3 font-extrabold text-ink bg-gradient-to-r from-violet via-violet2 to-cyan shadow-glow active:scale-95 transition-transform">
          套用
        </button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * ✅ FIX CORE: Safe DOM helpers
     ***********************/
    const $ = (id)=> document.getElementById(id);
    const setText = (id, v)=> { const el=$(id); if(el) el.textContent = v; };
    const setHTML = (id, v)=> { const el=$(id); if(el) el.innerHTML = v; };
    const setWidth = (id, pct)=> { const el=$(id); if(el) el.style.width = pct; };

    /***********************
     * STORAGE + DEFAULTS
     ***********************/
    const STORAGE_KEY = "ate_ultra_v2";
    const LEGACY_KEY = "ate_ultra_v1";
    const DEFAULT_AVATAR = "https://lh3.googleusercontent.com/aida-public/AB6AXuCAYOzNGEzdDG66QmmNGCUlkdnwk7zJo0-6al0p4StVVrRy7UvwIFfnSbzk1yro93SGmClDJXzHkeK0f3pOKlJ7_0wH9VzNbQ3ATQRP2P4Msi2j3L88v-cPqgWfProkys6HXeVgnOq9poVFtfNyxvn9pqj2xho4IOb0kutPRkMrNn2qgl6IG3CfgZJFN6h_2N_KyQQzgP3uX0T6tGAkUnEDgaVjHUIXMZVxocw3H1i2okCF0BovjWGbicSrh5A42xuvBTiOpnUCuI0";

    const VERSES_EN = [
      { t: "Be strong and courageous. Do not be afraid; do not be discouraged, for the Lord your God will be with you wherever you go.", r: "Joshua 1:9" },
      { t: "Commit your way to the Lord; trust in Him, and He will act.", r: "Psalm 37:5" },
      { t: "Be still, and know that I am God.", r: "Psalm 46:10" },
      { t: "The Lord is my shepherd; I shall not want.", r: "Psalm 23:1" },
      { t: "Give thanks in all circumstances.", r: "1 Thessalonians 5:18" },
      { t: "Commit your work to the Lord, and your plans will be established.", r: "Proverbs 16:3" },
      { t: "Do not be anxious about anything; in every situation, by prayer and petition, with thanksgiving, present your requests to God.", r: "Philippians 4:6" },
      { t: "Let us not grow weary in doing good; in due season we will reap, if we do not give up.", r: "Galatians 6:9" },
      { t: "My grace is sufficient for you, for my power is made perfect in weakness.", r: "2 Corinthians 12:9" },
      { t: "Seek first His kingdom and His righteousness, and all these things will be added to you.", r: "Matthew 6:33" },
    ];

    const POINTS = { waterMax: 25, taskTimerEach: 10, taskCheck: 10, bowel: 10, reading: 10, devotion: 10, growth: 10, brand: 10, scripture: 10 };

    function todayKey(){
      const d=new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }
    function formatKey(key){
      const [y,m,d]=key.split("-");
      return `${y}年${m}月${d}日`;
    }
    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

    function freshState(){
      return {
        profile:{ name:"覺醒女神", title:"Aether Trinity Evolution", avatar: DEFAULT_AVATAR },
        gamification:{ level:1, xp:0, xpMax:100 },
        ui:{ view:"hub", activeDate: todayKey(), mindTab:"mind", selectedDate: todayKey() },
        days:{}
      };
    }

    function defaultDay(dateKey){
      return {
        date: dateKey,
        waterGoalMl: 1900,
        waterMl: 0,
        bowelStatus: "未完成",
        tasks: [
          { id: 1, type: "timer", title: "深蹲練習", sub: "核心肌群", minutes: 15, remainingSec: 15*60, running: false, done: false },
          { id: 2, type: "timer", title: "每日肌肉訓練", sub: "30 分鐘", minutes: 30, remainingSec: 30*60, running: false, done: false },
          { id: 3, type: "check", title: "健康早餐", sub: "建議 08:30 AM", done: false },
        ],
        reading: { minutes: 20, remainingSec: 20*60, running: false, done: false },
        devotion:{ minutes: 10, remainingSec: 10*60, running: false, done: false },
        mind:{ growth:"", brand:"" },
        spirit:{ scripture:"", note:"" },
        settle:{ settled:false, xpAwarded:0, percentAtSettle:0 }
      };
    }

    function normalizeDay(day, dateKey){
      const d = Object.assign(defaultDay(dateKey), day || {});
      d.tasks = Array.isArray(d.tasks) ? d.tasks : defaultDay(dateKey).tasks;
      d.tasks = d.tasks.map(t=>{
        if(t.type==="timer"){
          const m = Number(t.minutes || 10);
          const rem = Number.isFinite(t.remainingSec) ? t.remainingSec : m*60;
          return { ...t, minutes:m, remainingSec: rem, running: !!t.running, done: !!t.done };
        }
        return { ...t, done: !!t.done };
      });
      d.reading = d.reading || defaultDay(dateKey).reading;
      d.devotion = d.devotion || defaultDay(dateKey).devotion;
      d.reading = { minutes:Number(d.reading.minutes||20), remainingSec:Number(d.reading.remainingSec||d.reading.minutes*60), running:!!d.reading.running, done:!!d.reading.done };
      d.devotion = { minutes:Number(d.devotion.minutes||10), remainingSec:Number(d.devotion.remainingSec||d.devotion.minutes*60), running:!!d.devotion.running, done:!!d.devotion.done };
      d.mind = d.mind || { growth:"", brand:"" };
      d.spirit = d.spirit || { scripture:"", note:"" };
      d.settle = d.settle || { settled:false, xpAwarded:0, percentAtSettle:0 };
      return d;
    }

    function loadState(){
      const cur = localStorage.getItem(STORAGE_KEY);
      if(cur) return JSON.parse(cur);

      const legacy = localStorage.getItem(LEGACY_KEY);
      if(legacy){
        try{
          const old = JSON.parse(legacy) || {};
          const s = freshState();
          s.profile = old.profile || s.profile;
          s.gamification = old.gamification || s.gamification;
          s.ui = Object.assign(s.ui, old.ui || {});
          s.days = old.days || {};
          Object.keys(s.days).forEach(k=> s.days[k]=normalizeDay(s.days[k], k));
          localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
          return s;
        }catch(e){}
      }

      const s = freshState();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
      return s;
    }

    const state = loadState();
    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    function activeKey(){ return state.ui.activeDate || todayKey(); }
    function ensureDay(key){
      if(!state.days[key]) state.days[key] = defaultDay(key);
      state.days[key] = normalizeDay(state.days[key], key);
      return state.days[key];
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));
    }

    /***********************
     * Points + Completion
     ***********************/
    function pointsBreakdown(day){
      const waterRatio = clamp(day.waterGoalMl ? day.waterMl / day.waterGoalMl : 0, 0, 1);
      const waterPts = Math.round(POINTS.waterMax * waterRatio);

      let taskPts = 0;
      let taskTotal = 0;
      day.tasks.forEach(t=>{
        const each = (t.type==="timer") ? POINTS.taskTimerEach : POINTS.taskCheck;
        taskTotal += each;
        if(t.done) taskPts += each;
      });

      const bowelPts = (day.bowelStatus !== "未完成") ? POINTS.bowel : 0;
      const readingPts = day.reading.done ? POINTS.reading : 0;
      const devotionPts = day.devotion.done ? POINTS.devotion : 0;
      const growthPts = day.mind.growth.trim() ? POINTS.growth : 0;
      const brandPts  = day.mind.brand.trim()  ? POINTS.brand  : 0;
      const scripturePts = (day.spirit.scripture.trim() || day.spirit.note.trim()) ? POINTS.scripture : 0;

      const totalPts = POINTS.waterMax + taskTotal + POINTS.bowel + POINTS.reading + POINTS.devotion + POINTS.growth + POINTS.brand + POINTS.scripture;
      const gotPts = waterPts + taskPts + bowelPts + readingPts + devotionPts + growthPts + brandPts + scripturePts;

      return { waterRatio, waterPts, taskPts, totalPts, gotPts };
    }

    function computeCompletion(day){
      const p = pointsBreakdown(day);
      const ratio = p.totalPts ? (p.gotPts / p.totalPts) : 0;
      const percent = Math.round(ratio * 100);
      const perfect = ratio >= 0.70;
      let xp = 30 + Math.round(170 * ratio);
      if(perfect) xp += 20;
      xp = clamp(xp, 0, 220);
      return { ratio, percent, perfect, xp, points: p };
    }

    function computeStreak(){
      let streak = 0;
      let k = todayKey();
      while(true){
        const day = ensureDay(k);
        const c = computeCompletion(day);
        if(!c.perfect) break;
        streak++;
        const d = new Date(k+"T00:00:00");
        d.setDate(d.getDate()-1);
        k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      }
      return streak;
    }

    /***********************
     * Toast
     ***********************/
    function toast(title, msg){
      const wrap = $("toast-wrap");
      if(!wrap) return;
      const el = document.createElement("div");
      el.className = "toast pointer-events-none w-full max-w-md";
      el.innerHTML = `
        <div class="glass2 border border-white/10 shadow-glass rounded-2xl px-4 py-3">
          <div class="text-sm font-extrabold text-white">${escapeHtml(title)}</div>
          <div class="mt-1 text-[12px] text-slate-300 font-medium leading-relaxed">${escapeHtml(msg)}</div>
        </div>
      `;
      wrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(8px)"; el.style.transition="all .25s ease"; }, 2200);
      setTimeout(()=>{ el.remove(); }, 2600);
      try { navigator.vibrate && navigator.vibrate(18); } catch(e){}
    }

    /***********************
     * Navigation + Modals
     ***********************/
    function navTo(view){
      state.ui.view = view;
      save();
      renderAll();
    }

    function switchTab(tab){
      state.ui.mindTab = tab;
      save();
      renderMindTabs();
    }

    function goToday(){
      state.ui.activeDate = todayKey();
      state.ui.selectedDate = todayKey();
      save();
      renderAll();
      toast("已回到今天", "你可以直接記錄今日或補填過去日期。");
    }

    function openModal(id){
      const el = $(id); if(!el) return;
      el.classList.remove("hidden");
      document.body.style.overflow = "hidden";
    }
    function closeModal(id){
      const el = $(id); if(!el) return;
      el.classList.add("hidden");
      document.body.style.overflow = "";
    }

    function saveProfile(){
      const name = ($("inp-name")?.value || "").trim() || "覺醒女神";
      const avatar = ($("inp-avatar")?.value || "").trim() || DEFAULT_AVATAR;
      const title = ($("inp-title")?.value || "").trim() || "Aether Trinity Evolution";
      state.profile.name = name;
      state.profile.avatar = avatar;
      state.profile.title = title;
      save();
      closeModal("modal-profile");
      renderProfile();
      toast("已保存", "個人設定已更新。");
    }

    function confirmReset(){
      const ok = confirm("【系統重置】確定要清除所有紀錄並從 0 開始嗎？");
      if(!ok) return;
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(LEGACY_KEY);
      location.reload();
    }

    /***********************
     * Body Actions
     ***********************/
    function modifyWater(delta){
      const d = ensureDay(activeKey());
      d.waterMl = Math.max(0, d.waterMl + delta);
      save();
      renderAll();
      toast(delta>0 ? "水分增加" : "水分扣回", `${delta>0?'+':''}${delta} ml（分數依達標比例即時變動）`);
    }

    function setBowel(val){
      const d = ensureDay(activeKey());
      d.bowelStatus = val;
      save();
      renderAll();
      toast("排便狀況已更新", val === "正常" ? `+${POINTS.bowel} 分` : "0 分");
    }

    function toggleCheckTask(id){
      const d = ensureDay(activeKey());
      const t = d.tasks.find(x=>x.id===id);
      if(!t) return;
      t.done = !t.done;
      save();
      renderAll();
      toast(t.done ? "任務完成" : "取消完成", `${t.title}（${t.done?'+':'-'}${POINTS.taskCheck} 分）`);
    }

    /***********************
     * Timers (simple stable)
     ***********************/
    let globalTick = null;

    function startGlobalTick(){
      if(globalTick) return;
      globalTick = setInterval(()=>{
        const key = activeKey();
        const day = ensureDay(key);
        let changed = false;

        day.tasks.forEach(t=>{
          if(t.type==="timer" && t.running && !t.done){
            t.remainingSec = Math.max(0, t.remainingSec - 1);
            changed = true;
            if(t.remainingSec === 0){
              t.running=false; t.done=true;
              toast("計時完成", `${t.title}（+${POINTS.taskTimerEach} 分）`);
            }
          }
        });

        if(day.reading.running && !day.reading.done){
          day.reading.remainingSec = Math.max(0, day.reading.remainingSec - 1);
          changed = true;
          if(day.reading.remainingSec === 0){
            day.reading.running=false; day.reading.done=true;
            toast("計時完成", `深度閱讀（+${POINTS.reading} 分）`);
          }
        }

        if(day.devotion.running && !day.devotion.done){
          day.devotion.remainingSec = Math.max(0, day.devotion.remainingSec - 1);
          changed = true;
          if(day.devotion.remainingSec === 0){
            day.devotion.running=false; day.devotion.done=true;
            toast("計時完成", `靜默靈修（+${POINTS.devotion} 分）`);
          }
        }

        if(changed){
          save();
          renderTimersOnly();
          renderCompletionOnly();
        }
      }, 1000);
    }

    function stopAllRunningTimersOnActiveDay(){
      const day = ensureDay(activeKey());
      day.tasks.forEach(t=>{ if(t.type==="timer") t.running = false; });
      day.reading.running = false;
      day.devotion.running = false;
    }

    function toggleTimer(kind, id){
      const day = ensureDay(activeKey());
      let ref=null, title="";
      if(kind==="reading"){ ref=day.reading; title="深度閱讀"; }
      else if(kind==="devotion"){ ref=day.devotion; title="靜默靈修"; }
      else if(kind==="task"){ ref=day.tasks.find(t=>t.id===id); title=ref?.title || "任務"; }
      if(!ref) return;

      if(ref.done){ toast("已完成", "若要重新計算，請先按「取消」。"); return; }

      stopAllRunningTimersOnActiveDay();
      if(ref.running){
        ref.running = false;
        save(); renderAll();
        toast("已暫停", title);
        return;
      }
      if(ref.remainingSec<=0){
        const mins = Number(ref.minutes || 10);
        ref.remainingSec = mins*60;
      }
      ref.running = true;
      save(); renderAll();
      toast("開始計時", title);
      startGlobalTick();
    }

    function toggleDone(kind, id){
      const day = ensureDay(activeKey());
      let ref=null, title="", pts=0;

      if(kind==="reading"){ ref=day.reading; title="深度閱讀"; pts=POINTS.reading; }
      else if(kind==="devotion"){ ref=day.devotion; title="靜默靈修"; pts=POINTS.devotion; }
      else if(kind==="task"){ ref=day.tasks.find(t=>t.id===id); title=ref?.title||"任務"; pts=POINTS.taskTimerEach; }
      if(!ref) return;

      const next = !ref.done;
      ref.done = next;
      ref.running = false;
      if(next) ref.remainingSec = 0;
      else ref.remainingSec = Number(ref.minutes || 10) * 60;

      save(); renderAll();
      toast(next ? "已完成" : "取消完成", `${title}（${next?'+':'-'}${pts} 分）`);
    }

    function cancelTimer(kind, id){
      const day = ensureDay(activeKey());
      let ref=null, title="", pts=0;
      if(kind==="reading"){ ref=day.reading; title="深度閱讀"; pts=POINTS.reading; }
      else if(kind==="devotion"){ ref=day.devotion; title="靜默靈修"; pts=POINTS.devotion; }
      else if(kind==="task"){ ref=day.tasks.find(t=>t.id===id); title=ref?.title||"任務"; pts=POINTS.taskTimerEach; }
      if(!ref) return;

      ref.running = false;
      ref.done = false;
      ref.remainingSec = Number(ref.minutes || 10) * 60;

      save(); renderAll();
      toast("已取消", `${title}（回到未完成 / -${pts} 分）`);
    }

    function resetTimer(kind, id){
      const day = ensureDay(activeKey());
      let ref=null, title="";
      if(kind==="reading"){ ref=day.reading; title="深度閱讀"; }
      else if(kind==="devotion"){ ref=day.devotion; title="靜默靈修"; }
      else if(kind==="task"){ ref=day.tasks.find(t=>t.id===id); title=ref?.title||"任務"; }
      if(!ref) return;

      ref.running = false;
      ref.remainingSec = Number(ref.minutes || 10) * 60;

      save(); renderAll();
      toast("已重置", `${title}（時間回到 ${ref.minutes} 分鐘）`);
    }

    function tickLabel(sec){
      const s = Math.max(0, Math.floor(sec));
      const m = Math.floor(s/60);
      const r = s%60;
      return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;
    }

    /***********************
     * Duration modal (for timer tasks)
     ***********************/
    let durationTarget = null;
    function openDuration(target){
      durationTarget = target;
      const day = ensureDay(activeKey());
      if(target==="reading"){
        setText("dur-title","深度閱讀");
        $("dur-min").value = day.reading.minutes;
      }else if(target==="devotion"){
        setText("dur-title","靜默靈修");
        $("dur-min").value = day.devotion.minutes;
      }else{
        const t = day.tasks.find(x=>x.id===target);
        setText("dur-title", t ? t.title : "任務");
        $("dur-min").value = t ? t.minutes : 10;
      }
      openModal("modal-duration");
    }
    function quickMin(m){ $("dur-min").value = m; }
    function applyDuration(){
      const m = clamp(parseInt($("dur-min").value || "10",10), 1, 180);
      const day = ensureDay(activeKey());

      if(durationTarget==="reading"){
        day.reading.minutes = m; day.reading.running=false; day.reading.done=false; day.reading.remainingSec = m*60;
      }else if(durationTarget==="devotion"){
        day.devotion.minutes = m; day.devotion.running=false; day.devotion.done=false; day.devotion.remainingSec = m*60;
      }else{
        const t = day.tasks.find(x=>x.id===durationTarget);
        if(t && t.type==="timer"){
          t.minutes = m; t.running=false; t.done=false; t.remainingSec = m*60;
        }
      }

      save();
      closeModal("modal-duration");
      renderAll();
      toast("已套用", `倒數時間設定為 ${m} 分鐘（已回到未完成）。`);
    }

    /***********************
     * Render
     ***********************/
    function renderAll(){
      ["hub","body","mind","calendar"].forEach(v=>{
        const el = $("view-"+v);
        if(!el) return;
        el.classList.toggle("hidden", state.ui.view !== v);
      });

      // nav highlight (safe)
      ["hub","body","mind","calendar"].forEach(v=>{
        const ico = $("nav-ico-"+v);
        const txt = $("nav-txt-"+v);
        const active = state.ui.view === v;
        const btn = ico?.parentElement;
        if(btn) btn.classList.toggle("opacity-70", !active);
        if(ico) ico.className = "ms " + (active ? "fill text-[24px] text-violet2" : "text-[24px] text-slate-300");
        if(txt) txt.className = (active ? "text-[11px] font-extrabold text-white" : "text-[11px] font-semibold text-slate-400");
      });

      renderProfile();
      renderHub();
      renderBody();
      renderMind();
      startGlobalTick();
    }

    function renderProfile(){
      setText("profile-name", state.profile.name);
      setText("profile-title", state.profile.title);
      const av = $("profile-avatar"); if(av) av.src = state.profile.avatar || DEFAULT_AVATAR;
      setText("profile-level-mini", `LV ${state.gamification.level}`);

      setText("hub-xp", state.gamification.xp);
      setText("hub-xpmax", state.gamification.xpMax);
      const pct = clamp(state.gamification.xpMax ? (state.gamification.xp/state.gamification.xpMax)*100 : 0, 0, 100);
      setWidth("hub-xpbar", pct.toFixed(0)+"%");

      const day = ensureDay(activeKey());
      const c = computeCompletion(day);
      setText("profile-completion", `${c.percent}%`);
      setText("profile-xp-est", `+${c.xp} XP`);
      setText("profile-streak", `${computeStreak()} Days`);

      const settled = day.settle?.settled;
      const settleEl = $("profile-settled");
      if(settleEl){
        settleEl.textContent = settled ? `已結算：+${day.settle.xpAwarded} XP` : "未結算";
        settleEl.className = settled ? "text-[10px] text-lime font-extrabold" : "text-[10px] text-slate-400 font-semibold";
      }
    }

    function renderHub(){
      const key = activeKey();
      const day = ensureDay(key);
      const c = computeCompletion(day);

      setText("hub-date", (key===todayKey()) ? "Today" : key);
      setText("hub-completion", c.percent);        // ✅ now exists + safe
      setText("hub-body-score", c.percent);
      setWidth("hub-body-bar", `${c.percent}%`);
      setText("hub-xp-est", c.xp);

      const now = new Date();
      const idx = Math.floor((now - new Date(now.getFullYear(),0,0))/86400000) % VERSES_EN.length;
      setText("daily-verse", "“"+VERSES_EN[idx].t+"”");
      setText("daily-verse-ref", VERSES_EN[idx].r);
    }

    function renderBody(){
      if(state.ui.view !== "body") return;

      const key = activeKey();
      const day = ensureDay(key);
      const c = computeCompletion(day);

      setText("body-date", (key===todayKey()) ? "Today" : formatKey(key));
      setText("body-completion", c.percent);

      setText("water-goal", day.waterGoalMl);
      setText("water-val", day.waterMl);
      setWidth("water-bar", `${Math.round(c.points.waterRatio*100)}%`);
      setText("water-points-hint", `此區分數：${Math.round(POINTS.waterMax*c.points.waterRatio)}/${POINTS.waterMax}`);

      setText("bowel-points", `+${POINTS.bowel} / 0`);

      const a=$("bowel-a"), b=$("bowel-b");
      const on=(btn, active)=>{
        if(!btn) return;
        btn.classList.toggle("bg-white/10", active);
        btn.classList.toggle("border-violet/30", active);
        btn.classList.toggle("text-white", active);
        btn.classList.toggle("text-slate-200", !active);
      };
      on(a, day.bowelStatus==="未完成");
      on(b, day.bowelStatus==="正常");

      const list = $("task-list");
      if(!list) return;

      list.innerHTML = day.tasks.map(t=>{
        if(t.type==="check"){
          const pts = POINTS.taskCheck;
          return `
            <div class="glass2 rounded-3xl p-4 border border-white/10 shadow-glass">
              <div class="flex items-center justify-between">
                <div class="min-w-0">
                  <div class="text-lg font-extrabold ${t.done?'text-white line-through decoration-violet/40':'text-white'} truncate">${escapeHtml(t.title)}</div>
                  <div class="mt-1 text-[12px] text-slate-400 font-medium">${escapeHtml(t.sub)}</div>
                  <div class="mt-2 text-[11px] text-slate-400 font-semibold">本動作：${t.done?`-${pts}`:`+${pts}`} 分</div>
                </div>
                <button onclick="toggleCheckTask(${t.id})"
                        class="glass2 border border-white/10 rounded-full w-12 h-12 flex items-center justify-center active:scale-95 transition-transform ${t.done?'bg-violet/20 border-violet/30':''}">
                  <span class="ms ${t.done?'fill text-violet2':'text-slate-300'} text-[22px]">done</span>
                </button>
              </div>
            </div>
          `;
        }

        const pts = POINTS.taskTimerEach;
        const running = t.running && !t.done;
        const done = t.done;

        return `
          <div class="glass2 rounded-3xl p-4 border border-white/10 shadow-glass relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-44 h-44 bg-violet/10 rounded-full blur-3xl"></div>

            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="text-lg font-extrabold ${done?'text-white line-through decoration-violet/40':'text-white'} truncate">${escapeHtml(t.title)}</div>
                <div class="mt-1 text-[12px] text-slate-400 font-medium">${escapeHtml(t.sub)}</div>
                <div class="mt-2 text-[11px] text-slate-400 font-semibold">本動作：${done?`-${pts}`:`+${pts}`} 分</div>
              </div>
              <button onclick="openDuration(${t.id})" class="glass2 border border-white/10 rounded-full px-3 py-2 text-[12px] font-bold text-slate-200 active:scale-95 transition-transform">
                ${t.minutes} min
              </button>
            </div>

            <div class="mt-4 flex items-center justify-between">
              <div class="text-4xl font-light tracking-tighter tabular-nums text-white ${running?'pulse-ring':''} px-2 py-1 rounded-2xl">
                ${tickLabel(t.remainingSec)}
              </div>

              <div class="flex items-center gap-2">
                <button onclick="resetTimer('task', ${t.id})" class="glass2 border border-white/10 rounded-2xl px-3 py-2 text-[12px] font-bold text-slate-200 active:scale-95 transition-transform">重置</button>
                <button onclick="toggleDone('task', ${t.id})" class="glass2 border border-white/10 rounded-2xl px-3 py-2 text-[12px] font-extrabold ${done?'text-rose':'text-white'} active:scale-95 transition-transform">
                  ${done?'取消完成':'完成'}
                </button>
                <button onclick="toggleTimer('task', ${t.id})"
                        class="rounded-2xl px-4 py-2 text-[12px] font-extrabold border active:scale-95 transition-transform
                        ${done ? "bg-white/5 text-slate-400 border-white/10 cursor-not-allowed" :
                          (running ? "bg-white text-ink border-white" : "bg-gradient-to-r from-violet via-violet2 to-cyan text-white border-white/10")}"
                        ${done ? "disabled" : ""}>
                  ${running?'暫停':'開始'}
                </button>
              </div>
            </div>

            <button onclick="cancelTimer('task', ${t.id})"
                    class="mt-3 w-full glass2 border border-white/10 rounded-2xl py-2 text-[12px] font-bold text-slate-200 active:scale-95 transition-transform">
              取消（回到未完成）
            </button>
          </div>
        `;
      }).join("");
    }

    function renderMind(){
      if(state.ui.view !== "mind") return;
      const key = activeKey();
      const day = ensureDay(key);
      const c = computeCompletion(day);

      setText("mind-date", (key===todayKey()) ? "Today" : formatKey(key));
      setText("mind-completion", c.percent);

      const growth=$("growth-input"), brand=$("brand-input"), scripture=$("scripture-input"), spirit=$("spirit-input");
      if(growth) growth.value = day.mind.growth || "";
      if(brand) brand.value = day.mind.brand || "";
      if(scripture) scripture.value = day.spirit.scripture || "";
      if(spirit) spirit.value = day.spirit.note || "";

      setText("reading-min", day.reading.minutes);
      setText("reading-display", tickLabel(day.reading.remainingSec));
      setText("reading-done-btn", day.reading.done ? "取消完成" : "完成");
      setText("reading-start", day.reading.running ? "暫停" : "開始");

      setText("devotion-min", day.devotion.minutes);
      setText("devotion-display", tickLabel(day.devotion.remainingSec));
      setText("devotion-done-btn", day.devotion.done ? "取消完成" : "完成");
      setText("devotion-start", day.devotion.running ? "暫停" : "開始");

      renderMindTabs();
    }

    function renderMindTabs(){
      const tab = state.ui.mindTab || "mind";
      const mind = $("tab-mind");
      const spirit = $("tab-spirit");
      const slider = $("tab-slider");
      const btnMind = $("tab-btn-mind");
      const btnSpirit = $("tab-btn-spirit");

      const isMind = tab === "mind";
      if(mind) mind.classList.toggle("hidden", !isMind);
      if(spirit) spirit.classList.toggle("hidden", isMind);
      if(slider) slider.style.transform = isMind ? "translateX(0%)" : "translateX(100%)";
      if(btnMind) btnMind.className = "flex-1 relative z-10 py-2.5 text-sm text-center rounded-full " + (isMind ? "font-extrabold text-white" : "font-semibold text-slate-300");
      if(btnSpirit) btnSpirit.className = "flex-1 relative z-10 py-2.5 text-sm text-center rounded-full " + (!isMind ? "font-extrabold text-white" : "font-semibold text-slate-300");
    }

    function renderCompletionOnly(){
      const day = ensureDay(activeKey());
      const c = computeCompletion(day);
      setText("hub-completion", c.percent);
      setText("hub-body-score", c.percent);
      setWidth("hub-body-bar", `${c.percent}%`);
      setText("body-completion", c.percent);
      setText("mind-completion", c.percent);
      setText("profile-completion", `${c.percent}%`);
      setText("profile-xp-est", `+${c.xp} XP`);
      setText("profile-streak", `${computeStreak()} Days`);
      setText("hub-xp-est", c.xp);
    }

    function renderTimersOnly(){
      const day = ensureDay(activeKey());
      if(state.ui.view==="body") renderBody();
      if(state.ui.view==="mind"){
        setText("reading-display", tickLabel(day.reading.remainingSec));
        setText("devotion-display", tickLabel(day.devotion.remainingSec));
      }
    }

    /***********************
     * Inputs bind (avoid stacking)
     ***********************/
    let inputsBound=false;
    function bindInputs(){
      if(inputsBound) return;
      inputsBound=true;

      const growth=$("growth-input"), brand=$("brand-input"), scripture=$("scripture-input"), spirit=$("spirit-input");
      const bind = (el, fn)=>{
        if(!el) return;
        el.addEventListener("input", ()=>{
          fn(el.value);
          save();
          renderCompletionOnly();
        });
      };
      bind(growth, v=> ensureDay(activeKey()).mind.growth = v);
      bind(brand, v=> ensureDay(activeKey()).mind.brand = v);
      bind(scripture, v=> ensureDay(activeKey()).spirit.scripture = v);
      bind(spirit, v=> ensureDay(activeKey()).spirit.note = v);
    }

    /***********************
     * Header click handlers
     ***********************/
    document.addEventListener("click", (e)=>{
      if(e.target?.closest("#btn-profile")){
        $("inp-name").value = state.profile.name || "";
        $("inp-avatar").value = state.profile.avatar || "";
        $("inp-title").value = state.profile.title || "";
        openModal("modal-profile");
      }
      if(e.target?.closest("#btn-reset")) confirmReset();
      if(e.target?.closest("#btn-settle")){
        toast("結算（本版先保留）", "你要我把你上一版完整結算/等級邏輯也補回來，我下一則直接補。");
      }
    });

    /***********************
     * INIT
     ***********************/
    ensureDay(todayKey());
    ensureDay(state.ui.activeDate || todayKey());
    ensureDay(state.ui.selectedDate || todayKey());
    save();
    renderAll();
    bindInputs();
    startGlobalTick();
  </script>
</body>
</html>
