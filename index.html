<!DOCTYPE html>
<html lang="zh-Hant" class="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>ATE - Aether Trinity Evolution (Mobile Ultra)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@200..700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            ink: "#05060A",
            obsidian: "#0B0D14",
            surface: "#0F1424",
            panel: "#10192E",
            stroke: "rgba(255,255,255,0.10)",
            stroke2: "rgba(255,255,255,0.14)",
            gold: "#D4AF37",
            gold2: "#F4E09A",
            violet: "#8B5CF6",
            violet2: "#A78BFA",
            cyan: "#22D3EE",
            rose: "#FB7185",
            lime: "#A3E635",
          },
          fontFamily: {
            display: ["Manrope", "Noto Sans TC", "sans-serif"],
            body: ["Noto Sans TC", "Manrope", "sans-serif"],
          },
          boxShadow: {
            glass: "0 14px 44px rgba(0,0,0,0.35)",
            glow: "0 0 18px rgba(139,92,246,0.22)",
            gold: "0 0 18px rgba(212,175,55,0.18)",
          }
        }
      }
    }
  </script>

  <style>
    :root{ color-scheme: dark; }
    body{
      min-height:100dvh;background:#05060A;-webkit-tap-highlight-color:transparent;overflow-x:hidden;
      font-family: Manrope, "Noto Sans TC", sans-serif;
    }
    .ms{font-family:'Material Symbols Outlined';font-variation-settings:'FILL' 0,'wght' 420,'GRAD' 0,'opsz' 24;}
    .ms.fill{font-variation-settings:'FILL' 1,'wght' 520,'GRAD' 0,'opsz' 24;}

    .glass{
      background:rgba(16,25,46,0.62);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
      border:1px solid rgba(255,255,255,0.10);
    }
    .glass2{
      background:linear-gradient(145deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.02) 100%);
      backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);
      border:1px solid rgba(255,255,255,0.10);
    }
    .no-scrollbar::-webkit-scrollbar{display:none;}
    .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none;}
    .fade-in{animation:fadeIn .18s ease-out;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}

    /* compact chips */
    .chip{
      display:inline-flex;align-items:center;gap:.35rem;
      padding:.20rem .50rem;border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.04);
      font-size:10px;font-weight:800;color:rgba(226,232,240,0.92);
      letter-spacing:.08em;text-transform:uppercase;user-select:none;white-space:nowrap;
    }
    .chip .ms{font-size:14px;}

    /* game-like floating score pop */
    .pop{
      position:fixed;left:50%;top:40%;
      transform:translate(-50%,-50%);
      z-index:9999;pointer-events:none;
      animation:popMove .85s ease-out forwards;
      filter: drop-shadow(0 8px 16px rgba(0,0,0,0.45));
    }
    @keyframes popMove{
      0%{opacity:0;transform:translate(-50%,-50%) scale(.85);}
      15%{opacity:1;transform:translate(-50%,-58%) scale(1.05);}
      100%{opacity:0;transform:translate(-50%,-95%) scale(1.0);}
    }
    .popBadge{
      padding:.35rem .6rem;border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(15,20,36,0.76);
      font-weight:900;letter-spacing:.08em;
      font-size:14px;
    }

    /* micro toast (optional) */
    .toast{
      position:fixed;left:50%;bottom:6.3rem;
      transform:translateX(-50%);
      z-index:9998;
      animation:toastIn .20s ease-out, toastOut .22s ease-in 1.6s forwards;
      pointer-events:none;
    }
    @keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(8px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}
    @keyframes toastOut{to{opacity:0;transform:translateX(-50%) translateY(8px);}}

    /* subtle ring for active timer */
    .ringPulse{ animation:ringPulse 1.5s infinite; }
    @keyframes ringPulse{
      0%{box-shadow:0 0 0 0 rgba(139,92,246,0.28);}
      70%{box-shadow:0 0 0 12px rgba(139,92,246,0);}
      100%{box-shadow:0 0 0 0 rgba(139,92,246,0);}
    }

    /* bottom safe area */
    .pb-safe{ padding-bottom: calc(6.0rem + env(safe-area-inset-bottom)); }
    .nav-safe{ padding-bottom: calc(1.0rem + env(safe-area-inset-bottom)); }

    /* ambient */
    .noise{
      opacity:0.045;
      background-image:url('data:image/svg+xml,%3Csvg viewBox=%220 0 240 240%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cfilter id=%22n%22%3E%3CfeTurbulence type=%22fractalNoise%22 baseFrequency=%220.75%22 numOctaves=%223%22 stitchTiles=%22stitch%22/%3E%3C/filter%3E%3Crect width=%22100%25%22 height=%22100%25%22 filter=%22url(%23n)%22/%3E%3C/svg%3E');
    }
  </style>
</head>

<body class="bg-ink text-slate-100 selection:bg-violet selection:text-white">
  <!-- Ambient -->
  <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
    <div class="absolute -top-[18%] left-[12%] w-[95%] h-[55%] bg-violet/18 rounded-full blur-[130px]"></div>
    <div class="absolute -bottom-[18%] right-[-12%] w-[70%] h-[45%] bg-cyan/10 rounded-full blur-[120px]"></div>
    <div class="absolute inset-0 noise"></div>
  </div>

  <!-- App -->
  <div class="relative z-10 mx-auto w-full max-w-md min-h-[100dvh] flex flex-col pb-safe">

    <!-- HUB -->
    <section id="view-hub" class="flex flex-col flex-1 fade-in">
      <header class="pt-10 px-4 pb-3">
        <!-- ✅ FIX: Mobile compact profile layout (no squeeze) -->
        <div class="glass rounded-2xl p-4 shadow-glass">
          <div class="flex items-center gap-3">
            <button id="btn-profile" class="shrink-0" title="個人設定">
              <div class="h-12 w-12 rounded-full overflow-hidden border border-white/15 bg-surface">
                <img id="profile-avatar" alt="avatar" class="h-full w-full object-cover"/>
              </div>
            </button>

            <div class="min-w-0 flex-1">
              <div class="flex items-center gap-2 min-w-0">
                <div id="profile-name" class="text-base font-extrabold text-white truncate">覺醒女神</div>
                <span class="chip"><span class="ms fill text-gold">workspace_premium</span><span id="profile-level-mini">LV 1</span></span>
              </div>
              <div id="profile-title" class="mt-0.5 text-[11px] text-slate-400 font-semibold truncate">Aether Trinity Evolution</div>

              <div class="mt-2 flex flex-wrap gap-2">
                <span class="chip"><span class="ms fill text-violet2">percent</span><span id="profile-completion">0%</span></span>
                <span class="chip"><span class="ms fill text-gold">bolt</span><span id="profile-xp-est">+0</span></span>
                <span class="chip"><span class="ms fill text-rose">local_fire_department</span><span id="profile-streak">0</span></span>
              </div>
            </div>

            <div class="shrink-0 flex flex-col items-end gap-2">
              <button id="btn-reset" class="glass2 rounded-full px-3 py-2 active:scale-95 transition-transform" title="重置">
                <span class="ms text-[18px]">restart_alt</span>
              </button>
              <div id="profile-settled" class="text-[10px] text-slate-400 font-semibold">未結算</div>
            </div>
          </div>

          <!-- XP -->
          <div class="mt-3">
            <div class="flex items-center justify-between text-[11px] text-slate-300 font-semibold">
              <span class="tracking-widest uppercase text-slate-400">XP</span>
              <span class="text-violet2 font-extrabold"><span id="hub-xp">0</span> / <span id="hub-xpmax">100</span></span>
            </div>
            <div class="mt-1.5 h-2.5 w-full rounded-full bg-white/5 border border-white/10 overflow-hidden">
              <div id="hub-xpbar" class="h-full w-[0%] bg-gradient-to-r from-violet via-violet2 to-cyan rounded-full transition-all duration-500"></div>
            </div>

            <div class="mt-2 flex items-center justify-between text-[11px] text-slate-300 font-semibold">
              <span class="tracking-widest uppercase text-slate-400">Today</span>
              <span class="text-white font-extrabold"><span id="hub-completion">0</span>%</span>
            </div>
          </div>
        </div>

        <!-- Verse EN -->
        <div class="mt-3 glass2 rounded-2xl px-4 py-3 border border-white/10 shadow-glass">
          <div class="flex items-center justify-between">
            <div class="text-[10px] tracking-[0.22em] uppercase text-slate-400 font-extrabold">Daily Verse</div>
            <div class="text-[10px] text-gold font-extrabold tracking-widest">EN</div>
          </div>
          <div id="daily-verse" class="mt-2 text-[13px] leading-relaxed text-white font-semibold"></div>
          <div id="daily-verse-ref" class="mt-1.5 text-[11px] text-slate-400 font-semibold"></div>
        </div>
      </header>

      <main class="px-4 pb-5 flex-1 space-y-3">
        <div class="flex items-center justify-between">
          <div class="text-sm font-extrabold text-white">今日進化</div>
          <div class="glass2 px-3 py-1.5 rounded-full border border-white/10 text-[11px] text-slate-200 font-semibold">
            <span id="hub-date">Today</span>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <button onclick="navTo('body')" class="glass2 rounded-2xl p-4 border border-white/10 shadow-glass text-left active:scale-[0.99] transition-transform">
            <div class="text-[10px] tracking-widest uppercase text-slate-400 font-extrabold">Body</div>
            <div class="mt-1 text-base font-extrabold text-white">身體</div>
            <div class="mt-2 h-2 w-full rounded-full bg-white/5 border border-white/10 overflow-hidden">
              <div id="hub-body-bar" class="h-full w-[0%] bg-gradient-to-r from-rose via-violet2 to-cyan rounded-full transition-all duration-500"></div>
            </div>
            <div class="mt-1.5 text-[11px] text-slate-300 font-semibold">完成 <span class="text-white font-extrabold"><span id="hub-body-score">0</span>%</span></div>
          </button>

          <button onclick="navTo('mind')" class="glass2 rounded-2xl p-4 border border-white/10 shadow-glass text-left active:scale-[0.99] transition-transform">
            <div class="text-[10px] tracking-widest uppercase text-slate-400 font-extrabold">Mind</div>
            <div class="mt-1 text-base font-extrabold text-white">心智 / 靈修</div>
            <div class="mt-2 text-[11px] text-slate-400 font-semibold">閱讀 / 反思 / 經文</div>
          </button>

          <button onclick="navTo('calendar')" class="glass2 rounded-2xl p-4 border border-white/10 shadow-glass text-left active:scale-[0.99] transition-transform col-span-2">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-[10px] tracking-widest uppercase text-slate-400 font-extrabold">Evolution</div>
                <div class="mt-1 text-base font-extrabold text-white">日曆</div>
              </div>
              <span class="ms text-[18px] text-slate-300">calendar_month</span>
            </div>
            <div class="mt-2 text-[11px] text-slate-400 font-semibold">查看每日紀錄 / streak</div>
          </button>
        </div>

        <button id="btn-settle" class="w-full glass2 rounded-2xl px-4 py-3 border border-violet/25 shadow-glow active:scale-[0.99] transition-transform">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-extrabold text-white">結算今天</div>
              <div class="text-[11px] text-slate-400 font-semibold">70% 以上會額外加成</div>
            </div>
            <div class="text-right">
              <div class="text-[10px] text-slate-300 font-extrabold tracking-widest">EST</div>
              <div class="text-base font-extrabold text-gold">+<span id="hub-xp-est">0</span></div>
            </div>
          </div>
        </button>
      </main>
    </section>

    <!-- BODY -->
    <section id="view-body" class="hidden flex-col flex-1 fade-in">
      <header class="pt-10 px-4 pb-3">
        <div class="flex items-center justify-between">
          <button onclick="navTo('hub')" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
            <span class="ms text-[18px]">chevron_left</span>
          </button>
          <div class="text-center">
            <div class="text-[10px] tracking-[0.22em] uppercase text-slate-400 font-extrabold">Body Evolution</div>
            <div class="mt-1 text-lg font-extrabold text-white">身體進化</div>
          </div>
          <button onclick="goToday()" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
            <span class="ms text-[18px]">today</span>
          </button>
        </div>

        <div class="mt-3 flex items-center justify-between">
          <div class="glass2 px-3 py-1.5 rounded-full border border-white/10 text-[11px] text-slate-200 font-semibold">
            <span id="body-date">Today</span>
          </div>
          <div class="glass2 px-3 py-1.5 rounded-full border border-white/10 text-[11px] text-slate-200 font-semibold">
            完成 <span class="ml-1 text-white font-extrabold"><span id="body-completion">0</span>%</span>
          </div>
        </div>
      </header>

      <main class="px-4 pb-6 flex-1 overflow-y-auto no-scrollbar space-y-3">
        <!-- Water (compact) -->
        <section class="glass rounded-2xl p-4 shadow-glass">
          <div class="flex items-start justify-between">
            <div>
              <div class="text-[10px] tracking-widest uppercase text-slate-400 font-extrabold">Hydration</div>
              <div class="mt-1 text-base font-extrabold text-white">水分</div>
              <div class="mt-1 text-[11px] text-slate-400 font-semibold">目標 <span id="water-goal">1900</span>ml</div>
              <div class="mt-1 text-[10px] text-slate-400 font-semibold" id="water-points-hint">0/25</div>
            </div>
            <div class="text-right">
              <div class="text-2xl font-extrabold text-white"><span id="water-val">0</span></div>
              <div class="text-[11px] text-slate-400 font-semibold">ml</div>
            </div>
          </div>

          <div class="mt-3 h-2.5 w-full rounded-full bg-white/5 border border-white/10 overflow-hidden">
            <div id="water-bar" class="h-full w-[0%] bg-gradient-to-r from-cyan via-violet2 to-gold rounded-full transition-all duration-500"></div>
          </div>

          <div class="mt-3 grid grid-cols-3 gap-2">
            <button onclick="modifyWater(-250)" class="glass2 border border-white/10 rounded-xl py-2 text-[12px] font-extrabold text-slate-200 active:scale-95 transition-transform">-250</button>
            <button onclick="modifyWater(250)" class="glass2 border border-white/10 rounded-xl py-2 text-[12px] font-extrabold text-white active:scale-95 transition-transform">+250</button>
            <button onclick="modifyWater(500)" class="rounded-xl py-2 text-[12px] font-black text-ink bg-gradient-to-r from-gold via-gold2 to-gold shadow-gold active:scale-95 transition-transform">+500</button>
          </div>
        </section>

        <!-- Tasks -->
        <section class="space-y-2">
          <div class="flex items-center justify-between px-1">
            <div class="text-sm font-extrabold text-white">任務</div>
            <div class="text-[10px] text-slate-400 font-extrabold tracking-widest">TAP SAFE</div>
          </div>
          <div id="task-list" class="space-y-2"></div>
        </section>

        <!-- Bowel -->
        <section class="glass rounded-2xl p-4 shadow-glass">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-[10px] tracking-widest uppercase text-slate-400 font-extrabold">Health</div>
              <div class="mt-1 text-base font-extrabold text-white">排便</div>
              <div class="mt-1 text-[10px] text-slate-400 font-semibold">正常才 +10</div>
            </div>
            <div class="flex items-center gap-2">
              <button onclick="setBowel('未完成')" id="bowel-a" class="glass2 border border-white/10 rounded-full px-3 py-2 text-[12px] font-extrabold text-slate-200 active:scale-95 transition-transform">未完成</button>
              <button onclick="setBowel('正常')" id="bowel-b" class="glass2 border border-white/10 rounded-full px-3 py-2 text-[12px] font-extrabold text-slate-200 active:scale-95 transition-transform">正常</button>
            </div>
          </div>
        </section>
      </main>
    </section>

    <!-- MIND -->
    <section id="view-mind" class="hidden flex-col flex-1 fade-in">
      <header class="pt-10 px-4 pb-3">
        <div class="flex items-center justify-between">
          <button onclick="navTo('hub')" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
            <span class="ms text-[18px]">chevron_left</span>
          </button>
          <div class="text-center">
            <div class="text-[10px] tracking-[0.22em] uppercase text-slate-400 font-extrabold">Mind & Spirit</div>
            <div class="mt-1 text-lg font-extrabold text-white">心智與靈修</div>
          </div>
          <button onclick="goToday()" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
            <span class="ms text-[18px]">today</span>
          </button>
        </div>

        <div class="mt-3 flex items-center justify-between">
          <div class="glass2 px-3 py-1.5 rounded-full border border-white/10 text-[11px] text-slate-200 font-semibold">
            <span id="mind-date">Today</span>
          </div>
          <div class="glass2 px-3 py-1.5 rounded-full border border-white/10 text-[11px] text-slate-200 font-semibold">
            完成 <span class="ml-1 text-white font-extrabold"><span id="mind-completion">0</span>%</span>
          </div>
        </div>
      </header>

      <main class="px-4 pb-6 flex-1 overflow-y-auto no-scrollbar">
        <!-- Tabs -->
        <div class="glass2 rounded-full p-1 border border-white/10 flex relative">
          <div id="tab-slider" class="absolute left-1 top-1 bottom-1 w-[calc(50%-4px)] bg-gradient-to-r from-violet to-violet2 rounded-full shadow-glow transition-transform duration-300"></div>
          <button id="tab-btn-mind" onclick="switchTab('mind')" class="flex-1 relative z-10 py-2 text-[13px] font-black text-white text-center rounded-full">心智</button>
          <button id="tab-btn-spirit" onclick="switchTab('spirit')" class="flex-1 relative z-10 py-2 text-[13px] font-extrabold text-slate-300 text-center rounded-full">靈修</button>
        </div>

        <div id="tab-mind" class="mt-3 space-y-3">
          <!-- Reading timer (fixed start/pause logic) -->
          <section class="glass rounded-2xl p-4 shadow-glass">
            <div class="flex items-start justify-between">
              <div>
                <div class="text-[10px] tracking-widest uppercase text-slate-400 font-extrabold">Focus</div>
                <div class="mt-1 text-base font-extrabold text-white">深度閱讀</div>
                <div class="mt-1 text-[10px] text-slate-400 font-semibold">完成 +10；取消 -10</div>
              </div>
              <button onclick="toggleDone('reading')" id="reading-done-btn"
                      class="glass2 border border-white/10 rounded-full px-3 py-2 text-[12px] font-black text-white active:scale-95 transition-transform">
                完成
              </button>
            </div>

            <div class="mt-3 flex items-center justify-between">
              <button onclick="openDuration('reading')" class="glass2 border border-white/10 rounded-full px-3 py-2 text-[12px] font-extrabold text-slate-200 active:scale-95 transition-transform">
                <span id="reading-min">20</span> min
              </button>
              <button onclick="resetTimer('reading')" class="glass2 border border-white/10 rounded-full px-3 py-2 text-[12px] font-extrabold text-slate-200 active:scale-95 transition-transform">
                重置
              </button>
            </div>

            <div class="mt-3 flex items-center justify-center">
              <div id="reading-display" class="text-5xl font-light tracking-tighter tabular-nums text-white">20:00</div>
            </div>

            <div class="mt-3 grid grid-cols-2 gap-2">
              <button id="reading-start" onclick="toggleTimer('reading')"
                      class="rounded-xl py-2.5 text-[12px] font-black text-white bg-gradient-to-r from-violet via-violet2 to-cyan border border-white/10 active:scale-95 transition-transform">
                開始
              </button>
              <button onclick="cancelTimer('reading')" class="glass2 border border-white/10 rounded-xl py-2.5 text-[12px] font-extrabold text-slate-200 active:scale-95 transition-transform">
                取消
              </button>
            </div>
          </section>

          <section class="glass2 rounded-2xl p-4 border border-white/10 shadow-glass">
            <div class="text-[10px] tracking-widest uppercase text-slate-400 font-extrabold">Reflection</div>
            <div class="mt-1 text-base font-extrabold text-white">今日反思</div>
            <div class="mt-1 text-[10px] text-slate-400 font-semibold">寫了就 +10</div>
            <input id="growth-input" class="mt-3 w-full rounded-xl bg-white/5 border border-white/10 text-white placeholder:text-slate-500 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet/40"
                   placeholder="一句話也可以…" />
          </section>

          <section class="glass2 rounded-2xl p-4 border border-white/10 shadow-glass">
            <div class="text-[10px] tracking-widest uppercase text-slate-400 font-extrabold">Notes</div>
            <div class="mt-1 text-base font-extrabold text-white">品牌策略筆記</div>
            <div class="mt-1 text-[10px] text-slate-400 font-semibold">寫了就 +10</div>
            <textarea id="brand-input" class="mt-3 w-full h-28 rounded-xl bg-white/5 border border-white/10 text-white placeholder:text-slate-500 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet/40 resize-none"
                      placeholder="記一個重點就好"></textarea>
          </section>
        </div>

        <div id="tab-spirit" class="hidden mt-3 space-y-3">
          <!-- Devotion timer -->
          <section class="glass rounded-2xl p-4 shadow-glass">
            <div class="flex items-start justify-between">
              <div>
                <div class="text-[10px] tracking-widest uppercase text-slate-400 font-extrabold">Silence</div>
                <div class="mt-1 text-base font-extrabold text-white">靜默靈修</div>
                <div class="mt-1 text-[10px] text-slate-400 font-semibold">完成 +10；取消 -10</div>
              </div>
              <button onclick="toggleDone('devotion')" id="devotion-done-btn"
                      class="glass2 border border-white/10 rounded-full px-3 py-2 text-[12px] font-black text-white active:scale-95 transition-transform">
                完成
              </button>
            </div>

            <div class="mt-3 flex items-center justify-between">
              <button onclick="openDuration('devotion')" class="glass2 border border-white/10 rounded-full px-3 py-2 text-[12px] font-extrabold text-slate-200 active:scale-95 transition-transform">
                <span id="devotion-min">10</span> min
              </button>
              <button onclick="resetTimer('devotion')" class="glass2 border border-white/10 rounded-full px-3 py-2 text-[12px] font-extrabold text-slate-200 active:scale-95 transition-transform">
                重置
              </button>
            </div>

            <div class="mt-3 flex items-center justify-center">
              <div id="devotion-display" class="text-5xl font-light tracking-tighter tabular-nums text-white">10:00</div>
            </div>

            <div class="mt-3 grid grid-cols-2 gap-2">
              <button id="devotion-start" onclick="toggleTimer('devotion')"
                      class="rounded-xl py-2.5 text-[12px] font-black text-white bg-gradient-to-r from-violet via-violet2 to-cyan border border-white/10 active:scale-95 transition-transform">
                開始
              </button>
              <button onclick="cancelTimer('devotion')" class="glass2 border border-white/10 rounded-xl py-2.5 text-[12px] font-extrabold text-slate-200 active:scale-95 transition-transform">
                取消
              </button>
            </div>
          </section>

          <section class="glass2 rounded-2xl p-4 border border-white/10 shadow-glass">
            <div class="text-[10px] tracking-widest uppercase text-slate-400 font-extrabold">Scripture</div>
            <div class="mt-1 text-base font-extrabold text-white">經文與領受</div>
            <div class="mt-1 text-[10px] text-slate-400 font-semibold">填了就 +10</div>

            <input id="scripture-input" class="mt-3 w-full rounded-xl bg-white/5 border border-white/10 text-white placeholder:text-slate-500 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet/40"
                   placeholder="Psalm 23:1" />
            <textarea id="spirit-input" class="mt-3 w-full h-28 rounded-xl bg-white/5 border border-white/10 text-white placeholder:text-slate-500 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet/40 resize-none"
                      placeholder="一句領受也可以"></textarea>
          </section>
        </div>
      </main>
    </section>

    <!-- CALENDAR ✅ FULL (monthly view + day details) -->
    <section id="view-calendar" class="hidden flex-col flex-1 fade-in">
      <header class="pt-10 px-4 pb-3">
        <div class="flex items-center justify-between">
          <button onclick="navTo('hub')" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
            <span class="ms text-[18px]">chevron_left</span>
          </button>
          <div class="text-center">
            <div class="text-[10px] tracking-[0.22em] uppercase text-slate-400 font-extrabold">Evolution</div>
            <div class="mt-1 text-lg font-extrabold text-white">日曆</div>
          </div>
          <button onclick="goToday()" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
            <span class="ms text-[18px]">today</span>
          </button>
        </div>

        <div class="mt-3 glass rounded-2xl p-3 shadow-glass">
          <div class="flex items-center justify-between">
            <button onclick="calShift(-1)" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
              <span class="ms text-[18px]">chevron_left</span>
            </button>
            <div class="text-sm font-extrabold text-white tracking-wider">
              <span id="cal-title">2026-02</span>
            </div>
            <button onclick="calShift(1)" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
              <span class="ms text-[18px]">chevron_right</span>
            </button>
          </div>

          <div class="mt-3 grid grid-cols-7 gap-1 text-center">
            <div class="text-[10px] text-slate-400 font-extrabold">日</div>
            <div class="text-[10px] text-slate-400 font-extrabold">一</div>
            <div class="text-[10px] text-slate-400 font-extrabold">二</div>
            <div class="text-[10px] text-slate-400 font-extrabold">三</div>
            <div class="text-[10px] text-slate-400 font-extrabold">四</div>
            <div class="text-[10px] text-slate-400 font-extrabold">五</div>
            <div class="text-[10px] text-slate-400 font-extrabold">六</div>
          </div>

          <div id="cal-grid" class="mt-2 grid grid-cols-7 gap-1"></div>

          <div class="mt-3 flex items-center justify-between text-[10px] text-slate-400 font-extrabold">
            <div class="flex items-center gap-2">
              <span class="inline-block w-2 h-2 rounded-full bg-gold shadow-gold"></span> 70%+
            </div>
            <div class="flex items-center gap-2">
              <span class="inline-block w-2 h-2 rounded-full bg-violet2 shadow-glow"></span> 已結算
            </div>
          </div>
        </div>
      </header>

      <main class="px-4 pb-6 flex-1 overflow-y-auto no-scrollbar space-y-3">
        <section class="glass2 rounded-2xl p-4 border border-white/10 shadow-glass">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-[10px] tracking-widest uppercase text-slate-400 font-extrabold">Selected</div>
              <div class="mt-1 text-base font-extrabold text-white" id="cal-selected">—</div>
              <div class="mt-1 text-[10px] text-slate-400 font-semibold">點日期即可切換到該天</div>
            </div>
            <button onclick="useSelectedDate()" class="rounded-xl px-4 py-2 text-[12px] font-black text-white bg-gradient-to-r from-violet via-violet2 to-cyan border border-white/10 active:scale-95 transition-transform">
              前往
            </button>
          </div>

          <div class="mt-3 grid grid-cols-3 gap-2 text-center">
            <div class="glass2 rounded-xl border border-white/10 py-2">
              <div class="text-[10px] text-slate-400 font-extrabold tracking-widest">COMP</div>
              <div class="text-lg font-extrabold text-white"><span id="cal-comp">0</span>%</div>
            </div>
            <div class="glass2 rounded-xl border border-white/10 py-2">
              <div class="text-[10px] text-slate-400 font-extrabold tracking-widest">XP</div>
              <div class="text-lg font-extrabold text-gold">+<span id="cal-xp">0</span></div>
            </div>
            <div class="glass2 rounded-xl border border-white/10 py-2">
              <div class="text-[10px] text-slate-400 font-extrabold tracking-widest">SET</div>
              <div class="text-lg font-extrabold text-white"><span id="cal-settled">NO</span></div>
            </div>
          </div>
        </section>

        <section class="glass rounded-2xl p-4 shadow-glass">
          <div class="text-sm font-extrabold text-white">當天摘要</div>
          <div class="mt-2 text-[11px] text-slate-400 font-semibold leading-relaxed" id="cal-summary">
            —
          </div>
        </section>
      </main>
    </section>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 left-0 right-0 z-50 flex justify-center nav-safe">
      <div class="glass mx-auto w-[92%] max-w-[390px] rounded-full flex justify-between items-center py-3 px-6 shadow-glass border border-white/10 bg-obsidian/80">
        <button onclick="navTo('hub')" class="navbtn flex flex-col items-center gap-1 w-16" data-view="hub">
          <span class="ms fill text-[22px]" id="nav-ico-hub">dashboard</span>
          <span class="text-[10px] font-black" id="nav-txt-hub">Hub</span>
        </button>
        <button onclick="navTo('body')" class="navbtn flex flex-col items-center gap-1 w-16 opacity-70" data-view="body">
          <span class="ms text-[22px]" id="nav-ico-body">fitness_center</span>
          <span class="text-[10px] font-extrabold" id="nav-txt-body">Body</span>
        </button>
        <button onclick="navTo('mind')" class="navbtn flex flex-col items-center gap-1 w-16 opacity-70" data-view="mind">
          <span class="ms text-[22px]" id="nav-ico-mind">auto_stories</span>
          <span class="text-[10px] font-extrabold" id="nav-txt-mind">Mind</span>
        </button>
        <button onclick="navTo('calendar')" class="navbtn flex flex-col items-center gap-1 w-16 opacity-70" data-view="calendar">
          <span class="ms text-[22px]" id="nav-ico-calendar">calendar_month</span>
          <span class="text-[10px] font-extrabold" id="nav-txt-calendar">Evo</span>
        </button>
      </div>
    </nav>
  </div>

  <!-- Modals -->
  <div id="modal-profile" class="hidden fixed inset-0 z-[80]">
    <div class="absolute inset-0 bg-black/55"></div>
    <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[92%] max-w-md glass rounded-2xl p-4 border border-white/10 shadow-glass">
      <div class="flex items-center justify-between">
        <div class="text-base font-black text-white">個人設定</div>
        <button onclick="closeModal('modal-profile')" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
          <span class="ms text-[18px]">close</span>
        </button>
      </div>

      <div class="mt-3 space-y-2">
        <div>
          <label class="text-[10px] text-slate-400 font-extrabold">名字</label>
          <input id="inp-name" class="mt-1.5 w-full rounded-xl bg-white/5 border border-white/10 text-white px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet/40"/>
        </div>
        <div>
          <label class="text-[10px] text-slate-400 font-extrabold">頭像 URL</label>
          <input id="inp-avatar" class="mt-1.5 w-full rounded-xl bg-white/5 border border-white/10 text-white px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet/40" placeholder="https://..."/>
        </div>
        <div>
          <label class="text-[10px] text-slate-400 font-extrabold">標題</label>
          <input id="inp-title" class="mt-1.5 w-full rounded-xl bg-white/5 border border-white/10 text-white px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet/40"/>
        </div>

        <div class="grid grid-cols-2 gap-2 mt-2">
          <button onclick="saveProfile()" class="rounded-xl py-3 font-black text-ink bg-gradient-to-r from-gold via-gold2 to-gold shadow-gold active:scale-95 transition-transform">保存</button>
          <button onclick="confirmReset()" class="glass2 border border-white/10 rounded-xl py-3 font-black text-white active:scale-95 transition-transform">系統重置</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modal-duration" class="hidden fixed inset-0 z-[90]">
    <div class="absolute inset-0 bg-black/55"></div>
    <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[92%] max-w-md glass rounded-2xl p-4 border border-white/10 shadow-glass">
      <div class="flex items-center justify-between">
        <div class="text-base font-black text-white">設定倒數</div>
        <button onclick="closeModal('modal-duration')" class="glass2 border border-white/10 rounded-full px-3 py-2 active:scale-95 transition-transform">
          <span class="ms text-[18px]">close</span>
        </button>
      </div>

      <div class="mt-3">
        <div class="text-[12px] text-slate-200 font-black" id="dur-title">—</div>

        <div class="mt-2 glass2 rounded-xl border border-white/10 p-3">
          <label class="text-[10px] text-slate-400 font-extrabold">分鐘（1–180）</label>
          <input id="dur-min" type="number" min="1" max="180"
                 class="mt-1.5 w-full rounded-xl bg-white/5 border border-white/10 text-white px-4 py-3 focus:outline-none focus:ring-2 focus:ring-violet/40"/>
          <div class="mt-2 grid grid-cols-4 gap-2">
            <button onclick="quickMin(5)" class="glass2 border border-white/10 rounded-lg py-2 text-[12px] font-black text-white active:scale-95 transition-transform">5</button>
            <button onclick="quickMin(10)" class="glass2 border border-white/10 rounded-lg py-2 text-[12px] font-black text-white active:scale-95 transition-transform">10</button>
            <button onclick="quickMin(20)" class="glass2 border border-white/10 rounded-lg py-2 text-[12px] font-black text-white active:scale-95 transition-transform">20</button>
            <button onclick="quickMin(30)" class="glass2 border border-white/10 rounded-lg py-2 text-[12px] font-black text-white active:scale-95 transition-transform">30</button>
          </div>
        </div>

        <button onclick="applyDuration()" class="mt-3 w-full rounded-xl py-3 font-black text-white bg-gradient-to-r from-violet via-violet2 to-cyan border border-white/10 shadow-glow active:scale-95 transition-transform">
          套用
        </button>
      </div>
    </div>
  </div>

  <script>
    /***************
     * Safe helpers
     ***************/
    const $ = (id)=> document.getElementById(id);
    const setText = (id, v)=> { const el=$(id); if(el) el.textContent = v; };
    const setWidth = (id, pct)=> { const el=$(id); if(el) el.style.width = pct; };

    /***************
     * Config
     ***************/
    const STORAGE_KEY = "ate_mobile_ultra_v3";
    const DEFAULT_AVATAR = "https://lh3.googleusercontent.com/aida-public/AB6AXuCAYOzNGEzdDG66QmmNGCUlkdnwk7zJo0-6al0p4StVVrRy7UvwIFfnSbzk1yro93SGmClDJXzHkeK0f3pOKlJ7_0wH9VzNbQ3ATQRP2P4Msi2j3L88v-cPqgWfProkys6HXeVgnOq9poVFtfNyxvn9pqj2xho4IOb0kutPRkMrNn2qgl6IG3CfgZJFN6h_2N_KyQQzgP3uX0T6tGAkUnEDgaVjHUIXMZVxocw3H1i2okCF0BovjWGbicSrh5A42xuvBTiOpnUCuI0";

    const VERSES_EN = [
      { t: "Be strong and courageous. Do not be afraid; do not be discouraged, for the Lord your God will be with you wherever you go.", r: "Joshua 1:9" },
      { t: "Commit your way to the Lord; trust in Him, and He will act.", r: "Psalm 37:5" },
      { t: "Be still, and know that I am God.", r: "Psalm 46:10" },
      { t: "The Lord is my shepherd; I shall not want.", r: "Psalm 23:1" },
      { t: "Give thanks in all circumstances.", r: "1 Thessalonians 5:18" },
      { t: "Commit your work to the Lord, and your plans will be established.", r: "Proverbs 16:3" },
      { t: "Do not be anxious about anything; in every situation, by prayer and petition, with thanksgiving, present your requests to God.", r: "Philippians 4:6" },
      { t: "Let us not grow weary in doing good; in due season we will reap, if we do not give up.", r: "Galatians 6:9" },
    ];

    // ✅ FIX: points sign logic (done = +, cancel = -)
    const POINTS = {
      waterMax: 25,
      taskTimerEach: 10,
      taskCheck: 10,
      bowel: 10,
      reading: 10,
      devotion: 10,
      growth: 10,
      brand: 10,
      scripture: 10,
    };

    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
    function todayKey(){
      const d=new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }
    function formatKey(key){
      const [y,m,d]=key.split("-");
      return `${y}年${m}月${d}日`;
    }
    function tickLabel(sec){
      const s = Math.max(0, Math.floor(sec));
      const m = Math.floor(s/60);
      const r = s%60;
      return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;
    }

    function freshState(){
      return {
        profile:{ name:"覺醒女神", title:"Aether Trinity Evolution", avatar: DEFAULT_AVATAR },
        gamification:{ level:1, xp:0, xpMax:100 },
        ui:{
          view:"hub",
          activeDate: todayKey(),
          mindTab:"mind",
          selectedDate: todayKey(),
          calYm: (()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; })(),
        },
        days:{}
      };
    }

    function defaultDay(dateKey){
      return {
        date: dateKey,
        waterGoalMl: 1900,
        waterMl: 0,
        bowelStatus: "未完成",
        tasks: [
          { id: 1, type: "timer", title: "深蹲練習", sub: "核心肌群", minutes: 15, remainingSec: 15*60, running: false, done: false },
          { id: 2, type: "timer", title: "每日肌肉訓練", sub: "30 分鐘", minutes: 30, remainingSec: 30*60, running: false, done: false },
          { id: 3, type: "check", title: "健康早餐", sub: "建議 08:30 AM", done: false },
        ],
        reading: { minutes: 20, remainingSec: 20*60, running: false, done: false },
        devotion:{ minutes: 10, remainingSec: 10*60, running: false, done: false },
        mind:{ growth:"", brand:"" },
        spirit:{ scripture:"", note:"" },
        settle:{ settled:false, xpAwarded:0, percentAtSettle:0 }
      };
    }

    function normalizeDay(day, dateKey){
      const base = defaultDay(dateKey);
      const d = Object.assign({}, base, day || {});
      d.tasks = Array.isArray(d.tasks) ? d.tasks : base.tasks;
      d.tasks = d.tasks.map((t,i)=>{
        if(t.type==="timer"){
          const m = Number(t.minutes || 10);
          const rem = Number.isFinite(t.remainingSec) ? t.remainingSec : m*60;
          return { ...t, id: t.id ?? (i+1), minutes:m, remainingSec: rem, running: !!t.running, done: !!t.done };
        }
        return { ...t, id: t.id ?? (i+1), done: !!t.done };
      });
      d.reading = d.reading || base.reading;
      d.devotion = d.devotion || base.devotion;
      d.reading = { minutes:Number(d.reading.minutes||20), remainingSec:Number.isFinite(d.reading.remainingSec)?d.reading.remainingSec:d.reading.minutes*60, running:!!d.reading.running, done:!!d.reading.done };
      d.devotion = { minutes:Number(d.devotion.minutes||10), remainingSec:Number.isFinite(d.devotion.remainingSec)?d.devotion.remainingSec:d.devotion.minutes*60, running:!!d.devotion.running, done:!!d.devotion.done };
      d.mind = d.mind || { growth:"", brand:"" };
      d.spirit = d.spirit || { scripture:"", note:"" };
      d.settle = d.settle || { settled:false, xpAwarded:0, percentAtSettle:0 };
      return d;
    }

    function loadState(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){
        const s = JSON.parse(raw);
        Object.keys(s.days||{}).forEach(k=> s.days[k]=normalizeDay(s.days[k],k));
        return s;
      }
      const s = freshState();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
      return s;
    }

    const state = loadState();
    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    function activeKey(){ return state.ui.activeDate || todayKey(); }
    function ensureDay(key){
      if(!state.days[key]) state.days[key] = defaultDay(key);
      state.days[key] = normalizeDay(state.days[key], key);
      return state.days[key];
    }

    /***************
     * Game feedback
     ***************/
    function popScore(delta){
      const el = document.createElement("div");
      el.className = "pop";
      const good = delta >= 0;
      el.innerHTML = `<div class="popBadge" style="color:${good?'#A3E635':'#FB7185'}">${good?'+':''}${delta}</div>`;
      document.body.appendChild(el);
      setTimeout(()=> el.remove(), 900);
      try{ navigator.vibrate && navigator.vibrate(10); }catch(e){}
    }

    function toastMini(text){
      const el = document.createElement("div");
      el.className = "toast";
      el.innerHTML = `<div class="glass2 border border-white/10 shadow-glass rounded-full px-4 py-2 text-[12px] font-extrabold text-white">${text}</div>`;
      document.body.appendChild(el);
      setTimeout(()=> el.remove(), 2000);
    }

    /***************
     * Completion + XP
     ***************/
    function pointsBreakdown(day){
      const waterRatio = clamp(day.waterGoalMl ? day.waterMl / day.waterGoalMl : 0, 0, 1);
      const waterPts = Math.round(POINTS.waterMax * waterRatio);

      let taskPts = 0;
      let taskTotal = 0;
      day.tasks.forEach(t=>{
        const each = (t.type==="timer") ? POINTS.taskTimerEach : POINTS.taskCheck;
        taskTotal += each;
        if(t.done) taskPts += each;
      });

      const bowelPts = (day.bowelStatus === "正常") ? POINTS.bowel : 0;
      const readingPts = day.reading.done ? POINTS.reading : 0;
      const devotionPts = day.devotion.done ? POINTS.devotion : 0;
      const growthPts = day.mind.growth.trim() ? POINTS.growth : 0;
      const brandPts  = day.mind.brand.trim()  ? POINTS.brand  : 0;
      const scripturePts = (day.spirit.scripture.trim() || day.spirit.note.trim()) ? POINTS.scripture : 0;

      const totalPts = POINTS.waterMax + taskTotal + POINTS.bowel + POINTS.reading + POINTS.devotion + POINTS.growth + POINTS.brand + POINTS.scripture;
      const gotPts = waterPts + taskPts + bowelPts + readingPts + devotionPts + growthPts + brandPts + scripturePts;

      return { waterRatio, waterPts, taskPts, totalPts, gotPts };
    }

    function computeCompletion(day){
      const p = pointsBreakdown(day);
      const ratio = p.totalPts ? (p.gotPts / p.totalPts) : 0;
      const percent = Math.round(ratio * 100);
      const perfect = ratio >= 0.70;

      let xp = 30 + Math.round(170 * ratio);
      if(perfect) xp += 20;
      xp = clamp(xp, 0, 220);
      return { ratio, percent, perfect, xp, points: p };
    }

    function computeStreak(){
      let streak = 0;
      let k = todayKey();
      while(true){
        const day = ensureDay(k);
        const c = computeCompletion(day);
        if(!c.perfect) break;
        streak++;
        const d = new Date(k+"T00:00:00");
        d.setDate(d.getDate()-1);
        k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      }
      return streak;
    }

    /***************
     * Navigation
     ***************/
    function navTo(view){
      state.ui.view = view;
      save();
      renderAll();
    }
    function switchTab(tab){
      state.ui.mindTab = tab;
      save();
      renderMindTabs();
    }
    function goToday(){
      state.ui.activeDate = todayKey();
      state.ui.selectedDate = todayKey();
      const d = new Date();
      state.ui.calYm = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      save();
      renderAll();
      toastMini("已回到今天");
    }

    /***************
     * Profile modal
     ***************/
    function openModal(id){
      const el=$(id); if(!el) return;
      el.classList.remove("hidden");
      document.body.style.overflow="hidden";
    }
    function closeModal(id){
      const el=$(id); if(!el) return;
      el.classList.add("hidden");
      document.body.style.overflow="";
    }
    function saveProfile(){
      const name = ($("inp-name")?.value || "").trim() || "覺醒女神";
      const avatar = ($("inp-avatar")?.value || "").trim() || DEFAULT_AVATAR;
      const title = ($("inp-title")?.value || "").trim() || "Aether Trinity Evolution";
      state.profile.name = name;
      state.profile.avatar = avatar;
      state.profile.title = title;
      save();
      closeModal("modal-profile");
      renderProfile();
      toastMini("已保存");
    }
    function confirmReset(){
      const ok = confirm("【系統重置】確定清除所有紀錄？");
      if(!ok) return;
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }

    /***************
     * Body actions
     ***************/
    function modifyWater(delta){
      const d = ensureDay(activeKey());
      const before = computeCompletion(d).points.waterPts;
      d.waterMl = Math.max(0, d.waterMl + delta);
      const after = computeCompletion(d).points.waterPts;
      save();
      renderAll();
      popScore(after - before);
    }

    function setBowel(val){
      const d = ensureDay(activeKey());
      const before = (d.bowelStatus==="正常") ? POINTS.bowel : 0;
      d.bowelStatus = val;
      const after = (d.bowelStatus==="正常") ? POINTS.bowel : 0;
      save();
      renderAll();
      popScore(after - before);
    }

    function toggleCheckTask(id){
      const d = ensureDay(activeKey());
      const t = d.tasks.find(x=>x.id===id);
      if(!t) return;
      t.done = !t.done;
      save();
      renderAll();
      popScore(t.done ? +POINTS.taskCheck : -POINTS.taskCheck);
    }

    /***************
     * ✅ FIX: Timers - start works, only one running, pause/resume stable
     ***************/
    let tickHandle = null;

    function startTick(){
      if(tickHandle) return;
      tickHandle = setInterval(()=>{
        const day = ensureDay(activeKey());
        let changed=false;

        // tasks timers
        day.tasks.forEach(t=>{
          if(t.type==="timer" && t.running && !t.done){
            t.remainingSec = Math.max(0, t.remainingSec - 1);
            changed=true;
            if(t.remainingSec === 0){
              t.running=false;
              t.done=true;
              save();
              renderAll();
              popScore(+POINTS.taskTimerEach);
            }
          }
        });

        // reading
        if(day.reading.running && !day.reading.done){
          day.reading.remainingSec = Math.max(0, day.reading.remainingSec - 1);
          changed=true;
          if(day.reading.remainingSec === 0){
            day.reading.running=false; day.reading.done=true;
            save(); renderAll(); popScore(+POINTS.reading);
          }
        }
        // devotion
        if(day.devotion.running && !day.devotion.done){
          day.devotion.remainingSec = Math.max(0, day.devotion.remainingSec - 1);
          changed=true;
          if(day.devotion.remainingSec === 0){
            day.devotion.running=false; day.devotion.done=true;
            save(); renderAll(); popScore(+POINTS.devotion);
          }
        }

        if(changed){
          save();
          renderTimersOnly();
          renderCompletionOnly();
        }
      }, 1000);
    }

    function stopAllRunning(day){
      day.tasks.forEach(t=>{ if(t.type==="timer") t.running=false; });
      day.reading.running=false;
      day.devotion.running=false;
    }

    function toggleTimer(kind, id){
      const day = ensureDay(activeKey());
      let ref=null;

      if(kind==="reading"){ ref=day.reading; }
      else if(kind==="devotion"){ ref=day.devotion; }
      else if(kind==="task"){ ref=day.tasks.find(t=>t.id===id); }
      if(!ref) return;

      // cannot start if done (need cancel)
      if(ref.done){
        toastMini("已完成，先取消才可重新計時");
        return;
      }

      // if currently running -> pause
      if(ref.running){
        ref.running=false;
        save();
        renderAll();
        toastMini("暫停");
        return;
      }

      // start: stop others
      stopAllRunning(day);

      // if remaining is 0 (fresh start), restore full duration
      if(ref.remainingSec<=0){
        const mins = Number(ref.minutes||10);
        ref.remainingSec = mins*60;
      }

      ref.running=true;
      save();
      renderAll();
      startTick();
      toastMini("開始");
    }

    // ✅ FIX: Done / Cancel scoring direction
    function toggleDone(kind, id){
      const day = ensureDay(activeKey());
      let ref=null, pts=0;

      if(kind==="reading"){ ref=day.reading; pts=POINTS.reading; }
      else if(kind==="devotion"){ ref=day.devotion; pts=POINTS.devotion; }
      else if(kind==="task"){ ref=day.tasks.find(t=>t.id===id); pts=POINTS.taskTimerEach; }
      if(!ref) return;

      const next = !ref.done;
      ref.done = next;
      ref.running = false;

      if(next){
        ref.remainingSec = 0;
        popScore(+pts);
      }else{
        ref.remainingSec = Number(ref.minutes||10)*60;
        popScore(-pts);
      }

      save();
      renderAll();
    }

    function cancelTimer(kind, id){
      const day = ensureDay(activeKey());
      let ref=null, pts=0;

      if(kind==="reading"){ ref=day.reading; pts=POINTS.reading; }
      else if(kind==="devotion"){ ref=day.devotion; pts=POINTS.devotion; }
      else if(kind==="task"){ ref=day.tasks.find(t=>t.id===id); pts=POINTS.taskTimerEach; }
      if(!ref) return;

      // cancel means: back to not done, reset time, and if it WAS done, deduct points
      const wasDone = ref.done;
      ref.running=false;
      ref.done=false;
      ref.remainingSec = Number(ref.minutes||10)*60;

      save();
      renderAll();
      if(wasDone) popScore(-pts); else toastMini("已取消");
    }

    function resetTimer(kind, id){
      const day = ensureDay(activeKey());
      let ref=null;

      if(kind==="reading"){ ref=day.reading; }
      else if(kind==="devotion"){ ref=day.devotion; }
      else if(kind==="task"){ ref=day.tasks.find(t=>t.id===id); }
      if(!ref) return;

      ref.running=false;
      ref.remainingSec = Number(ref.minutes||10)*60;

      save();
      renderAll();
      toastMini("已重置");
    }

    /***************
     * Duration modal
     ***************/
    let durationTarget = null;

    function openDuration(target){
      durationTarget = target;
      const day = ensureDay(activeKey());

      if(target==="reading"){
        setText("dur-title","深度閱讀");
        $("dur-min").value = day.reading.minutes;
      }else if(target==="devotion"){
        setText("dur-title","靜默靈修");
        $("dur-min").value = day.devotion.minutes;
      }else{
        const t = day.tasks.find(x=>x.id===target);
        setText("dur-title", t ? t.title : "任務");
        $("dur-min").value = t ? t.minutes : 10;
      }
      openModal("modal-duration");
    }

    function quickMin(m){ $("dur-min").value = m; }

    function applyDuration(){
      const m = clamp(parseInt($("dur-min").value || "10",10), 1, 180);
      const day = ensureDay(activeKey());

      if(durationTarget==="reading"){
        day.reading.minutes = m;
        day.reading.running=false;
        day.reading.done=false;
        day.reading.remainingSec = m*60;
      }else if(durationTarget==="devotion"){
        day.devotion.minutes = m;
        day.devotion.running=false;
        day.devotion.done=false;
        day.devotion.remainingSec = m*60;
      }else{
        const t = day.tasks.find(x=>x.id===durationTarget);
        if(t && t.type==="timer"){
          t.minutes=m;
          t.running=false;
          t.done=false;
          t.remainingSec=m*60;
        }
      }
      save();
      closeModal("modal-duration");
      renderAll();
      toastMini(`已套用 ${m}min`);
    }

    /***************
     * Calendar
     ***************/
    function ymToDate(ym){
      const [y,m]=ym.split("-").map(Number);
      return new Date(y, m-1, 1);
    }
    function dateToYm(d){
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    }
    function calShift(delta){
      const d = ymToDate(state.ui.calYm);
      d.setMonth(d.getMonth()+delta);
      state.ui.calYm = dateToYm(d);
      save();
      renderCalendar();
    }
    function calBuildDays(ym){
      const first = ymToDate(ym);
      const year = first.getFullYear();
      const month = first.getMonth(); // 0-index
      const startDay = first.getDay(); // 0 Sun
      const daysInMonth = new Date(year, month+1, 0).getDate();
      const cells = [];
      for(let i=0;i<startDay;i++) cells.push(null);
      for(let d=1; d<=daysInMonth; d++){
        const key = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        cells.push(key);
      }
      while(cells.length % 7 !== 0) cells.push(null);
      return cells;
    }
    function setSelectedDate(key){
      state.ui.selectedDate = key;
      save();
      renderCalendar();
    }
    function useSelectedDate(){
      if(!state.ui.selectedDate) return;
      state.ui.activeDate = state.ui.selectedDate;
      save();
      renderAll();
      toastMini("已切換日期");
    }

    /***************
     * Rendering
     ***************/
    function renderAll(){
      ["hub","body","mind","calendar"].forEach(v=>{
        const el = $("view-"+v);
        if(!el) return;
        el.classList.toggle("hidden", state.ui.view !== v);
      });

      // nav highlight
      ["hub","body","mind","calendar"].forEach(v=>{
        const ico = $("nav-ico-"+v);
        const txt = $("nav-txt-"+v);
        const active = state.ui.view === v;
        const btn = ico?.parentElement;
        if(btn) btn.classList.toggle("opacity-70", !active);
        if(ico) ico.className = "ms " + (active ? "fill text-[22px] text-violet2" : "text-[22px] text-slate-300");
        if(txt) txt.className = (active ? "text-[10px] font-black text-white" : "text-[10px] font-extrabold text-slate-400");
      });

      renderProfile();
      renderHub();
      renderBody();
      renderMind();
      renderCalendar();
      bindInputsOnce();
      startTick();
    }

    function renderProfile(){
      setText("profile-name", state.profile.name);
      setText("profile-title", state.profile.title);
      const av = $("profile-avatar"); if(av) av.src = state.profile.avatar || DEFAULT_AVATAR;

      // XP bar
      setText("hub-xp", state.gamification.xp);
      setText("hub-xpmax", state.gamification.xpMax);
      const pct = clamp(state.gamification.xpMax ? (state.gamification.xp/state.gamification.xpMax)*100 : 0, 0, 100);
      setWidth("hub-xpbar", pct.toFixed(0)+"%");

      setText("profile-level-mini", `LV ${state.gamification.level}`);

      const day = ensureDay(activeKey());
      const c = computeCompletion(day);

      setText("profile-completion", `${c.percent}%`);
      setText("profile-xp-est", `${c.xp}`);
      setText("profile-streak", `${computeStreak()}`);

      const settled = day.settle?.settled;
      const settleEl = $("profile-settled");
      if(settleEl){
        settleEl.textContent = settled ? `+${day.settle.xpAwarded}` : "未結算";
        settleEl.className = settled ? "text-[10px] text-lime font-black" : "text-[10px] text-slate-400 font-semibold";
      }
    }

    function renderHub(){
      const key = activeKey();
      const day = ensureDay(key);
      const c = computeCompletion(day);

      setText("hub-date", (key===todayKey()) ? "Today" : key);
      setText("hub-completion", c.percent);
      setText("hub-body-score", c.percent);
      setWidth("hub-body-bar", `${c.percent}%`);
      setText("hub-xp-est", c.xp);

      // Verse EN
      const now = new Date();
      const idx = Math.floor((now - new Date(now.getFullYear(),0,0))/86400000) % VERSES_EN.length;
      setText("daily-verse", "“"+VERSES_EN[idx].t+"”");
      setText("daily-verse-ref", VERSES_EN[idx].r);
    }

    function renderBody(){
      if(state.ui.view !== "body") return;
      const key = activeKey();
      const day = ensureDay(key);
      const c = computeCompletion(day);

      setText("body-date", (key===todayKey()) ? "Today" : formatKey(key));
      setText("body-completion", c.percent);

      setText("water-goal", day.waterGoalMl);
      setText("water-val", day.waterMl);
      setWidth("water-bar", `${Math.round(c.points.waterRatio*100)}%`);
      setText("water-points-hint", `${Math.round(POINTS.waterMax*c.points.waterRatio)}/${POINTS.waterMax}`);

      const a=$("bowel-a"), b=$("bowel-b");
      const on=(btn, active)=>{
        if(!btn) return;
        btn.classList.toggle("bg-white/10", active);
        btn.classList.toggle("border-violet/30", active);
        btn.classList.toggle("text-white", active);
        btn.classList.toggle("text-slate-200", !active);
      };
      on(a, day.bowelStatus==="未完成");
      on(b, day.bowelStatus==="正常");

      // tasks
      const list = $("task-list");
      if(!list) return;

      list.innerHTML = day.tasks.map(t=>{
        if(t.type==="check"){
          return `
            <div class="glass2 rounded-2xl p-3 border border-white/10 shadow-glass">
              <div class="flex items-center justify-between gap-3">
                <div class="min-w-0">
                  <div class="text-[13px] font-black text-white truncate">${escapeHtml(t.title)}</div>
                  <div class="mt-0.5 text-[10px] text-slate-400 font-semibold truncate">${escapeHtml(t.sub)}</div>
                </div>
                <div class="flex items-center gap-2">
                  <div class="text-[11px] font-black ${t.done?'text-lime':'text-slate-400'}">
                    ${t.done?`+${POINTS.taskCheck}`:`0`}
                  </div>
                  <button onclick="toggleCheckTask(${t.id})"
                          class="glass2 border border-white/10 rounded-full w-10 h-10 flex items-center justify-center active:scale-95 transition-transform ${t.done?'bg-violet/15 border-violet/30':''}">
                    <span class="ms ${t.done?'fill text-violet2':'text-slate-300'} text-[20px]">done</span>
                  </button>
                </div>
              </div>
            </div>
          `;
        }

        const running = t.running && !t.done;
        const done = t.done;
        return `
          <div class="glass2 rounded-2xl p-3 border border-white/10 shadow-glass ${running?'ringPulse':''}">
            <div class="flex items-start justify-between gap-2">
              <div class="min-w-0">
                <div class="text-[13px] font-black text-white truncate">${escapeHtml(t.title)}</div>
                <div class="mt-0.5 text-[10px] text-slate-400 font-semibold truncate">${escapeHtml(t.sub)}</div>
                <div class="mt-2 text-3xl font-light tracking-tighter tabular-nums text-white">${tickLabel(t.remainingSec)}</div>
              </div>

              <div class="shrink-0 flex flex-col items-end gap-2">
                <button onclick="openDuration(${t.id})" class="glass2 border border-white/10 rounded-full px-3 py-1.5 text-[11px] font-black text-slate-200 active:scale-95 transition-transform">
                  ${t.minutes}m
                </button>

                <div class="text-[11px] font-black ${done?'text-lime':'text-slate-400'}">
                  ${done?`+${POINTS.taskTimerEach}`:`0`}
                </div>
              </div>
            </div>

            <div class="mt-2 grid grid-cols-3 gap-2">
              <button onclick="toggleTimer('task', ${t.id})"
                      class="rounded-xl py-2 text-[12px] font-black border active:scale-95 transition-transform
                      ${done ? "bg-white/5 text-slate-400 border-white/10 cursor-not-allowed" :
                        (running ? "bg-white text-ink border-white" : "bg-gradient-to-r from-violet via-violet2 to-cyan text-white border-white/10")}"
                      ${done ? "disabled" : ""}>
                ${running?'暫停':'開始'}
              </button>
              <button onclick="toggleDone('task', ${t.id})" class="glass2 border border-white/10 rounded-xl py-2 text-[12px] font-black text-white active:scale-95 transition-transform">
                ${done?'取消完成':'完成'}
              </button>
              <button onclick="cancelTimer('task', ${t.id})" class="glass2 border border-white/10 rounded-xl py-2 text-[12px] font-extrabold text-slate-200 active:scale-95 transition-transform">
                取消
              </button>
            </div>

            <div class="mt-2 flex items-center justify-between">
              <button onclick="resetTimer('task', ${t.id})" class="text-[11px] font-extrabold text-slate-400 active:opacity-70">重置時間</button>
              <div class="text-[10px] text-slate-500 font-extrabold">完成 +10 / 取消 -10</div>
            </div>
          </div>
        `;
      }).join("");
    }

    function renderMind(){
      if(state.ui.view !== "mind") return;
      const key = activeKey();
      const day = ensureDay(key);
      const c = computeCompletion(day);

      setText("mind-date", (key===todayKey()) ? "Today" : formatKey(key));
      setText("mind-completion", c.percent);

      setText("reading-min", day.reading.minutes);
      setText("reading-display", tickLabel(day.reading.remainingSec));
      setText("reading-done-btn", day.reading.done ? "取消完成" : "完成");
      setText("reading-start", day.reading.running ? "暫停" : "開始");
      if($("reading-display")){
        $("reading-display").classList.toggle("ringPulse", day.reading.running && !day.reading.done);
      }

      setText("devotion-min", day.devotion.minutes);
      setText("devotion-display", tickLabel(day.devotion.remainingSec));
      setText("devotion-done-btn", day.devotion.done ? "取消完成" : "完成");
      setText("devotion-start", day.devotion.running ? "暫停" : "開始");
      if($("devotion-display")){
        $("devotion-display").classList.toggle("ringPulse", day.devotion.running && !day.devotion.done);
      }

      // fill inputs (don’t fight user typing)
      const growth=$("growth-input"), brand=$("brand-input"), scripture=$("scripture-input"), spirit=$("spirit-input");
      if(growth && document.activeElement !== growth) growth.value = day.mind.growth || "";
      if(brand && document.activeElement !== brand) brand.value = day.mind.brand || "";
      if(scripture && document.activeElement !== scripture) scripture.value = day.spirit.scripture || "";
      if(spirit && document.activeElement !== spirit) spirit.value = day.spirit.note || "";

      renderMindTabs();
    }

    function renderMindTabs(){
      const tab = state.ui.mindTab || "mind";
      const mind = $("tab-mind");
      const spirit = $("tab-spirit");
      const slider = $("tab-slider");
      const btnMind = $("tab-btn-mind");
      const btnSpirit = $("tab-btn-spirit");

      const isMind = tab === "mind";
      if(mind) mind.classList.toggle("hidden", !isMind);
      if(spirit) spirit.classList.toggle("hidden", isMind);
      if(slider) slider.style.transform = isMind ? "translateX(0%)" : "translateX(100%)";
      if(btnMind) btnMind.className = "flex-1 relative z-10 py-2 text-[13px] text-center rounded-full " + (isMind ? "font-black text-white" : "font-extrabold text-slate-300");
      if(btnSpirit) btnSpirit.className = "flex-1 relative z-10 py-2 text-[13px] text-center rounded-full " + (!isMind ? "font-black text-white" : "font-extrabold text-slate-300");
    }

    function renderCalendar(){
      if(state.ui.view !== "calendar") return;

      const ym = state.ui.calYm;
      setText("cal-title", ym);

      const cells = calBuildDays(ym);
      const grid = $("cal-grid");
      if(grid){
        grid.innerHTML = cells.map(key=>{
          if(!key) return `<div class="aspect-square"></div>`;
          const day = ensureDay(key);
          const c = computeCompletion(day);
          const isToday = key===todayKey();
          const isSel = key===state.ui.selectedDate;
          const dot70 = c.perfect;
          const settled = day.settle?.settled;

          const cls = [
            "aspect-square","rounded-lg","border","border-white/10","flex","items-center","justify-center","relative","select-none",
            isSel ? "bg-white/10 border-white/25" : "bg-white/0",
            isToday ? "ring-1 ring-gold/40" : ""
          ].join(" ");

          return `
            <button onclick="setSelectedDate('${key}')" class="${cls}">
              <div class="text-[12px] font-black ${isToday?'text-gold':'text-slate-200'}">${Number(key.slice(-2))}</div>
              ${dot70 ? `<span class="absolute bottom-1 left-1 w-2 h-2 rounded-full bg-gold shadow-gold"></span>` : ""}
              ${settled ? `<span class="absolute bottom-1 right-1 w-2 h-2 rounded-full bg-violet2 shadow-glow"></span>` : ""}
            </button>
          `;
        }).join("");
      }

      const sel = state.ui.selectedDate || todayKey();
      const day = ensureDay(sel);
      const c = computeCompletion(day);

      setText("cal-selected", formatKey(sel));
      setText("cal-comp", c.percent);
      setText("cal-xp", c.xp);
      setText("cal-settled", day.settle?.settled ? "YES" : "NO");

      const summary = [
        `水分：${day.waterMl}/${day.waterGoalMl} ml`,
        `任務完成：${day.tasks.filter(t=>t.done).length}/${day.tasks.length}`,
        `排便：${day.bowelStatus}`,
        `閱讀：${day.reading.done?'完成':'未完成'}（${day.reading.minutes}m）`,
        `靈修：${day.devotion.done?'完成':'未完成'}（${day.devotion.minutes}m）`,
        `反思：${day.mind.growth.trim()? '有':'無'}`,
        `筆記：${day.mind.brand.trim()? '有':'無'}`,
        `經文：${(day.spirit.scripture.trim()||day.spirit.note.trim())? '有':'無'}`
      ];
      setText("cal-summary", summary.join(" · "));
    }

    function renderCompletionOnly(){
      const day = ensureDay(activeKey());
      const c = computeCompletion(day);
      setText("hub-completion", c.percent);
      setText("hub-body-score", c.percent);
      setWidth("hub-body-bar", `${c.percent}%`);
      setText("body-completion", c.percent);
      setText("mind-completion", c.percent);
      setText("profile-completion", `${c.percent}%`);
      setText("profile-xp-est", `${c.xp}`);
      setText("profile-streak", `${computeStreak()}`);
      setText("hub-xp-est", c.xp);
    }

    function renderTimersOnly(){
      const day = ensureDay(activeKey());
      if(state.ui.view==="body") renderBody();
      if(state.ui.view==="mind"){
        setText("reading-display", tickLabel(day.reading.remainingSec));
        setText("devotion-display", tickLabel(day.devotion.remainingSec));
      }
    }

    /***************
     * Inputs bind (once)
     ***************/
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));
    }

    let inputsBound=false;
    function bindInputsOnce(){
      if(inputsBound) return;
      inputsBound=true;

      const bind = (id, setter)=>{
        const el=$(id);
        if(!el) return;
        el.addEventListener("input", ()=>{
          const day = ensureDay(activeKey());
          setter(day, el.value);
          save();
          // show only points delta on first non-empty
          renderCompletionOnly();
        });
        el.addEventListener("blur", ()=>{
          toastMini("已保存");
        });
      };

      bind("growth-input", (day,v)=>{
        const before = day.mind.growth.trim()? POINTS.growth : 0;
        day.mind.growth = v;
        const after = day.mind.growth.trim()? POINTS.growth : 0;
        if(after!==before) popScore(after-before);
      });

      bind("brand-input", (day,v)=>{
        const before = day.mind.brand.trim()? POINTS.brand : 0;
        day.mind.brand = v;
        const after = day.mind.brand.trim()? POINTS.brand : 0;
        if(after!==before) popScore(after-before);
      });

      bind("scripture-input", (day,v)=>{
        const before = (day.spirit.scripture.trim()||day.spirit.note.trim()) ? POINTS.scripture : 0;
        day.spirit.scripture = v;
        const after = (day.spirit.scripture.trim()||day.spirit.note.trim()) ? POINTS.scripture : 0;
        if(after!==before) popScore(after-before);
      });

      bind("spirit-input", (day,v)=>{
        const before = (day.spirit.scripture.trim()||day.spirit.note.trim()) ? POINTS.scripture : 0;
        day.spirit.note = v;
        const after = (day.spirit.scripture.trim()||day.spirit.note.trim()) ? POINTS.scripture : 0;
        if(after!==before) popScore(after-before);
      });
    }

    /***************
     * Click handlers
     ***************/
    document.addEventListener("click", (e)=>{
      if(e.target?.closest("#btn-profile")){
        $("inp-name").value = state.profile.name || "";
        $("inp-avatar").value = state.profile.avatar || "";
        $("inp-title").value = state.profile.title || "";
        openModal("modal-profile");
      }
      if(e.target?.closest("#btn-reset")) confirmReset();

      if(e.target?.closest("#btn-settle")){
        const day = ensureDay(activeKey());
        const c = computeCompletion(day);

        // settle = award xp once, can re-settle (recompute delta)
        const prev = day.settle?.settled ? (day.settle.xpAwarded||0) : 0;
        const next = c.xp;

        day.settle = { settled:true, xpAwarded: next, percentAtSettle: c.percent };

        // Apply delta to profile xp
        const delta = next - prev;
        state.gamification.xp += delta;

        // Level up simple
        while(state.gamification.xp >= state.gamification.xpMax){
          state.gamification.xp -= state.gamification.xpMax;
          state.gamification.level += 1;
          state.gamification.xpMax = Math.round(state.gamification.xpMax * 1.12 + 35);
          toastMini("LEVEL UP!");
        }

        save();
        renderAll();
        popScore(delta);
        toastMini("已結算");
      }
    });

    /***************
     * Init
     ***************/
    ensureDay(todayKey());
    ensureDay(state.ui.activeDate || todayKey());
    ensureDay(state.ui.selectedDate || todayKey());
    save();
    renderAll();
    startTick();
  </script>
</body>
</html>
